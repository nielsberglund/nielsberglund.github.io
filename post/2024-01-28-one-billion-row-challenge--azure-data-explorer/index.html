<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <meta property="og:site_name" content="Niels Berglund">
    <meta property="og:type" content="article">

    
    <meta property="og:image" content="https://nielsberglund.com/images/thumbnails/posts/1brc-adx.png">
    <meta property="twitter:image" content="https://nielsberglund.com/images/thumbnails/posts/1brc-adx.png" />
    

    
    <meta name="title" content="One Billion Row Challenge &amp; Azure Data Explorer" />
    <meta property="og:title" content="One Billion Row Challenge &amp; Azure Data Explorer" />
    <meta property="twitter:title" content="One Billion Row Challenge &amp; Azure Data Explorer" />
    

    
    <meta name="description" content="Gunnar Morling initiated the One Billion Row Challenge on his blog, aiming to load and aggregate one billion rows of temperature data using Java. In this blog post, I show how I did the challenge using Azure Data Explorer. It was not without challenges (pun intended), but I got there in the end.">
    <meta property="og:description" content="Gunnar Morling initiated the One Billion Row Challenge on his blog, aiming to load and aggregate one billion rows of temperature data using Java. In this blog post, I show how I did the challenge using Azure Data Explorer. It was not without challenges (pun intended), but I got there in the end." />
    <meta property="twitter:description" content="Gunnar Morling initiated the One Billion Row Challenge on his blog, aiming to load and aggregate one billion rows of temperature data using Java. In this blog post, I show how I did the challenge using Azure Data Explorer. It was not without challenges (pun intended), but I got there in the end." />
    

    
    <meta property="twitter:card" content="summary" />
    
    

    <meta name="keyword"  content="SQL Server, .NET, Kafka, Streaming, Azure Data Explorer, AI/ML">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>One Billion Row Challenge &amp; Azure Data Explorer | Niels Berglund</title>

    <link rel="canonical" href="/post/2024-01-28-one-billion-row-challenge--azure-data-explorer/">

    
    
    
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="/css/hugo-theme-cleanwhite.min.css">

    
    <link rel="stylesheet" href="/css/zanshang.css">

    
    <link href="https://cdn.jsdelivr.net/gh/FortAwesome/Font-Awesome@5.15.1/css/all.css" rel="stylesheet" type="text/css">

    
    

    
    <script src="/js/jquery.min.js"></script>

    
    <script src="/js/bootstrap.min.js"></script>

    
    <script src="/js/hux-blog.min.js"></script>

    
    <script src="/js/lazysizes.min.js"></script>

    
    

</head>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-18914734-2', 'auto');
	
	ga('send', 'pageview');
}
</script>





<nav class="navbar navbar-default navbar-custom navbar-fixed-top">

    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Niels Berglund</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">All Posts</a>
                    </li>
                    
                    
		    
                        <li><a href="/series/">BLOG SERIES</a></li>
                    
                        <li><a href="/top/about/">ABOUT ME</a></li>
                    
                        <li><a href="/top/archive/">ARCHIVE</a></li>
                    
                        <li><a href="/top/disclaimer/">DISCLAIMER</a></li>
                    
		            <li>
                        <a href="/search"><i class="fa fa-search"></i></a>
		           </li>
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>




<style type="text/css">
    header.intro-header {
        background-image: url('/images/banner/posts/1brc-adx.png')
    }
</style>

<header class="intro-header" >

    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/azure-data-explorer" title="Azure Data Explorer">
                            Azure Data Explorer
                        </a>
                        
                        <a class="tag" href="/tags/kusto" title="Kusto">
                            Kusto
                        </a>
                        
                        <a class="tag" href="/tags/kql" title="KQL">
                            KQL
                        </a>
                        
                    </div>
                    <h1>One Billion Row Challenge &amp; Azure Data Explorer</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        
                            Posted by 
                            
                                nielsb
                             
                            on 
                            Sunday, January 28, 2024
                            
                            
                            
                            
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                
                <p>On January 1st (that&rsquo;s dedication - New Year&rsquo;s Day), 2024 <a href="https://www.linkedin.com/in/gunnar-morling-2b44b7229/">Gunnar Morling</a> published on his blog the <a href="https://www.morling.dev/blog/one-billion-row-challenge/"><em>One Billion Row Challenge</em></a>. The challenge is to load and aggregate one billion rows using Java. The challenge took on a life of its own, and there are now several implementations of the challenge in different languages, including databases (<a href="https://rmoff.net/2024/01/03/1%EF%B8%8F%E2%83%A3%EF%B8%8F-1brc-in-sql-with-duckdb/">Robin</a>, <a href="https://hubertdulay.substack.com/p/1-billion-row-challenge-in-apache">Hubert</a>, <a href="https://ftisiot.net/posts/1brows/">Francesco</a>, among others). The data to aggregate is a list of temperature readings from weather stations.</p>
<p>I thought It would be fun to do the challenge using <a href="https://docs.microsoft.com/en-us/azure/data-explorer/">Azure Data Explorer</a> (ADX) since I like ADX and have written blog posts about it. ADX is a fast, scalable, and highly available data analytics service. It is optimized for data exploration over large data volumes. ADX is a columnar store that uses a query language called <strong>Kusto Query Language</strong> (KQL). It is a fully managed service, and it is part of the Azure platform.</p>
<p>So, in this blog post, you&rsquo;ll see what I did to load and aggregate one billion rows. Spoiler alert: certain things didn&rsquo;t work out as I had hoped, but that could be due to me being more rusty with ADX than anything else.</p>
<h2 id="caveat">Caveat</h2>
<p>Before we get started a couple of caveats:</p>
<ul>
<li>I&rsquo;m not going to do a performance analysis of ADX. I&rsquo;m going to show you how I loaded and aggregated one billion rows using ADX, not comparing ADX to other databases, languages, etc.</li>
<li>As we are aggregating data, I see the workload as an analytical workload, where data would - most likely - be continuously streamed into ADX. So therefore I am not looking at the load time of the data, but rather the time it takes to aggregate it.</li>
</ul>
<p>I mentioned the above about loading the data because the original version of the challenge was the time it took to load and aggregate the data.</p>
<h2 id="pre-reqs">Pre-Reqs</h2>
<p>This section is here to list what you need if you want to follow along:</p>
<ul>
<li>An Azure account. If you don&rsquo;t have an Azure subscription, sign up for a <a href="https://azure.microsoft.com/en-us/free/">free account</a>.</li>
<li>An ADX cluster and database. To set up an ADX cluster and a database, look here: <a href="https://docs.microsoft.com/en-us/azure/data-explorer/create-cluster-database-portal">Quickstart: Create an Azure Data Explorer cluster and database</a>. You can name the database as you like. My database is called <code>sensorreadings</code>. Please note that there may be a cost associated with the ADX cluster, so be sure to tear it down when you are done.</li>
</ul>
<p>You may have seen how ADX offers <a href="https://learn.microsoft.com/en-us/azure/data-explorer/start-for-free-web-ui">free clusters</a>. A free cluster allows you to explore the platform&rsquo;s features, experiment with data analytics queries, and develop proofs of concept without incurring any cost. I tried to use a free cluster for this blog post, but I ran into a couple of issues, so I am using my &ldquo;tried and tested&rdquo; cluster from previous blog posts about ADX instead. If you follow along, you can try using a free cluster, but I cannot guarantee it will work.</p>
<p>After all this, the assumption is that you now have a running ADX cluster.</p>
<h4 id="java">Java</h4>
<p>You also need Java, and specifically Java 21. I did the challange on my Windows box so I used <a href="https://chocolatey.org/"><strong>Chocolatey</strong></a> to install Java:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ choco install openjdk --version=21.0.1
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 1:</strong> <em>Install Java</em></p>
<p>After running the code in <em>Code Snippet 1</em>, I had to &ldquo;fix up&rdquo; my <code>PATH</code> environment variable, as it was pointing to the wrong version of Java. Having fixed that and restarted my terminal, I ran  <code>java -version</code> and got the correct version. Success!</p>
<h2 id="generating-the-data">Generating the Data</h2>
<p>Where do you get the one billion rows from to load into ADX? Well, you generate it. Gunnar supplies a Java program (hence the Java requirement above) that generates the data. Fork Gunnar&rsquo;s <a href="https://github.com/gunnarmorling/1brc">repo</a> and clone it locally.</p>
<p>After having cloned the repo, you build the Java program using Maven:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ./mvnw clean verify
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 2:</strong> <em>Build the Java App</em></p>
<p>Having built the application as in <em>Code Snippet 2</em>, it is time to generate the data. Gunnar&rsquo;s Java program takes a single argument: the number of rows to generate:</p>
<p>
  <img src="/images/posts/adx-1brc-gen-data.png" alt="">

</p>
<p><strong>Figure 1:</strong> <em>Generate the Data</em></p>
<p>In <em>Figure 1</em> you see how I generated one billion rows. I did not do it as per Gunnar&rsquo;s instructions, executing a <code>.sh</code> file as I had some issues on my Windows box running the command. Instead, I directly executed the Java program the <code>.sh</code> file pointed to. The result is the same: I generated a file with one billion records.</p>
<blockquote>
<p><strong>NOTE:</strong> Be aware that the file generated will be large, around 13Gb. So make sure you have enough space on your disk.</p>
</blockquote>
<p>Generating the records took ~65 seconds on my machine (as in <em>Figure 1</em>) and created the file <code>measurements2.txt</code>. The file is created in the root folder of the cloned repo.</p>
<h4 id="the-data">The Data</h4>
<p>The data generated is the name of the weather station and the temperature reading, semi-colon delimited:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Mogadishu;29.1
</span></span><span style="display:flex;"><span>Fresno;24.1
</span></span><span style="display:flex;"><span>Dakar;18.7
</span></span><span style="display:flex;"><span>Mombasa;35.7
</span></span><span style="display:flex;"><span>Vienna;5.1
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 3:</strong> <em>Sample of the Data</em></p>
<p>You see in <em>Code Snippet 3</em> a sample of the data. The station name is a string, and the temperature is a double.</p>
<p>You should now be ready to load the data into ADX. However, the generated file is 13Gb and from a performance perspective, it is not feasible to load the file as is. So, you need to split the file into smaller files.</p>
<h2 id="split-the-data">Split the Data</h2>
<p>I use the <code>split</code> command to split the file into smaller files. However, the <code>split</code> command is a Linux command, and I am on Windows; what to do? I have two options:</p>
<ul>
<li>Use <strong>Windows Subsystem for Linux</strong> (WSL).</li>
<li>Use <strong>Git-Bash</strong>.</li>
</ul>
<p>I have both installed on my machine, and I decided to use WSL. I ran the following:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ split -l <span style="color:#2aa198;font-weight:bold">50000000</span> measurements2.txt
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 4:</strong> <em>Split the Data</em></p>
<p>The command in <em>Code Snippet 4</em> splits the file into smaller files, each containing 50 million rows.</p>
<p>
  <img src="/images/posts/adx-1brc-split-files.png" alt="">

</p>
<p><strong>Figure 2:</strong> <em>Split Files</em></p>
<p>In <em>Figure 2</em>, you see the result of running the command in <em>Code Snippet 4</em>. The files created when running the command are named <code>xaa</code>, <code>xab</code>, <code>xac</code>, etc., and are created in the same folder as the original file. As the timestamp column in <em>Figure 2</em> shows, the command took ~1 minute to run (started at 07:12 and ended at 07:13).</p>
<p>Initially, when I <del>played around with</del> investigated loading the data into ADX, I had some problems which I attributed to the files not having an extension. So, I ran a PowerShell command to add the <code>.txt</code> extension to the files:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ <span style="color:#cb4b16">Get-ChildItem</span> <span style="color:#268bd2">-exclude</span> <span style="color:#2aa198">&#39;*.doc&#39;</span>,<span style="color:#2aa198">&#39;*.txt&#39;</span> | <span style="color:#cb4b16">Where-Object</span> {!<span style="color:#268bd2">$_</span>.<span style="color:#268bd2">PsIsContainer</span>} | <span style="color:#cb4b16">Rename-Item</span> <span style="color:#268bd2">-newname</span> {<span style="color:#268bd2">$_</span>.<span style="color:#268bd2">name</span> + <span style="color:#2aa198">&#34;.txt&#34;</span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 5:</strong> <em>Add Extension to Files</em></p>
<p>After running the command in <em>Code Snippet 5</em>, the files had the <code>.txt</code> extension, and I am getting closer to loading the files.</p>
<h2 id="loading-the-data">Loading the Data</h2>
<p>A while back, I wrote a series of posts about iGaming leaderboards and ADX, <strong>Develop a Real-Time Leaderboard Using Kafka and Azure Data Explorer</strong>. In the post <a href="https://nielsberglund.com/post/2023-04-03-develop-a-real-time-leaderboard-using-kafka-and-azure-data-explorer---ii/"><strong>Develop a Real-Time Leaderboard Using Kafka and Azure Data Explorer - II</strong></a>, I discussed how to batch-ingest data from local files into ADX.</p>
<blockquote>
<p><strong>NOTE:</strong> Yeah, I know, I know - I still need to finish that series. I will, I promise. I just got sidetracked by other things.</p>
</blockquote>
<p>In the <a href="https://nielsberglund.com/post/2023-04-03-develop-a-real-time-leaderboard-using-kafka-and-azure-data-explorer---ii/">post</a> mentioned above, I used the ADX <em>Ingestion wizard</em> to ingest the data from the files into ADX. However, with the amount of data, 20 files weighing in at ~670 Mb each, I decided to use the <a href="https://learn.microsoft.com/en-us/azure/data-explorer/lightingest"><strong>LightIngest</strong></a> tool instead. LightIngest is a command-line utility for ad-hoc data ingestion into ADX. The utility can ingest data from various sources, including files from a local folder, and the <a href="https://learn.microsoft.com/en-us/azure/data-explorer/lightingest">docs</a> says: <em>&hellip;most useful when you want to ingest a large amount of data, &hellip;</em>. This led me to believe that Light Ingest would be a good fit.</p>
<p>Well, it didn&rsquo;t go to plan as I got the weirdest errors no matter what I did. I spent several hours trying to figure out what was wrong, to no avail. So, I decided to use Azure Blob Store instead. First, upload the files to the blob store, then ingest the data into ADX. I started with creating a storage account and a container in the storage account. I then uploaded the files to the container. That worked fine:</p>
<p>
  <img src="/images/posts/adx-1brc-blob-store.png" alt="">

</p>
<p><strong>Figure 3:</strong> <em>Azure Blob Store</em></p>
<p>Having the data in the blob store as in <em>Figure 3</em>, I can now ingest it into ADX. My idea was to use the same approach as in the <a href="https://nielsberglund.com/post/2023-04-03-develop-a-real-time-leaderboard-using-kafka-and-azure-data-explorer---ii/">post</a> above - using the <em>Ingestion wizard</em>. Or rather, the replacement for the <em>Ingestion wizard</em>:</p>
<p>
  <img src="/images/posts/adx-1brc-free-ui-get-data-2.png" alt="">

</p>
<p><strong>Figure 4:</strong> <em>Get Data - Select Data Source</em></p>
<p>You get to the <em>Select a data source</em> dialog in <em>Figure 4</em> by right-clicking on your database and selecting <em>Get data</em>.</p>
<p>I&rsquo;ll get to what to do to set up and ingest the data in a minute, as before you can ingest, you need to prep your database a bit.</p>
<h4 id="ingestion-mapping">Ingestion Mapping</h4>
<p>When ingesting data into ADX, you need to specify to where and how the data should be ingested:</p>
<ul>
<li>Database</li>
<li>Table</li>
<li>How the data in, in this case, file(s) should map to the table.</li>
</ul>
<p>ADX can handle different file formats, like CSV, JSON, Parquet, etc. In this case, the file is a text file, and the data is semi-colon delimited. That is a problem as ADX does not support semi-colon delimited files (at least, I have yet to find a way to ingest semi-colon delimited files directly).</p>
<blockquote>
<p><strong>NOTE:</strong> It is quite disappointing that ADX only supports comma-delimited files. I expected to be able to indicate what delimiter to use, but no.</p>
</blockquote>
<p>So, I need to ingest the data into a one-column table and then, somehow, parse the semi-colon delimited data in the table into another table. I&rsquo;ll get back to that later.</p>
<h4 id="creating-the-tables">Creating the Table(s)</h4>
<p>Let&rsquo;s create the tables first:</p>
<p>
  <img src="/images/posts/adx-1brc-create-tables.png" alt="">

</p>
<p><strong>Figure 5:</strong> <em>Create Tables</em></p>
<p>In <em>Figure 5</em>, you see how I, in my cluster&rsquo;s <em>Query</em> editor, not only created the table I will insert the data from the files but also the table the parsed data will be inserted into. The table names are <code>weatherstationreadingsraw</code> and <code>weatherstationreadings</code>. The table <code>weatherstationreadingsraw</code> is where the data from the files will be inserted, and <code>weatherstationreadings</code> is the table into which the parsed data will be inserted.</p>
<p>You also see in <em>Figure 5</em> how I, as last statement, ensure that it has worked ok by executing <code>. show tables</code>. As you see - outlined in red - all is OK.</p>
<p>Cool, so now you have the tables, and theoretically, you can now ingest the data from the files into the table <code>weatherstationreadingsraw</code>. Having ingested the data into the table <code>weatherstationreadingsraw</code>, you can then parse the data into the table <code>weatherstationreadings</code> using some smart KQL. However, there is a better way, where the ingestion from the files in the blob store and the parsing into the other table is done in one go.</p>
<h4 id="update-policy">Update Policy</h4>
<p>An ADX update policy instructs ADX to automatically ingest data into a target table whenever new data is inserted into the source table. During the ingestion into the target table, the data can be queried/manipulated. The query/manipulation of the data ingested into the source table is done using a function. The policy then links the source table, the target table, and the function.</p>
<p>Let&rsquo;s start with the function:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>// <span style="color:#859900">create</span> <span style="color:#268bd2">the</span> <span style="color:#859900">function</span> <span style="color:#268bd2">which</span> <span style="color:#268bd2">will</span> <span style="color:#268bd2">parse</span> <span style="color:#268bd2">the</span> <span style="color:#859900">data</span> <span style="color:#268bd2">coming</span> <span style="color:#859900">into</span> <span style="color:#268bd2">the</span> <span style="color:#859900">source</span> <span style="color:#859900">table</span>
</span></span><span style="display:flex;"><span>. <span style="color:#859900">create</span> <span style="color:#859900">function</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">SplitColumn</span>() { 
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">weatherstationreadingsraw</span> 
</span></span><span style="display:flex;"><span>    | <span style="color:#268bd2">parse</span> <span style="color:#268bd2">col1</span> <span style="color:#859900">with</span> <span style="color:#268bd2">name</span>:<span style="color:#268bd2">string</span> <span style="color:#2aa198">&#39;;&#39;</span> <span style="color:#268bd2">temp</span>:<span style="color:#268bd2">double</span>
</span></span><span style="display:flex;"><span>    | <span style="color:#268bd2">project</span>-<span style="color:#268bd2">away</span> <span style="color:#268bd2">col1</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 6:</strong> <em>Create Function</em></p>
<p>The function in <em>Code Snippet 6</em> uses the KQL <code>parse</code> operator to split the column <code>col1</code> into <code>name</code> and <code>temp</code> columns. It splits it based on the semi-colon <code>';'</code> in the column. The function then excludes the column <code>col1</code> from the target table using the <code>project-away</code> operator, as it is no longer needed.</p>
<p>When you have created the function, you create the update policy:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>.<span style="color:#859900">alter</span> <span style="color:#859900">table</span> <span style="color:#268bd2">weatherstationreadings</span> <span style="color:#268bd2">policy</span> <span style="color:#859900">update</span> 
</span></span><span style="display:flex;"><span>@<span style="color:#2aa198">&#39;[&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#2aa198">&#39;{ &#34;IsEnabled&#34;: true,&#39;</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#2aa198">&#39;   &#34;Source&#34;: &#34;weatherstationreadingsraw&#34;,&#39;</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#2aa198">&#39;   &#34;Query&#34;: &#34;SplitColumn()&#34;,&#39;</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#2aa198">&#39;   &#34;IsTransactional&#34;: true,&#39;</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#2aa198">&#39;   &#34;PropagateIngestionProperties&#34;: false}&#39;</span>
</span></span><span style="display:flex;"><span> <span style="color:#2aa198">&#39;]&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 7:</strong> <em>Create Update Policy</em></p>
<p>You see in <em>Code Snippet 7</em> how you create the update policy by altering the target table. The update policy instructs ADX to automatically ingest data into the target table (<code>weatherstationreadings</code>) whenever new data is inserted into the source table (<code>weatherstationreadingsraw</code>). The data is ingested using the function <code>SplitColumn()</code>. The update policy is transactional, meaning that if the ingestion into the target table fails, the data is not inserted into the source table.</p>
<blockquote>
<p><strong>NOTE:</strong> You can read more about update policies <a href="https://learn.microsoft.com/en-us/azure/data-explorer/kusto/management/update-policy">here</a>.</p>
</blockquote>
<p>Now, you are ready to ingest the data from the files into the source table.</p>
<h4 id="ingest-the-data">Ingest the Data</h4>
<p>As I mentioned before, I initially tried to ingest the data from the files being local to my computer. That didn&rsquo;t work, so I uploaded the files to Azure Blob Store and now want to ingest them from there.</p>
<p>So, as in <em>Figure 4</em> I selected <em>Azure Blob Storage</em> as the data source (after having right-clicked on the database and selected <em>Get data</em>). I then choose the table I want to insert the data into:</p>
<p>
  <img src="/images/posts/adx-1brc-configure-source-1.png" alt="">

</p>
<p><strong>Figure 6:</strong> <em>Configure Source</em></p>
<p>After choosing the <code>weatherstationreadingsraw</code> table to ingest the data into I configure the data source as in <em>Figure 6</em>. You see how I have chosen to add the data from a URI (outlined in yellow) and added my blob store&rsquo;s container URI (highlighted in red). Having entered the URI, I click on the plus sign and then <em>Next</em>:</p>
<p>
  <img src="/images/posts/adx-1brc-inspect-data-1.png" alt="">

</p>
<p><strong>Figure 7:</strong> <em>Inspect Data</em></p>
<p>When clicking <em>Next</em> in the <em>Configure Source</em> dialog, I get to the <em>Inspect the data</em> dialog in <em>Figure 7</em>. The dialog chooses one file in the container as the schema definition file and you see in the figure that it is the file <code>xaa.txt</code>. The dialog correctly picks up the file format as <code>TXT</code>. However, as ADX doesn&rsquo;t understand other delimiters than commas, it gets confused and believes the file contains two columns, <code>col1</code> and <code>data</code>. This means I have to click <em>Edit columns</em>:</p>
<p>
  <img src="/images/posts/adx-1brc-edit-columns-1.png" alt="">

</p>
<p><strong>Figure 8:</strong> <em>Edit Columns</em></p>
<p>You see in <em>Figure 8</em> the <em>Edit columns</em> dialog. The dialog correctly shows the first column (<code>col1</code>), but I must delete the second column outlined in blue. I delete the column by clicking on the &ldquo;trash can&rdquo; icon outlined in red, and then I click <em>Next</em>:</p>
<p>
  <img src="/images/posts/adx-1brc-free-ui-get-data-8.png" alt="">

</p>
<p><strong>Figure 9:</strong> <em>Get Data Summary</em></p>
<p>In <em>Figure 9</em> you see the <em>Summary</em> dialog. The dialog has two parts: the <em>Data preparation</em> (partially hidden in <em>Figure 9</em>) and the <em>Blob name</em>. In the <em>Data preparation</em>, you see the commands created for ingesting the data. In the <em>Blob name</em> you see the names of the individual blobs and their ingestion status. Running the ingestion will take a while, so if you do it, I suggest you take a break and go for a walk or something.</p>
<blockquote>
<p><strong>NOTE:</strong> Another slight disappointment is how long the ingestion took. It took well over an hour to ingest the data. I would have expected it to be faster.</p>
</blockquote>
<p>Eventually, all the blobs will be ingested, and you will see a status of <em>Successfully ingested</em> for all blobs, and at the top of the <em>Summary</em> dialog, you see:</p>
<p>
  <img src="/images/posts/adx-1brc-ingestion-complete.png" alt="">

</p>
<p><strong>Figure 10:</strong> <em>Ingestion Complete</em></p>
<p>As you see in <em>Figure 10</em>, outlined in red, 20 blobs were targeted for ingestion and 20 blobs were successfully ingested. Yay!</p>
<p>To further confirm things are good, you can execute the following query:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#268bd2">weatherstationreadings</span> 
</span></span><span style="display:flex;"><span>| <span style="color:#859900">count</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 8:</strong> <em>Count Rows</em></p>
<p>The query in <em>Code Snippet 8</em> counts the number of rows in the table <code>weatherstationreadings</code>. You should see a result of 1,000,000,000 rows!</p>
<h2 id="aggregating-the-data">Aggregating the Data</h2>
<p>Now that you have the data in the table <code>weatherstationreadings, </code> it is time to aggregate it according to the challenge. The challenge is aggregating the data by station and calculating each station&rsquo;s average, minimum and maximum temperature.</p>
<p>When you aggregate data in ADX, you use KQL&rsquo;s <code>summarize</code> operator:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#268bd2">T</span>
</span></span><span style="display:flex;"><span>| <span style="color:#268bd2">summarize</span> <span style="color:#268bd2">output_column</span> = <span style="color:#268bd2">aggregation_function</span>(<span style="color:#268bd2">input_column</span>) <span style="color:#859900">by</span> <span style="color:#268bd2">grouping_column</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 9:</strong> <em>Summarize</em></p>
<p>In <em>Code Snippet 9</em>, you see the syntax for the <code>summarize</code> operator. The operator takes an input column from the table <code>T</code> and an aggregation function and groups the data by one or more grouping columns. The aggregation result is a new column(s), which can be named (<code>output_column</code>). If not named, the column(s) will be named after the aggregation function plus the source column name (<code>aggregation_function_input_column</code>).</p>
<p>So, to aggregate the data in the table <code>weatherstationreadings</code> you use the following query:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#268bd2">weatherstationreadings</span>
</span></span><span style="display:flex;"><span>| <span style="color:#268bd2">summarize</span> <span style="color:#268bd2">min_temp</span> = <span style="color:#859900">min</span>(<span style="color:#268bd2">temperature</span>), 
</span></span><span style="display:flex;"><span>            <span style="color:#268bd2">avg_temp</span> = <span style="color:#859900">avg</span>(<span style="color:#268bd2">temperature</span>), 
</span></span><span style="display:flex;"><span>            <span style="color:#268bd2">max_temp</span> = <span style="color:#859900">max</span>(<span style="color:#268bd2">temperature</span>) <span style="color:#859900">by</span> <span style="color:#268bd2">name</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 10:</strong> <em>Aggregate Data</em></p>
<p>The query in <em>Code Snippet 10</em> aggregates the data in the table <code>weatherstationreadings</code> by station name. The aggregation functions used are <code>min</code>, <code>avg</code> and <code>max</code>; the result is three columns: <code>min_temp</code>, <code>avg_temp</code> and <code>max_temp</code>, plus the <code>name</code> column.</p>
<p>When executing the query in <em>Code Snippet 9</em>, you should see a result similar to the following:</p>
<p>
  <img src="/images/posts/adx-1brc-aggregate-data.png" alt="">

</p>
<p><strong>Figure 11:</strong> <em>Aggregate Data</em></p>
<p>There are a couple of things to note in <em>Figure 11</em>:</p>
<ul>
<li>The query took ~8.1 seconds to execute (outlined in red). Good for aggregating one billion rows.</li>
<li>You can get a more detailed view of the stats of the query by clicking on the <em>Stats</em> button (outlined in blue).</li>
<li>The values in the <code>mean_temp</code> column have a lot of decimals (outlined in yellow).</li>
<li>The result is not ordered by station name.</li>
</ul>
<p>Let&rsquo;s try to fix the last two points:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#268bd2">weatherstationreadings</span>
</span></span><span style="display:flex;"><span>| <span style="color:#268bd2">summarize</span> <span style="color:#268bd2">min_temp</span> = <span style="color:#268bd2">round</span>(<span style="color:#859900">min</span>(<span style="color:#268bd2">temperature</span>), <span style="color:#2aa198;font-weight:bold">1</span>), 
</span></span><span style="display:flex;"><span>            <span style="color:#268bd2">avg_temp</span> = <span style="color:#268bd2">round</span>(<span style="color:#859900">avg</span>(<span style="color:#268bd2">temperature</span>), <span style="color:#2aa198;font-weight:bold">1</span>), 
</span></span><span style="display:flex;"><span>            <span style="color:#268bd2">max_temp</span> = <span style="color:#268bd2">round</span>(<span style="color:#859900">max</span>(<span style="color:#268bd2">temperature</span>), <span style="color:#2aa198;font-weight:bold">1</span>) <span style="color:#859900">by</span> <span style="color:#268bd2">name</span>
</span></span><span style="display:flex;"><span>| <span style="color:#859900">order</span> <span style="color:#859900">by</span> <span style="color:#268bd2">name</span> <span style="color:#859900">asc</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 11:</strong> <em>Aggregate Data - Round and Order</em></p>
<p>In <em>Code Snippet 11</em>, you see how I use the <code>round()</code> operator to round the columns to one decimal and order the result by station name. The result of executing the query in <em>Code Snippet 11</em> is:</p>
<p>
  <img src="/images/posts/adx-1brc-aggregate-data-2.png" alt="">

</p>
<p><strong>Figure 12:</strong> <em>Aggregate Data - Round and Order</em></p>
<p>In <em>Figure 12</em>, you see the result of executing the query in <em>Code Snippet 11</em>. The <code>avg_temp</code> column now has one decimal, and the result is ordered by station name. The query took ~8.7 seconds to execute (outlined in red). This is a smidge longer than the previous query, but not by much.</p>
<p>What is interesting if you look at <em>Figure 12</em> is that I did the <code>round()</code> operation against the <code>min_temp</code> column, and I would expect to see the likes of 8.0, 16.0, etc., where the result has no fractional value. As you can see, that is not the case. I tried all sorts of things, casting to double, etc., but no luck. The one thing that worked was to cast the column to a string: <code>min_temp = tostring(round(min(temperature), 1)),</code>. However, that feels ugly. If a numeric value decimal, etc., has no fractional part, you can&rsquo;t show with a 0 as the fractional part unless you cast it to a string. If you know of a better way, please let me know.</p>
<h4 id="formatting-the-result">Formatting the Result</h4>
<p>The challenge added a further &ldquo;twist&rdquo;. The aggregation result should be output as a string in a specific format: station name=min/mean/max, name=min/mean/max, etc. Something like so:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#2aa198">&#34;{Mogadishu=29.1/29.1/29.1, Fresno=24.1/24.1/24.1, Dakar=18.7/18.7/18.7, Mombasa=35.7/35.7/35.7, Vienna=5.1/5.1/5.1, ...}&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 12:</strong> <em>Formatted Result - I</em></p>
<p>To achieve the desired result as in <em>Code Snippet 12</em>, I use a couple of cool KQL operators:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#268bd2">let</span> <span style="color:#268bd2">T</span> = 
</span></span><span style="display:flex;"><span><span style="color:#268bd2">weatherstationreadings</span>
</span></span><span style="display:flex;"><span>| <span style="color:#268bd2">summarize</span> <span style="color:#268bd2">min_temp</span> = <span style="color:#268bd2">tostring</span>(<span style="color:#268bd2">round</span>(<span style="color:#859900">min</span>(<span style="color:#268bd2">temperature</span>), <span style="color:#2aa198;font-weight:bold">1</span>)), 
</span></span><span style="display:flex;"><span>            <span style="color:#268bd2">avg_temp</span> = <span style="color:#268bd2">round</span>(<span style="color:#859900">avg</span>(<span style="color:#268bd2">temperature</span>), <span style="color:#2aa198;font-weight:bold">1</span>), 
</span></span><span style="display:flex;"><span>            <span style="color:#268bd2">max_temp</span> = <span style="color:#859900">max</span>(<span style="color:#268bd2">temperature</span>) <span style="color:#859900">by</span> <span style="color:#268bd2">name</span>
</span></span><span style="display:flex;"><span>| <span style="color:#859900">order</span> <span style="color:#859900">by</span> <span style="color:#268bd2">name</span> <span style="color:#859900">asc</span>;
</span></span><span style="display:flex;"><span><span style="color:#268bd2">T</span>
</span></span><span style="display:flex;"><span>| <span style="color:#268bd2">summarize</span> <span style="color:#859900">result</span> = <span style="color:#268bd2">make_list</span>(<span style="color:#268bd2">strcat</span>(<span style="color:#268bd2">name</span>, <span style="color:#2aa198">&#39;=&#39;</span>, <span style="color:#268bd2">min_temp</span>, <span style="color:#2aa198">&#39;/&#39;</span>, <span style="color:#268bd2">avg_temp</span>, <span style="color:#2aa198">&#39;/&#39;</span>, <span style="color:#268bd2">max_temp</span>))
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 13:</strong> <em>Format the Result - I</em></p>
<p>You see in <em>Code Snippet 13</em> how I started by using the <code>let</code> statement to create a CTE/temporary table <code>T</code> containing the aggregated data. I use <code>T</code> to concatenate the columns <code>name</code>, <code>min_temp</code>, <code>avg_temp</code> and <code>max_temp</code> into a string using the <code>strcat()</code> operator. Having each row concatenated, I finally apply the <code>make_list()</code> function, which creates a dynamic array.</p>
<p>That worked fine, but I wanted to know whether I could do it in one go. It turns out I could:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#268bd2">weatherstationreadings</span>
</span></span><span style="display:flex;"><span>| <span style="color:#268bd2">summarize</span> <span style="color:#268bd2">min_temp</span> = <span style="color:#268bd2">tostring</span>(<span style="color:#268bd2">round</span>(<span style="color:#859900">min</span>(<span style="color:#268bd2">temperature</span>), <span style="color:#2aa198;font-weight:bold">1</span>)), 
</span></span><span style="display:flex;"><span>            <span style="color:#268bd2">avg_temp</span> = <span style="color:#268bd2">round</span>(<span style="color:#859900">avg</span>(<span style="color:#268bd2">temperature</span>), <span style="color:#2aa198;font-weight:bold">1</span>), 
</span></span><span style="display:flex;"><span>            <span style="color:#268bd2">max_temp</span> = <span style="color:#859900">max</span>(<span style="color:#268bd2">temperature</span>) <span style="color:#859900">by</span> <span style="color:#268bd2">name</span>
</span></span><span style="display:flex;"><span>| <span style="color:#859900">order</span> <span style="color:#859900">by</span> <span style="color:#268bd2">name</span> <span style="color:#859900">asc</span>            
</span></span><span style="display:flex;"><span>| <span style="color:#268bd2">summarize</span> <span style="color:#859900">result</span> = <span style="color:#268bd2">make_list</span>(<span style="color:#268bd2">strcat</span>(<span style="color:#268bd2">name</span>, <span style="color:#2aa198">&#39;=&#39;</span>, <span style="color:#268bd2">min_temp</span>, <span style="color:#2aa198">&#39;/&#39;</span>, <span style="color:#268bd2">avg_temp</span>, <span style="color:#2aa198">&#39;/&#39;</span>, <span style="color:#268bd2">max_temp</span>))
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 14:</strong> <em>Format the Result - II</em></p>
<p>Pretty cool how I can have multiple <code>summarize</code> operators in a query. The result of executing the query in <em>Code Snippet 14</em> is:</p>
<p>
  <img src="/images/posts/adx-1brc-aggregate-data-3.png" alt="">

</p>
<p><strong>Figure 13:</strong> <em>Final Result</em></p>
<p>As you see in <em>Figure 13</em>, the result pretty much looks as it should. Awesome!!</p>
<h2 id="summary">Summary</h2>
<p>In this post, you have seen how I loaded one billion rows into ADX. I did it by uploading the data to Azure Blob Store and then ingesting it from there.</p>
<p>Having the data in Azure Blob Store, I used ADX&rsquo;s built-in functionality to ingest data from the source. Since ADX does not understand semi-colon as a delimiter I had to ingest the data into a one-column table and then parse the data into another table. I did that by using an update policy.</p>
<p>I then aggregated the data using the <code>summarize</code> operator and respective aggregation functions. Finally, I formatted the result using multiple <code>summarize</code> and the <code>make_list()</code> function.</p>
<h4 id="disappointments">Disappointments</h4>
<p>As much as I like ADX and KQL, there were a couple of things that disappointed me:</p>
<ul>
<li>LightIngest did not work as expected (this could have been a me thing). It seemed to be due to the number of files and their size, but as I said, I could be doing something stupid.</li>
<li>The ingestion of the data took a long time. I would have expected it to be faster.</li>
<li>It looks like ADX doesn&rsquo;t support any delimiters other than commas. I expected to be able to indicate what delimiter to use, but no.</li>
<li>It seems that if a decimal value has no fractional part, you can&rsquo;t show with a 0 as the fractional part, unless you cast it to a string.</li>
</ul>
<h4 id="cool-things">Cool Things</h4>
<p>There were also a couple of cool things:</p>
<ul>
<li>KQL&rsquo;s built-in functions to do &ldquo;stuff&rdquo; with the data, like <code>make_list()</code>, <code>parse</code> etc.</li>
<li>The ability to have multiple <code>summarize</code> operators in a query. That is uber cool!</li>
</ul>
<h2 id="-finally">~ Finally</h2>
<p>If you have comments, questions etc., please comment on this post or [ping][ma] me.</p>

                

                
                <hr>
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/post/2024-01-28-interesting-stuff---week-04-2024/" data-toggle="tooltip" data-placement="top" title="Interesting Stuff - Week 04, 2024">&larr;
                            Previous Post</a>
                    </li>
                    
                    
                </ul>
                

                


<div id="disqus-comment"></div>
<div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "manageddata" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>



            </div>

            
            
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
            

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                
                

                
                
            </div>
        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">                  
                    
                    <li>
                        <a href="mailto:niels.it.berglund@gmail.com">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		           
                    
                    <li>
                        <a href="https://twitter.com/nielsberglund">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    

		            
                    
                    
                    <li>
                        <a target="_blank" href="https://github.com/nielsberglund">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		            
                    
                    
                    
                    <li>
                        <a target="_blank" href="https://www.linkedin.com/in/niels-berglund-0122593">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		           
                    
                    <li>
                        <a target="_blank" href="https://medium.com/@nielsberglund">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-medium fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a target="_blank" href="https://stackoverflow.com/users/7656880/niels-berglund">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-stack-overflow fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    
                    <li>
                        <a target="_blank" href="https://fosstodon.org/@nielsb">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-mastodon fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
            
            
            
           
           <li>
             <a target="_blank" href="https://nielsberglund.com/index.xml">
                <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
                </span>
             </a>
           </li>
           
             </ul>
		<p class="copyright text-muted">
                    Copyright &copy; Niels Berglund 2024
                    <br>
                    <a href="https://themes.gohugo.io/hugo-theme-cleanwhite">CleanWhite Hugo Theme</a> by <a href="https://zhaohuabing.com">Huabing</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>




<script>
    function loadAsync(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        loadAsync("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>






<script type="text/javascript">
    function generateCatalog(selector) {

        
        
        
        
            _containerSelector = 'div.post-container'
        

        
        var P = $(_containerSelector), a, n, t, l, i, c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        
        $(selector).html('')

        
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#" + $(this).prop('id');
            t = $(this).text();
            c = $('<a href="' + i + '" rel="nofollow">' + t + '</a>');
            l = $('<li class="' + n + '_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    
    $(".catalog-toggle").click((function (e) {
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    


    loadAsync("\/js\/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>






</body>
</html>
