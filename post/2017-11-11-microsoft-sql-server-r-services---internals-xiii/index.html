<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <meta property="og:site_name" content="Niels Berglund">
    <meta property="og:type" content="article">

    
    <meta property="og:image" content="https://nielsberglund.com/images/banner/main-banner-2.jpg">
    <meta property="twitter:image" content="https://nielsberglund.com/images/banner/main-banner-2.jpg" />
    

    
    <meta name="title" content="Microsoft SQL Server R Services - Internals XIII" />
    <meta property="og:title" content="Microsoft SQL Server R Services - Internals XIII" />
    <meta property="twitter:title" content="Microsoft SQL Server R Services - Internals XIII" />
    

    
    <meta name="description" content="When is SQL statements executed when executing external scripts?">
    <meta property="og:description" content="When is SQL statements executed when executing external scripts?" />
    <meta property="twitter:description" content="When is SQL statements executed when executing external scripts?" />
    

    
    <meta property="twitter:card" content="summary" />
    
    

    <meta name="keyword"  content="SQL Server, .NET, Kafka, Streaming, Azure Data Explorer, AI/ML">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>Microsoft SQL Server R Services - Internals XIII | Niels Berglund</title>

    <link rel="canonical" href="/post/2017-11-11-microsoft-sql-server-r-services---internals-xiii/">

    
    
    
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="/css/hugo-theme-cleanwhite.min.css">

    
    <link rel="stylesheet" href="/css/zanshang.css">

    
    <link href="https://cdn.jsdelivr.net/gh/FortAwesome/Font-Awesome@5.15.1/css/all.css" rel="stylesheet" type="text/css">

    
    

    
    <script src="/js/jquery.min.js"></script>

    
    <script src="/js/bootstrap.min.js"></script>

    
    <script src="/js/hux-blog.min.js"></script>

    
    <script src="/js/lazysizes.min.js"></script>

    
    

</head>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-18914734-2', 'auto');
	
	ga('send', 'pageview');
}
</script>





<nav class="navbar navbar-default navbar-custom navbar-fixed-top">

    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Niels Berglund</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">All Posts</a>
                    </li>
                    
                    
		    
                        <li><a href="/series/">BLOG SERIES</a></li>
                    
                        <li><a href="/top/about/">ABOUT ME</a></li>
                    
                        <li><a href="/top/archive/">ARCHIVE</a></li>
                    
                        <li><a href="/top/disclaimer/">DISCLAIMER</a></li>
                    
		            <li>
                        <a href="/search"><i class="fa fa-search"></i></a>
		           </li>
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>




<style type="text/css">
    header.intro-header {
        background-image: url('/images/banner/main-banner-2.jpg')
    }
</style>

<header class="intro-header" >

    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/sql-server-r-services" title="SQL Server R Services">
                            SQL Server R Services
                        </a>
                        
                        <a class="tag" href="/tags/sql-server-machine-learning-services" title="SQL Server Machine Learning Services">
                            SQL Server Machine Learning Services
                        </a>
                        
                        <a class="tag" href="/tags/r" title="R">
                            R
                        </a>
                        
                        <a class="tag" href="/tags/windbg" title="WinDbg">
                            WinDbg
                        </a>
                        
                        <a class="tag" href="/tags/launchpad" title="Launchpad">
                            Launchpad
                        </a>
                        
                        <a class="tag" href="/tags/rterm.exe" title="RTerm.exe">
                            RTerm.exe
                        </a>
                        
                        <a class="tag" href="/tags/sqlsatellite" title="SqlSatellite">
                            SqlSatellite
                        </a>
                        
                        <a class="tag" href="/tags/sqlsatellite.dll" title="SqlSatellite.dll">
                            SqlSatellite.dll
                        </a>
                        
                    </div>
                    <h1>Microsoft SQL Server R Services - Internals XIII</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        
                            Posted by 
                            
                                nielsb
                             
                            on 
                            Saturday, November 11, 2017
                            
                            
                            
                            
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                
                <p>This is the fourteenth post in a series about <strong>Microsoft SQL Server R Services</strong>, and the thirteenth post that drills down into the internal of how it works. To see other posts (including this) in the series, go to <a href="/sql_server_2k16_r_services"><strong>SQL Server R Services</strong></a>.</p>
<p>Sorry guys, in my last post <a href="/post/2017-10-31-microsoft-sql-server-r-services---internals-xii/">Internals - XII</a> I said we&rsquo;d - in this post - look into the <strong>Binary eXchange Language</strong> protocol(<strong>BXL</strong>) which is used when sending data from SQL Server to the SqlSatellite. The protocol is also involved when we send  one row of data containing 5 integers, and the packet size for that ends up being 6300 bytes.</p>
<p>Well, we won&rsquo;t look at that in this post, I was once again led astray when researching how data is sent.</p>
<p>What we will look into however is something we haven&rsquo;t really discussed at all before, and that is: when is the <code>SELECT</code> statement for the <code>@input_data_1</code> parameter executed?</p>
<p>However, before we get into all this, let us do a recap.</p>
<h2 id="recap">Recap</h2>
<p>In he last two &ldquo;episodes&rdquo; in the internals we have looked what packets are being sent between SQL server and the SqlSatellite. In <a href="/post/2017-10-20-microsoft-sql-server-r-services---internals-xi/">Internals - XI</a> we looked at how SQL Server connected to the launchpad process, and how that caused the SqlSatellite to open a socket connection to SqlServer. Connection of the socket caused two authentication packages to be sent to the SqlSatellite from SQL Server. The process was illustrated as in this figure:</p>
<p>
  <img src="/images/posts/sql_r_services_11_calls.png" alt="">

</p>
<p><strong>Figure 1:</strong> <em>Flow in SQL Server</em></p>
<p>The numbered arrows shows the communication out from SQL Server, and in what order it happens:</p>
<ol>
<li><code>sqllang!CSQLSatelliteConnection::OpenNpConnection</code> - SQL Server opens named pipe connection to the launchpad service.</li>
<li><code>sqllang!CSQLSatelliteConnection::WriteMessage</code> - Message sent to the launchpad service.</li>
<li>After the call above, the SqlSatellite opens a TCP/IP connection to SQL Server.</li>
<li>During <code>sqllang!CSQLSatelliteConnection::AuthenticateConnection</code> SQL Server sends the first packet to the SQL Satellite. The packet has something to do with authentication.</li>
<li>After the first packet is sent, a second packet (still within <code>sqllang!CSQLSatelliteConnection::AuthenticateConnection</code>), which also is related to authentication, is sent on a separate thread to SqlSatellite.</li>
</ol>
<p>In essence, <a href="/post/2017-10-20-microsoft-sql-server-r-services---internals-xi/">Internals - XI</a> was all about connection and authentication. In [Internals - XII] we looked at what data packages were sent to the SqlSatellite from SQL Server, and we saw how both script as well as any result for <code>@input_data_1</code> was sent. We used following figure to illustrate how the data was sent, and from what routines:</p>
<p>
  <img src="/images/posts/sql_r_services_12_calls.png" alt="">

</p>
<p><strong>Figure 2:</strong> <em>Flow 2 in SQL Server</em></p>
<p>The numbered arrows shows the communication out from SQL Server, and in what order it happens:</p>
<ol>
<li>SQL Server opens named pipe connection to the launchpad service.</li>
<li>Message sent to the launchpad service.</li>
<li>After the call above, the SqlSatellite opens a TCP/IP connection to SQL Server.</li>
<li>SQL Server sends the first packet to the SQL Satellite for authentication purposes.</li>
<li>A second authentication packet is sent to SqlSatellite.</li>
<li>The script is sent from inside <code>sqllang!CSatelliteProxy::PostSetupMessage</code></li>
<li>The data for <code>@input_data_1</code> is sent.</li>
<li>The first end packet is sent.</li>
<li>The second end packet is sent.</li>
</ol>
<h2 id="helper-tools">Helper Tools</h2>
<p>To help us figure out the things we want, we will use <em>WinDbg</em> and <em>Process Monitor</em>:</p>
<ul>
<li><em>Process Monitor</em>, will be used it to filter TCP traffic. If you want to refresh your memory about how to do it, we covered that in <a href="/post/2017-08-29-microsoft-sql-server-r-services---internals-x/">Internals - X</a>.</li>
<li>In <a href="/post/2017-10-31-microsoft-sql-server-r-services---internals-xii/">Internals - XII</a> I mentioned about the new and more modern <a href="https://www.microsoft.com/en-us/store/p/windbg/9pgjgd53tn86">WinDbg</a>, and how I&rsquo;d be using it going forward. Well, when writing this post I came across a scenario where I couldn&rsquo;t do what I wanted to do in the new <em>WinDbg</em>, so in this post I&rsquo;ll be using only the old version. If you need help with setting it up, that is covered in <a href="/post/2017-03-18-microsoft-sql-server-r-services---internals-i/">Internals - I</a>.</li>
</ul>
<blockquote>
<p><strong>NOTE:</strong> What I wanted to do in the new <em>WinDbg</em> was to set event filters. For the life of me I could not find out where and how to do it.</p>
</blockquote>
<h2 id="code">Code</h2>
<p>In most of the other posts in this series, the code we have executed haven&rsquo;t required a specific database or tables. In this post we&rsquo;ll use a specific database with some tables. The code to create the database, tables and populate data looks like this:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#268bd2">USE</span> <span style="color:#268bd2">master</span>;
</span></span><span style="display:flex;"><span><span style="color:#859900">GO</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#859900">SET</span> <span style="color:#268bd2">NOCOUNT</span> <span style="color:#859900">ON</span>;
</span></span><span style="display:flex;"><span><span style="color:#859900">GO</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#859900">DROP</span> <span style="color:#859900">DATABASE</span> <span style="color:#859900">IF</span> <span style="color:#859900">EXISTS</span> <span style="color:#268bd2">ResultData</span>;
</span></span><span style="display:flex;"><span><span style="color:#859900">GO</span>
</span></span><span style="display:flex;"><span><span style="color:#859900">CREATE</span> <span style="color:#859900">DATABASE</span> <span style="color:#268bd2">ResultData</span>;
</span></span><span style="display:flex;"><span><span style="color:#859900">GO</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">USE</span> <span style="color:#268bd2">ResultData</span>;
</span></span><span style="display:flex;"><span><span style="color:#859900">GO</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#859900">DROP</span> <span style="color:#859900">TABLE</span> <span style="color:#859900">IF</span> <span style="color:#859900">EXISTS</span> <span style="color:#268bd2">dbo</span>.<span style="color:#268bd2">tb_Tab1</span>;
</span></span><span style="display:flex;"><span><span style="color:#859900">CREATE</span> <span style="color:#859900">TABLE</span> <span style="color:#268bd2">dbo</span>.<span style="color:#268bd2">tb_Tab1</span>(<span style="color:#268bd2">RowID</span> <span style="color:#cb4b16">bigint</span> <span style="color:#859900">identity</span> <span style="color:#859900">primary</span> <span style="color:#859900">key</span>,
</span></span><span style="display:flex;"><span>                         <span style="color:#268bd2">ColInt</span> <span style="color:#cb4b16">int</span> <span style="color:#859900">NOT</span> <span style="color:#859900">NULL</span>,
</span></span><span style="display:flex;"><span>             <span style="color:#268bd2">ColIntN</span> <span style="color:#cb4b16">int</span> <span style="color:#859900">NULL</span>,
</span></span><span style="display:flex;"><span>             <span style="color:#268bd2">ColBigInt</span> <span style="color:#cb4b16">bigint</span> <span style="color:#859900">NOT</span> <span style="color:#859900">NULL</span>,
</span></span><span style="display:flex;"><span>             <span style="color:#268bd2">ColBigIntN</span> <span style="color:#cb4b16">bigint</span> <span style="color:#859900">NULL</span>,
</span></span><span style="display:flex;"><span>             <span style="color:#268bd2">ColDec</span> <span style="color:#cb4b16">decimal</span>(<span style="color:#2aa198;font-weight:bold">10</span>, <span style="color:#2aa198;font-weight:bold">6</span>) <span style="color:#859900">NOT</span> <span style="color:#859900">NULL</span>,
</span></span><span style="display:flex;"><span>             <span style="color:#268bd2">ColDecN</span> <span style="color:#cb4b16">decimal</span>(<span style="color:#2aa198;font-weight:bold">10</span>, <span style="color:#2aa198;font-weight:bold">6</span>) <span style="color:#859900">NULL</span>,
</span></span><span style="display:flex;"><span>             <span style="color:#268bd2">ColString</span> <span style="color:#cb4b16">varchar</span>(<span style="color:#2aa198;font-weight:bold">50</span>) <span style="color:#859900">NOT</span> <span style="color:#859900">NULL</span>,
</span></span><span style="display:flex;"><span>             <span style="color:#268bd2">ColStringN</span> <span style="color:#cb4b16">varchar</span>(<span style="color:#2aa198;font-weight:bold">50</span>) <span style="color:#859900">NULL</span>,
</span></span><span style="display:flex;"><span>             <span style="color:#268bd2">ColNString</span> <span style="color:#268bd2">nvarchar</span>(<span style="color:#2aa198;font-weight:bold">50</span>) <span style="color:#859900">NOT</span> <span style="color:#859900">NULL</span>,
</span></span><span style="display:flex;"><span>             <span style="color:#268bd2">ColNStringN</span> <span style="color:#268bd2">nvarchar</span>(<span style="color:#2aa198;font-weight:bold">50</span>) <span style="color:#859900">NULL</span>,
</span></span><span style="display:flex;"><span>             <span style="color:#268bd2">ColStringMax</span> <span style="color:#cb4b16">varchar</span>(<span style="color:#859900">max</span>) <span style="color:#859900">NOT</span> <span style="color:#859900">NULL</span>,
</span></span><span style="display:flex;"><span>             <span style="color:#268bd2">ColStringMaxN</span> <span style="color:#cb4b16">varchar</span>(<span style="color:#859900">max</span>) <span style="color:#859900">NULL</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#859900">INSERT</span> <span style="color:#859900">INTO</span> <span style="color:#268bd2">dbo</span>.<span style="color:#268bd2">tb_Tab1</span>(<span style="color:#268bd2">ColInt</span>, <span style="color:#268bd2">ColIntN</span>, <span style="color:#268bd2">ColBigInt</span>, <span style="color:#268bd2">ColBigIntN</span>,  
</span></span><span style="display:flex;"><span>                        <span style="color:#268bd2">ColDec</span>, <span style="color:#268bd2">ColDecN</span>, <span style="color:#268bd2">ColString</span>, <span style="color:#268bd2">ColStringN</span>, 
</span></span><span style="display:flex;"><span>                        <span style="color:#268bd2">ColNString</span>, <span style="color:#268bd2">ColNStringN</span>, <span style="color:#268bd2">ColStringMax</span>, 
</span></span><span style="display:flex;"><span>                        <span style="color:#268bd2">ColStringMaxN</span>)
</span></span><span style="display:flex;"><span><span style="color:#859900">VALUES</span> (<span style="color:#2aa198;font-weight:bold">41</span>, <span style="color:#2aa198;font-weight:bold">41</span>, <span style="color:#2aa198;font-weight:bold">3147483647</span>, <span style="color:#2aa198;font-weight:bold">3147483647</span>, <span style="color:#2aa198;font-weight:bold">134</span>.<span style="color:#2aa198;font-weight:bold">56789</span>, <span style="color:#2aa198;font-weight:bold">134</span>.<span style="color:#2aa198;font-weight:bold">56789</span>, <span style="color:#2aa198">&#39;Hello 41&#39;</span>, 
</span></span><span style="display:flex;"><span>        <span style="color:#2aa198">&#39;Hello 41&#39;</span>, <span style="color:#268bd2">N</span><span style="color:#2aa198">&#39;Hello 41&#39;</span>, <span style="color:#268bd2">N</span><span style="color:#2aa198">&#39;Hello 41&#39;</span>, <span style="color:#859900">CAST</span>(<span style="color:#268bd2">REPLICATE</span>(
</span></span><span style="display:flex;"><span>           <span style="color:#859900">CAST</span>(<span style="color:#2aa198">&#39;Loads of data &#39;</span> <span style="color:#859900">as</span> <span style="color:#cb4b16">varchar</span>(<span style="color:#859900">max</span>)),<span style="color:#2aa198;font-weight:bold">1000</span>) <span style="color:#859900">AS</span> <span style="color:#cb4b16">varchar</span>(<span style="color:#859900">max</span>)), 
</span></span><span style="display:flex;"><span>        <span style="color:#859900">CAST</span>(<span style="color:#268bd2">REPLICATE</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#859900">CAST</span>(<span style="color:#2aa198">&#39;Loads of data &#39;</span> <span style="color:#859900">as</span> <span style="color:#cb4b16">varchar</span>(<span style="color:#859900">max</span>)),<span style="color:#2aa198;font-weight:bold">1000</span>) <span style="color:#859900">AS</span> <span style="color:#cb4b16">varchar</span>(<span style="color:#859900">max</span>))), 
</span></span><span style="display:flex;"><span>       (<span style="color:#2aa198;font-weight:bold">42</span>, <span style="color:#859900">NULL</span>, <span style="color:#2aa198;font-weight:bold">4147483647</span>, <span style="color:#859900">NULL</span>, <span style="color:#2aa198;font-weight:bold">135</span>.<span style="color:#2aa198;font-weight:bold">56789</span>, <span style="color:#859900">NULL</span>,  <span style="color:#2aa198">&#39;Hello 42&#39;</span>, <span style="color:#859900">NULL</span>, 
</span></span><span style="display:flex;"><span>       <span style="color:#268bd2">N</span><span style="color:#2aa198">&#39;Hello 42&#39;</span>, <span style="color:#859900">NULL</span>, <span style="color:#859900">CAST</span>(<span style="color:#268bd2">REPLICATE</span>(
</span></span><span style="display:flex;"><span>       <span style="color:#859900">CAST</span>(<span style="color:#2aa198">&#39;Loads of data &#39;</span> <span style="color:#859900">as</span> <span style="color:#cb4b16">varchar</span>(<span style="color:#859900">max</span>)), <span style="color:#2aa198;font-weight:bold">10000</span>) <span style="color:#859900">AS</span> <span style="color:#cb4b16">varchar</span>(<span style="color:#859900">max</span>)), <span style="color:#859900">NULL</span>);
</span></span><span style="display:flex;"><span>     
</span></span><span style="display:flex;"><span><span style="color:#859900">GO</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><em>Code Snippet 1:</em>* <em>Setup of Database</em></p>
<p>I haven&rsquo;t listed any execute statements, as they will differ throughout this post.</p>
<h2 id="execution-of-select-statement-for-input_data_1">Execution of <code>SELECT</code> Statement for <code>@input_data_1</code></h2>
<p>So in quite a few installments of the Internals series, data for the parameter <code>@input_data_1</code> has been sent to the SqlSatellite, and in <a href="/post/2017-10-31-microsoft-sql-server-r-services---internals-xii/">Internals - XII</a> we saw what routines were involved when sending it. What we haven&rsquo;t discussed however, is at what stage in the flow the statement in the parameter gets executed. The few times I have thought about it, I assumed it was sometime after the external script has opened, as I saw it being part of the script. Let&rsquo;s find out.</p>
<p>To do this you need to run the old version of <em>WinDbg</em>, as we&rsquo;ll enable an event-filter so the debugger breaks at an <code>C++ EH</code> exception. In the <em>Event Filters</em> dialog you can set how that particular exception should be handled. We want it to be enabled, but not handled:</p>
<p>
  <img src="/images/posts/sql_r_services_windbg_eventfilters_enable.png" alt="">

</p>
<p><strong>Figure 3:</strong> <em>Enable C++ EH Exception</em></p>
<p>The idea is that we will execute something with an invalid statement for the <code>@input_data_1</code> parameter, and after having set the <code>C++ EH</code>exception filter we will be able to see the call-stack leading up to the exception.</p>
<p>So:</p>
<ol>
<li>Run the &ldquo;old&rdquo; <em>WinDbg</em> as admin.</li>
<li>Attach to the <code>sqlserver.exe</code> process.</li>
<li>Set the event filter as per above.</li>
</ol>
<p>Set also some breakpoints:</p>
<ul>
<li><code>bp sqllang!SpExecuteExternalScript</code>.</li>
<li><code>bp sqllang!CUDXR_ExternalScript::Open</code>.</li>
<li><code>bp sqllang!CUDXR_ExternalScript::ConnectToSatellite</code>.</li>
<li><code>bp sqllang!CSQLSatelliteConnection::OpenNpConnection</code>.</li>
</ul>
<p>The code to execute looks like this:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#859900">EXEC</span> <span style="color:#268bd2">sp_execute_external_script</span>
</span></span><span style="display:flex;"><span>                @<span style="color:#859900">language</span> = <span style="color:#268bd2">N</span><span style="color:#2aa198">&#39;R&#39;</span> ,
</span></span><span style="display:flex;"><span>                @<span style="color:#268bd2">script</span> = <span style="color:#268bd2">N</span><span style="color:#2aa198">&#39;Sys.sleep(10)
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">                d&lt;-InputDataSet&#39;</span>,
</span></span><span style="display:flex;"><span>                @<span style="color:#268bd2">input_data_1</span> = <span style="color:#268bd2">N</span><span style="color:#2aa198">&#39;SELECT RowID, ColInt3 
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">                  FROM dbo.tb_Tab1 WHERE RowID = 1&#39;</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 2:</strong> <em>Invalid T-SQL Statement</em></p>
<p>As you see in <em>Code Snippet 2</em> we are doing a <code>SELECT</code> and we are referencing a column - <code>ColInt3</code>- which does not exist in the table. When you execute you immediately hit the break-point at <code>sqllang!SpExecuteExternalScript</code>, and after you continue, you break for an exception. At this point, check the call-stack: <code>k</code>:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#268bd2">KERNELBASE</span>!<span style="color:#268bd2">RaiseException</span>+<span style="color:#2aa198;font-weight:bold">0x68</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">MSVCR120</span>!<span style="color:#268bd2">_CxxThrowException</span>+<span style="color:#2aa198;font-weight:bold">0xb3</span> 
</span></span><span style="display:flex;"><span>       [<span style="color:#268bd2">f</span>:\<span style="color:#268bd2">dd</span>\<span style="color:#268bd2">vctools</span>\<span style="color:#268bd2">crt</span>\<span style="color:#268bd2">crtw32</span>\<span style="color:#268bd2">eh</span>\<span style="color:#859900">throw</span>.<span style="color:#268bd2">cpp</span> @ <span style="color:#2aa198;font-weight:bold">154</span>] 
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sqldk</span>!<span style="color:#268bd2">ExceptionBackout</span>::<span style="color:#268bd2">GetCurrentException</span>+<span style="color:#2aa198;font-weight:bold">0x385</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sqldk</span>!<span style="color:#268bd2">ex_raise2</span>+<span style="color:#2aa198;font-weight:bold">0x52f</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sqldk</span>!<span style="color:#268bd2">ex_raise</span>+<span style="color:#2aa198;font-weight:bold">0xc4</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">CSQLSource</span>::<span style="color:#268bd2">FCompile</span>+<span style="color:#2aa198;font-weight:bold">0x230f</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">CSQLSource</span>::<span style="color:#268bd2">FCompWrapper</span>+<span style="color:#2aa198;font-weight:bold">0xce</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">CSQLSource</span>::<span style="color:#268bd2">Transform</span>+<span style="color:#2aa198;font-weight:bold">0x556</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">CSQLSource</span>::<span style="color:#268bd2">Execute</span>+<span style="color:#2aa198;font-weight:bold">0x3b0</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">SpExecuteExternalScript</span>+<span style="color:#2aa198;font-weight:bold">0x140e</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 3:</strong> <em>Call Stack at Exception</em></p>
<p>Notice that the exception happens right after the <code>SpExecuteExternalScript</code> but before any of the other breakpoints. That would, sort of, indicate that my assumption about the statement being executed after the opening of the script be incorrect. When you look at the call-stack, it seems that the exception happens during something that has to do with compilation of the query: <code>sqllang!CSQLSource::FCompile</code>. I guess it makes sense that SQL Server would check if the query is syntactically correct and also that the objects exists (in our case there is no column named <code>ColInt3</code>).</p>
<p>So what would happen if we executed a statement that caused a runtime exception. Let&rsquo;s say we did a <code>SELECT</code> with some computation that resulted in an exception, would we fail at the same stage as above? So let&rsquo;s see what happens if the code we execute looks like so:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#859900">EXEC</span> <span style="color:#268bd2">sp_execute_external_script</span>
</span></span><span style="display:flex;"><span>                @<span style="color:#859900">language</span> = <span style="color:#268bd2">N</span><span style="color:#2aa198">&#39;R&#39;</span> ,
</span></span><span style="display:flex;"><span>                @<span style="color:#268bd2">script</span> = <span style="color:#268bd2">N</span><span style="color:#2aa198">&#39;Sys.sleep(10)
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">                d&lt;-InputDataSet&#39;</span>,
</span></span><span style="display:flex;"><span>                @<span style="color:#268bd2">input_data_1</span> = <span style="color:#268bd2">N</span><span style="color:#2aa198">&#39;SELECT RowID, 
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">                  1 / ISNULL(ColIntN, 0) AS Calc 
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">                  FROM dbo.tb_Tab1&#39;</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 4:</strong> <em>Division By Zero</em></p>
<p>In the <code>dbo.tb_Tab1</code> table there are some <code>NULL</code> values in the <code>ColIntN</code> column, so the code in <em>Code Snippet 4</em> will cause a divide by zero exception. Keep the break-points as before and execute the query. You see now how the <code>SpExecuteExternalScript</code> break-point is hit followed by: <code>sqllang!CUDXR_ExternalScript::Open</code>, <code>sqllang!CSQLSatelliteConnection::OpenNpConnection</code> and after <code>sqllang!CUDXR_ExternalScript::ConnectToSatellite</code> there is an exception. If we check the call-stack, it looks like so (from <code>SpExecuteExternalScript</code>):</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#268bd2">KERNELBASE</span>!<span style="color:#268bd2">RaiseException</span>+<span style="color:#2aa198;font-weight:bold">0x68</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">MSVCR120</span>!<span style="color:#268bd2">_CxxThrowException</span>+<span style="color:#2aa198;font-weight:bold">0xb3</span> [<span style="color:#268bd2">f</span>:\<span style="color:#268bd2">dd</span>\<span style="color:#268bd2">vctools</span>\<span style="color:#268bd2">crt</span>\<span style="color:#268bd2">crtw32</span>\<span style="color:#268bd2">eh</span>\<span style="color:#859900">throw</span>.<span style="color:#268bd2">cpp</span> @ <span style="color:#2aa198;font-weight:bold">154</span>] 
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sqldk</span>!<span style="color:#268bd2">ExceptionBackout</span>::<span style="color:#268bd2">GetCurrentException</span>+<span style="color:#2aa198;font-weight:bold">0x385</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sqldk</span>!<span style="color:#268bd2">ex_raise2</span>+<span style="color:#2aa198;font-weight:bold">0x52f</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sqldk</span>!<span style="color:#268bd2">ex_raise</span>+<span style="color:#2aa198;font-weight:bold">0xc4</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sqlTsEs</span>!<span style="color:#268bd2">ESArithErrorHandler</span>+<span style="color:#2aa198;font-weight:bold">0x159</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sqlTsEs</span>!<span style="color:#268bd2">CTEsArith</span>&lt;<span style="color:#2aa198;font-weight:bold">3</span>,<span style="color:#2aa198;font-weight:bold">56</span>,<span style="color:#2aa198;font-weight:bold">56</span>,<span style="color:#2aa198;font-weight:bold">1</span>,<span style="color:#2aa198;font-weight:bold">0</span>&gt;::<span style="color:#268bd2">RsltArithArgArg</span>+<span style="color:#2aa198;font-weight:bold">0x94</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sqlTsEs</span>!<span style="color:#268bd2">CEsExec</span>::<span style="color:#268bd2">GeneralEval4</span>+<span style="color:#2aa198;font-weight:bold">0xe7</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">CUDXR_ExternalScript</span>::<span style="color:#268bd2">PushRow</span>+<span style="color:#2aa198;font-weight:bold">0x78</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sqlmin</span>!<span style="color:#268bd2">CQScanUdx</span>::<span style="color:#268bd2">PushNextChildRow</span>+<span style="color:#2aa198;font-weight:bold">0x13b</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sqlmin</span>!<span style="color:#268bd2">CQScanUdx</span>::<span style="color:#268bd2">GetRow</span>+<span style="color:#2aa198;font-weight:bold">0x79</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sqlmin</span>!<span style="color:#268bd2">CQueryScan</span>::<span style="color:#268bd2">GetRow</span>+<span style="color:#2aa198;font-weight:bold">0x81</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">CXStmtQuery</span>::<span style="color:#268bd2">ErsqExecuteQuery</span>+<span style="color:#2aa198;font-weight:bold">0x4dc</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">CXStmtSelect</span>::<span style="color:#268bd2">XretExecute</span>+<span style="color:#2aa198;font-weight:bold">0x322</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">CMsqlExecContext</span>::<span style="color:#268bd2">ExecuteStmts</span>&lt;<span style="color:#2aa198;font-weight:bold">1</span>,<span style="color:#2aa198;font-weight:bold">1</span>&gt;+<span style="color:#2aa198;font-weight:bold">0x40d</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">CMsqlExecContext</span>::<span style="color:#268bd2">FExecute</span>+<span style="color:#2aa198;font-weight:bold">0xa9e</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">CSQLSource</span>::<span style="color:#268bd2">Execute</span>+<span style="color:#2aa198;font-weight:bold">0x983</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">SpExecuteExternalScript</span>+<span style="color:#2aa198;font-weight:bold">0x140e</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 5:</strong> <em>Call Stack at Divide by Zero</em></p>
<p>When we compare the call-stacks in <em>Code Snippet 3</em> and <em>Code Snippet 5</em> we see how the paths are different. It seems that when having <code>@input_data_1</code>, some optimization and compilation of the statement happens first, and the statement is actually executed when the connection to the satellite has happened, and it looks like that happens inside <code>sqllang!CXStmtQuery::ErsqExecuteQuery</code>.</p>
<p>If we think back to what we covered in Internals <a href="/post/2017-10-20-microsoft-sql-server-r-services---internals-xi/">XI</a> and <a href="/post/2017-10-31-microsoft-sql-server-r-services---internals-xii/">XII</a>, and we &ldquo;merge&rdquo; that what we have seen so far in this post, it seems that <code>sp_execute_external_script</code> has three distinct phases:</p>
<ol>
<li>Compilation and optimizing the <code>@input_data_1</code> statement</li>
<li>Connecting to launchpad and SqlSatellite and sending the script to the SqlSatellite</li>
<li>Executing the <code>@input_data_1</code> statement and sending the result to SqlSatellite.</li>
</ol>
<p>OK, if we let the code continue after having hit the exception and looked at the call-stack, we&rsquo;ll see something somewhat interesting (strange) in the message tab in <strong>SSMS</strong>:</p>
<p>
  <img src="/images/posts/sql_r_services_13_error.png" alt="">

</p>
<p><strong>Figure 4:</strong> <em>Error Message from SqlSatellite</em></p>
<p>When looking at <em>Figure 4</em> it seems that SqlSatellite is confused about something, almost like it would have received a packet/something which it couldn&rsquo;t handle. That would make sense if a packet actually were sent to the SqlSatellite with the result from the <code>SELECT</code>, and potentially the data was corrupted due to the null exception.</p>
<p>Let&rsquo;s start with looking at what packages are being sent to the SqlSatellite when executing the code in <em>Code Snippet 4</em>. For this we&rsquo;ll use <em>Process Monitor</em> and set it up as we did in [Internals - X], as well as in <a href="/post/2017-10-31-microsoft-sql-server-r-services---internals-xii/">Internals - XII</a>, to filter TCP packets. When you have set up <em>Process Monitor</em> you are ready to execute the code in <em>Code Snippet 4</em>, but before you do that, disable all breakpoints in <em>WinDbg</em>. Execute the code and look at what <em>Process Monitor</em> outputs:</p>
<p>
  <img src="/images/posts/sql_r_services_13_error_procmon.png" alt="">

</p>
<p><strong>Figure 5:</strong> <em>Process Monitor Output at Error</em></p>
<p>In <em>Figure 5</em> we initially see what we expect:</p>
<ul>
<li>Authentication packets (lengths 217 and 17).</li>
<li>The script package (length 256).</li>
</ul>
<p>But after the script package we see a packet with the length of 28, what is that? Also, we do not see any packet that would be related to the data, so the idea that the SqlSatellite received a packet it could not handle may not be correct. So, where does the message about the SqlSatellite and data chunks in <em>Figure 4</em> come from?</p>
<h4 id="packet-with-length-28">Packet with Length 28</h4>
<p>We&rsquo;ll start with the packet with a length of 28. In <a href="/post/2017-10-31-microsoft-sql-server-r-services---internals-xii/">Internals - XII</a> we saw how packets with a length of 28 were sent as end of script, and end of data packets. Perhaps it is something similar here. We saw in <a href="/post/2017-10-31-microsoft-sql-server-r-services---internals-xii/">Internals - XII</a> how the end packets were sent in a flow looking something like so:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">CXStmtQuery</span>::<span style="color:#268bd2">ErsqExecuteQuery</span>
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">sqlmin</span>!<span style="color:#268bd2">CQScanUdx</span>::<span style="color:#268bd2">PushNextChildRow</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">CUDXR_ExternalScript</span>::<span style="color:#268bd2">PushEOS</span>
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">CSatelliteCargoContext</span>::<span style="color:#268bd2">SendPackets</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">CUDXR_ExternalScript</span>::<span style="color:#268bd2">PushEOS</span>
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">CSatelliteCargoContext</span>::<span style="color:#268bd2">SendChunkEndMessage</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">CUDXR_ExternalScript</span>::<span style="color:#268bd2">PushEOS</span>
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">CSatelliteCargoContext</span>::<span style="color:#268bd2">SendChunkEndMessage</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 6:</strong> <em>Abbreviated Flow Result Data</em></p>
<p>Let&rsquo;s set some breakpoints and see what we can figure out:</p>
<ul>
<li><code>bp sqlmin!CQScanUdx::PushNextChildRow</code>.</li>
<li><code>bp sqllang!CUDXR_ExternalScript::PushEOS</code></li>
<li><code>bp sqllang!CSatelliteCargoContext::SendChunkEndMessage</code>.</li>
<li><code>bp sqllang!CUDXR_ExternalScript::PushRow</code></li>
</ul>
<p>When we execute we hit:</p>
<ul>
<li><code>sqlmin!CQScanUdx::PushNextChildRow</code> followed by</li>
<li><code>sqllang!CUDXR_ExternalScript::PushRow</code> followed by</li>
<li><code>sqllang!CUDXR_ExternalScript::PushRow</code> followed by</li>
<li><code>(1a54.23c8): C++ EH exception - code e06d7363 (first chance)</code></li>
</ul>
<p>After the second <code>PushRow</code> we break at the exception, and when we let the code continue, we get the error message back, but we also see that a packet with a length of 28 is sent to the SqlSatellite. So, if the packet is not coming from the <code>SendChunkEndMessage</code> routine, where does it come from then? Let&rsquo;s do what we did in <a href="/post/2017-10-31-microsoft-sql-server-r-services---internals-xii/">Internals - XII</a> when we did not know from where a packet was sent - set a breakpoint at <code>mswsock!WSPSend</code>. The theory behind this is that, at one stage or another, a low level socket call needs to take place. After you have set the breakpoint, execute again and now the breakpoints are hit as follows:</p>
<ul>
<li><code>mswsock!WSPSend</code> three times in a row (the two authentication packets and the script packet)</li>
<li><code>sqlmin!CQScanUdx::PushNextChildRow</code> followed by</li>
<li><code>sqllang!CUDXR_ExternalScript::PushRow</code> followed by</li>
<li><code>sqllang!CUDXR_ExternalScript::PushRow</code> followed by</li>
<li><code>(1a54.23c8): C++ EH exception - code e06d7363 (first chance)</code></li>
</ul>
<blockquote>
<p><strong>NOTE:</strong> The reason we get two <code>PushRow</code> is that we are selecting two rows from the table.</p>
</blockquote>
<p>Continuing after the exception we will hit <code>mswsock!WSPSend</code>, and checking the call-stack - it looks like this:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#268bd2">mswsock</span>!<span style="color:#268bd2">WSPSend</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">WS2_32</span>!<span style="color:#268bd2">WSASend</span>+<span style="color:#2aa198;font-weight:bold">0x16c</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">Tcp</span>::<span style="color:#268bd2">WriteAsync</span>+<span style="color:#2aa198;font-weight:bold">0x174</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">SNIWriteAsync</span>+<span style="color:#2aa198;font-weight:bold">0xb0</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">CSQLSatelliteConnection</span>::<span style="color:#268bd2">WriteMessage</span>+<span style="color:#2aa198;font-weight:bold">0x7d</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">CSQLSatelliteCommunication</span>::<span style="color:#268bd2">SendAbort</span>+<span style="color:#2aa198;font-weight:bold">0x190</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">CUDXR_ExternalScript</span>::<span style="color:#268bd2">ShutdownService</span>+<span style="color:#2aa198;font-weight:bold">0x96</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sqlmin</span>!<span style="color:#268bd2">CUDXR_ExternalScriptCleanup</span>::<span style="color:#268bd2">Close</span>+<span style="color:#2aa198;font-weight:bold">0xe</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sqlmin</span>!<span style="color:#268bd2">CQueryExecContext</span>::<span style="color:#268bd2">FinalCleanupNoX</span>+<span style="color:#2aa198;font-weight:bold">0x116</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sqlmin</span>!<span style="color:#268bd2">CQueryScan</span>::<span style="color:#268bd2">DestroyQueryOnException</span>+<span style="color:#2aa198;font-weight:bold">0x129</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">CXStmtQuery</span>::<span style="color:#268bd2">ShutdownOnException</span>+<span style="color:#2aa198;font-weight:bold">0xc8</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">CXStmtQuery</span>::<span style="color:#268bd2">FinishOnExceptionImp</span>+<span style="color:#2aa198;font-weight:bold">0x67</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">_isa_available_init</span>+<span style="color:#2aa198;font-weight:bold">0xe8cf3</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">MSVCR120</span>!<span style="color:#268bd2">_CallSettingFrame</span>+<span style="color:#2aa198;font-weight:bold">0x20</span> 
</span></span><span style="display:flex;"><span><span style="color:#268bd2">MSVCR120</span>!<span style="color:#268bd2">__CxxCallCatchBlock</span>+<span style="color:#2aa198;font-weight:bold">0xf5</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">ntdll</span>!<span style="color:#268bd2">RcConsolidateFrames</span>+<span style="color:#2aa198;font-weight:bold">0x3</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">CMsqlExecContext</span>::<span style="color:#268bd2">FExecute</span>+<span style="color:#2aa198;font-weight:bold">0xa9e</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">CSQLSource</span>::<span style="color:#268bd2">Execute</span>+<span style="color:#2aa198;font-weight:bold">0x983</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">SpExecuteExternalScript</span>+<span style="color:#2aa198;font-weight:bold">0x140e</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 7:</strong> <em>Call Stack at the Time a Packet is Sent</em></p>
<p>Ah, from the call-stack in <em>Code Snippet 7</em> we can see how the exception brings us back to <code>sqllang!CMsqlExecContext::FExecute</code> and from there we go down a code path which eventually comes into the <code>sqllang!CSQLSatelliteCommunication::SendAbort</code> routine, which sends the packet with a length of 28.</p>
<p>We have now an explanation to the packet with a length of 28, it is SQL Server telling the SqlSatellite, that it aborts the process. The question about the message we see about SqlSatellite not being able to read the data chunk is not as straight forward though.</p>
<h4 id="sqlsatellite-data-chunk-message">SqlSatellite Data Chunk Message</h4>
<p>Initially I thought the message came from inside SQL Server, but based on some tests I did, I believe the message originates in the SqlSatellite after the satellite has received the abort message. Reasoning behind this is based on that the message does not &ldquo;smell&rdquo; like a SQL Server Error message; it doesn&rsquo;t have an error number attached and it looks a lot like the output you&rsquo;d get from the external script engine. Remember from <a href="/post/2017-07-11-microsoft-sql-server-r-services---internals-vii/">Internals - VII</a> where we discussed files and sub-directories created by the launchpad service as well as the external engine, how - by default - two files are created by the launchpad service:</p>
<ul>
<li><code>stdout0.txt</code> - for <code>cat</code> and <code>print</code> output from the engine.</li>
<li><code>stderr0.txt</code> - for error logging from the engine.</li>
</ul>
<p>The tests I did was based on my thinking that if the message originates from SQL Server, then neither <code>stdout0.txt</code> nor <code>stderr0.txt</code> would contain anything. However if the message originated from the external engine, then I should see something in either of those two files.</p>
<p>To be able to investigate this, I did what we did in <a href="/post/2017-07-11-microsoft-sql-server-r-services---internals-vii/">Internals - VII</a>:</p>
<ol>
<li>Stop the launchpad service.</li>
<li>Delete any sub directories of the user account directories in the <code>C:\&lt;sql_instance_path&gt;\MSSQL\ExtensibilityData</code> directory. Do NOT delete the user account directories themselves.</li>
<li>Open the <code>rlauncher.config</code> file in a text editor and change the value of <code>JOB_CLEANUP_ON_EXIT</code> to 0, and save the file (you need to do this as admin).</li>
<li>Restart the launchpad service.</li>
</ol>
<blockquote>
<p><strong>NOTE:</strong> By setting the <code>JOB_CLEANUP_ON_EXIT</code> to 0 we tell the launchpad service to not delete any directories etc., after we have executed (the executing process will still be torn down though).</p>
</blockquote>
<p>After executing the code in <em>Code Snippet 4</em> I browsed through the various subdirectories of the user account directory in <code>C:\&lt;sql_instance_path&gt;\MSSQL\ExtensibilityData</code> (most likely <em>MSSQLSERVER01</em>), to find the directory which the process executed under. This directory has four files in it and one sub directory (the other directories are either empty, or has three files and a sub directory):</p>
<p>
  <img src="/images/posts/sql_r_services_13_user_directory_err_file.png" alt="">

</p>
<p><strong>Figure 6:</strong> <em>Process Directory with stderr.txt</em></p>
<p>As we can see in <em>Figure 6</em> the <code>stderr.txt</code> files has a size greater than 0, and when opening I could see the same message as in <em>SSMS</em>:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#268bd2">SqlSatellite</span> <span style="color:#268bd2">cannot</span> <span style="color:#268bd2">read</span> <span style="color:#268bd2">data</span> <span style="color:#268bd2">chunk</span>.  <span style="color:#268bd2">Error</span> <span style="color:#268bd2">code</span>:<span style="color:#2aa198;font-weight:bold">0x80004004</span>.
</span></span><span style="display:flex;"><span><span style="color:#268bd2">Error</span> <span style="color:#268bd2">in</span> <span style="color:#268bd2">eval</span>(<span style="color:#268bd2">expr</span>, <span style="color:#268bd2">envir</span>, <span style="color:#268bd2">enclos</span>) : 
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">SqlSatellite</span> <span style="color:#268bd2">cannot</span> <span style="color:#268bd2">read</span> <span style="color:#268bd2">data</span> <span style="color:#268bd2">chunk</span>.  <span style="color:#268bd2">Error</span> <span style="color:#268bd2">code</span>:<span style="color:#2aa198;font-weight:bold">0x80004004</span>.
</span></span><span style="display:flex;"><span><span style="color:#268bd2">Calls</span>: <span style="color:#268bd2">source</span> -&gt; <span style="color:#268bd2">withVisible</span> -&gt; <span style="color:#268bd2">eval</span> -&gt; <span style="color:#268bd2">eval</span> -&gt; .<span style="color:#268bd2">Call</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">Execution</span> <span style="color:#268bd2">halted</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 8:</strong> <em>Stderror.txt Content</em></p>
<p>Based on this, it seems that particular message comes from the SqlSatellite and the external engine. Oh, when I executed the code in <em>Code Snippet 2</em> (fails during compilation), <code>stderr.txt</code> was not written to. E.g. the error happened before the SqlSatellite had been initialized. In a future post we will look more at what goes on when data - results as well as errors - come back to SQL Server.</p>
<h2 id="summary">Summary</h2>
<p>In this post we set out to try to understand when and how the statement that makes up <code>@input_data_1</code> is executed. We saw:</p>
<ul>
<li>Before the SqlSatellite was initialized the statement is compiled.</li>
<li>After the satellite has been initialized the statement is executed.</li>
</ul>
<p>We also saw that if an error happens after the satellite has been initialized, SQL Server sends an abort message to the satellite in the <code>sqllang!CSQLSatelliteCommunication::SendAbort</code> routine.</p>
<h2 id="-finally">~ Finally</h2>
<p>If you have comments, questions etc., please comment on this post or <a href="mailto:niels.it.berglund@gmail.com">ping</a> me.</p>

                

                
                <hr>
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/post/2017-11-05-interesting-stuff---week-44/" data-toggle="tooltip" data-placement="top" title="Interesting Stuff - Week 44">&larr;
                            Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/post/2017-11-12-interesting-stuff---week-45/" data-toggle="tooltip" data-placement="top" title="Interesting Stuff - Week 45">Next
                            Post &rarr;</a>
                    </li>
                    
                </ul>
                

                


<div id="disqus-comment"></div>
<div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "manageddata" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>



            </div>

            
            
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
            

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                
                

                
                
            </div>
        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">                  
                    
                    <li>
                        <a href="mailto:niels.it.berglund@gmail.com">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		           
                    
                    <li>
                        <a href="https://twitter.com/nielsberglund">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    

		            
                    
                    
                    <li>
                        <a target="_blank" href="https://github.com/nielsberglund">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		            
                    
                    
                    
                    <li>
                        <a target="_blank" href="https://www.linkedin.com/in/niels-berglund-0122593">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		           
                    
                    <li>
                        <a target="_blank" href="https://medium.com/@nielsberglund">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-medium fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a target="_blank" href="https://stackoverflow.com/users/7656880/niels-berglund">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-stack-overflow fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    
                    <li>
                        <a target="_blank" href="https://fosstodon.org/@nielsb">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-mastodon fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
            
            
            
           
           <li>
             <a target="_blank" href="https://nielsberglund.com/index.xml">
                <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
                </span>
             </a>
           </li>
           
             </ul>
		<p class="copyright text-muted">
                    Copyright &copy; Niels Berglund 2023
                    <br>
                    <a href="https://themes.gohugo.io/hugo-theme-cleanwhite">CleanWhite Hugo Theme</a> by <a href="https://zhaohuabing.com">Huabing</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>




<script>
    function loadAsync(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        loadAsync("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>






<script type="text/javascript">
    function generateCatalog(selector) {

        
        
        
        
            _containerSelector = 'div.post-container'
        

        
        var P = $(_containerSelector), a, n, t, l, i, c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        
        $(selector).html('')

        
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#" + $(this).prop('id');
            t = $(this).text();
            c = $('<a href="' + i + '" rel="nofollow">' + t + '</a>');
            l = $('<li class="' + n + '_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    
    $(".catalog-toggle").click((function (e) {
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    


    loadAsync("\/js\/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>






</body>
</html>
