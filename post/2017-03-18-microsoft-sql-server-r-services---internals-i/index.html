<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <meta property="og:site_name" content="Niels Berglund">
    <meta property="og:type" content="article">

    
    <meta property="og:image" content="https://nielsberglund.com//images/banner/main-banner-2.jpg">
    <meta property="twitter:image" content="https://nielsberglund.com//images/banner/main-banner-2.jpg" />
    

    
    <meta name="title" content="Microsoft SQL Server R Services - Internals I" />
    <meta property="og:title" content="Microsoft SQL Server R Services - Internals I" />
    <meta property="twitter:title" content="Microsoft SQL Server R Services - Internals I" />
    

    
    <meta name="description" content="SQL Server R Services series. Today we look at what happen in the SQL Server engine when we execute sp_execute_external_script.">
    <meta property="og:description" content="SQL Server R Services series. Today we look at what happen in the SQL Server engine when we execute sp_execute_external_script." />
    <meta property="twitter:description" content="SQL Server R Services series. Today we look at what happen in the SQL Server engine when we execute sp_execute_external_script." />
    

    
    <meta property="twitter:card" content="summary" />
    
    

    <meta name="keyword"  content="SQL Server, .NET, Kafka, Streaming, Azure Data Explorer, AI/ML">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>Microsoft SQL Server R Services - Internals I | Niels Berglund</title>

    <link rel="canonical" href="/post/2017-03-18-microsoft-sql-server-r-services---internals-i/">

    
    
    
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="/css/hugo-theme-cleanwhite.min.css">

    
    <link rel="stylesheet" href="/css/zanshang.css">

    
    <link rel="stylesheet" href="/css/font-awesome.all.min.css">

    
    

    
    <link rel="stylesheet" href="/css/niels-styles.css">
    <link rel="stylesheet" href="/css/niels-styles2.css">

    
    <script src="/js/jquery.min.js"></script>

    
    <script src="/js/bootstrap.min.js"></script>

    
    <script src="/js/hux-blog.min.js"></script>

    
    <script src="/js/lazysizes.min.js"></script>

    
    

    <script defer data-domain="nielsberglund.com" src="https://plausible.io/js/script.file-downloads.outbound-links.js"></script>

</head>






<nav class="navbar navbar-default navbar-custom navbar-fixed-top">

    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Niels Berglund</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">All Posts</a>
                    </li>
                    
                    
		    
                        <li><a href="/series//">BLOG SERIES</a></li>
                    
                        <li><a href="/top/about//">ABOUT ME</a></li>
                    
                        <li><a href="/top/archive//">ARCHIVE</a></li>
                    
                        <li><a href="/top/disclaimer//">DISCLAIMER</a></li>
                    
		            <li>
                        <a href="/search"><i class="fa fa-search"></i></a>
		           </li>
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>




<style type="text/css">
    header.intro-header {
        background-image: url('/images/banner/main-banner-2.jpg')
    }
</style>

<header class="intro-header" >

    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/sql-server-r-services" title="SQL Server R Services">
                            SQL Server R Services
                        </a>
                        
                        <a class="tag" href="/tags/sql-server-machine-learning-services" title="SQL Server Machine Learning Services">
                            SQL Server Machine Learning Services
                        </a>
                        
                        <a class="tag" href="/tags/r" title="R">
                            R
                        </a>
                        
                        <a class="tag" href="/tags/windbg" title="WinDbg">
                            WinDbg
                        </a>
                        
                    </div>
                    <h1>Microsoft SQL Server R Services - Internals I</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        
                            Posted by 
                            
                                nielsb
                             
                            on 
                            Saturday, March 18, 2017
                            
                            
                            
                            
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                
                <p>This is the second post in a series about <strong>Microsoft SQL Server R Services</strong>, and the first post that drills down into the internal of how it works. To see other posts (including this) in the series, go to 

<a href="/sql_server_2k16_r_services"><strong>SQL Server R Services</strong></a>.</p>
<p>In this post, and one or two more we will look at what goes on under the covers when we execute some R code inside SQL Server. This post looks at quite in detail what happens in the SQL engine when we execute <code>sp_execute_external_script</code>.</p>
<p>To try and get an understanding we&rsquo;ll do something that we did quite a lot back in the day when I worked at Developmentor; we&rsquo;ll 

<a href="http://queue.acm.org/detail.cfm?id=945136" target="_blank" rel="noopener">&ldquo;spelunk&rdquo;</a> the SQL Server code via <em>WinDbg</em>. This can be really useful when trying to understand and get to grips with new technology/functionality.</p>
<blockquote>
<p><strong>NOTE:</strong> Developmentor were back in the day THE training company to go to if you wanted highly, highly technical training about COM, .NET, SQL Server, etc. 

<a href="http://www.javaworld.com/article/2073792/core-java/a-eulogy--developmentor--rip.html" target="_blank" rel="noopener">This article</a> by my old colleague 

<a href="http://blogs.tedneward.com/" target="_blank" rel="noopener">Ted Neward</a> (@tedneward) sums DM up quite accurately (apart from the fact that DM hadn&rsquo;t closed its doors when the article was written, ooops).</p>
</blockquote>
<h2 id="overview">Overview</h2>
<p>The first post in the series discussed how to install and enable SQL Server R Services. In there I mentioned how the SQL Server R Services are different from SQLCLR in that the R engine is external to SQL Server, whereas in SQLCLR, CLR is loaded into the same process as the SQL Server engine.</p>
<p>So in SQL Server R Services, there must be a way to communicate out of the SQL engine, and into the R engine/runtime, and back into the SQL Server process. Before we&rsquo;ll start trying to figure out what is going on, let&rsquo;s make sure WinDbg is set up.</p>
<h2 id="windbg">WinDbg</h2>
<p>If you want to follow along with what I did, and you haven&rsquo;t used WinDbg before, this section talks about how to attach to a process etc. If you are used to this, please skip it.</p>
<p>In order to use WinDbg, we need to ensure we have the symbol file path set. The easiest is to have the symbol path pointing to Microsoft&rsquo;s Symbol Server. To set things up and also get an introduction to debugging SQL Server with WinDbg, go and read 

<a href="http://www.sqlpassion.at/archive/2014/05/05/sql-server-debugging-with-windbg-an-introduction/" target="_blank" rel="noopener">Klaus Aschenbrenner&rsquo;s (@Aschenbrenner) excellent introduction</a> to the subject.</p>
<p>When you want to debug and having the symbol path set you can attach to the SQL Server process, either by doing it as in Klaus&rsquo; post, or you can attach from within WinDbg:</p>
<p>
  <img src="/images/posts/sql_r_services_windbg_attach_menu.png" alt="">

</p>
<p><strong>Figure 1:</strong> <em>Attach to Process Menu</em></p>
<p>In WinDbg you either choose <em>Attach to a Process</em> from the File menu as in <em>Figure 1</em>, or you click F6. You are then presented with the <em>Attach to Process</em> dialog, where you choose <em>sqlservr.exe</em> as in <em>Figure 2</em>:</p>
<p>
  <img src="/images/posts/sql_r_services_windbg_attach_process.png" alt="">

</p>
<p><strong>Figure 2:</strong> <em>Attach to Process Dialog</em></p>
<blockquote>
<p><strong>NOTE:</strong> <strong>NEVER, EVER</strong> run WinDbg against a production SQL Server, <strong>NEVER</strong>!!</p>
</blockquote>
<p>When you have attached to the process it can be prudent to reload the symbols for that process, by executing <code>.reload -f sqlservr.exe</code> from the WinDbg command line:</p>
<p>
  <img src="/images/posts/sql_r_services_windbg_reload_symbols.png" alt="">

</p>
<p><strong>Figure 3:</strong> <em>Reload Symbols</em></p>
<p>You should now be good to go.</p>
<h2 id="sp_execute_external_script">sp_execute_external_script</h2>
<p>We&rsquo;ll start with the procedure <code>sp_execute_external_script</code>. When reading official documentation, it says that the procedure is an extended stored procedure, and, indeed, if we try and do <code>sp_helptext sp_execute_external_script</code>, the result coming back is like so:</p>
<p>
  <img src="/images/posts/sql_r_services_ext_proc.png" alt="">

</p>
<p><strong>Figure 4:</strong> <em>Result of sp_helptext Against sp_execute_external_script</em></p>
<p>The result indicates that this is internal to the server. Let us see if we can find out what happens when executing the proc by using WinDbg.</p>
<p>An assumption we&rsquo;ll make is that when we execute the proc, there will be some symbols with a name something like <code>ExternalScript</code> among the various SQL Server modules. So, let us see what we can find. We do it by using the <code>x</code> command from the WinDbg command-line, like so: <code>x *!*ExternalScript*</code> (the &ldquo;*&rdquo; denotes a wild-card, like &ldquo;%&rdquo; in T-SQL). Whoops, that returned quite a lot of information:</p>
<p>
  <img src="/images/posts/sql_r_services_windbg_extscript_symbols.png" alt="">

</p>
<p><strong>Figure 5:</strong> <em>Result of Looking for Symbols With ExternalScript in the Name</em></p>
<p>OK, but we are probably onto something here. When skimming the result we see that <code>ExternalScript</code> occurs in two modules:</p>
<ul>
<li><code>sqllang</code> - Implements things to do with T-SQL as well as the query engine.</li>
<li><code>sqlmin</code> - Implements things related to the relational engine.</li>
</ul>
<p>Seeing that it occurs in <code>sqllang</code> and <code>sqllang</code> has to do with T-SQL etc., a fairly solid assumption is that we should look in the <code>sqllang</code> module for anything that has to do with that procedure. So just for giggles, let us execute on the WinDbg command-line the following: <code>x sqllang!*execute*externalscript*</code>:</p>
<p>
  <img src="/images/posts/sql_r_services_windbg_spexecuteextscript.png" alt="">

</p>
<p><strong>Figure 6:</strong> <em>sqllang!SpExecuteExternalScript</em></p>
<p>Cool, we found something that probably is what we are after: <code>SpExecuteExternalScript</code>.</p>
<p>To see if our assumption is correct we now set a break-point at <code>SpExecuteExternalScript</code>: <code>bp sqllang!SpExecuteExternalScript</code>. After the breakpoint is set, do not forget to click F5 to continue the process. At this stage we can now execute the <code>sp_execute_external_script</code> procedure and see if the breakpoint was hit:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#859900">EXEC</span> <span style="color:#268bd2">sp_execute_external_script</span> 
</span></span><span style="display:flex;"><span>                    @<span style="color:#859900">language</span> =<span style="color:#268bd2">N</span><span style="color:#2aa198">&#39;R&#39;</span>,
</span></span><span style="display:flex;"><span>                    @<span style="color:#268bd2">script</span>=<span style="color:#268bd2">N</span><span style="color:#2aa198">&#39;OutputDataSet&lt;-InputDataSet&#39;</span>,
</span></span><span style="display:flex;"><span>                    @<span style="color:#268bd2">input_data_1</span> =<span style="color:#268bd2">N</span><span style="color:#2aa198">&#39;SELECT 42&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#859900">WITH</span> <span style="color:#859900">RESULT</span> <span style="color:#859900">SETS</span> (([<span style="color:#268bd2">TheAnswer</span>] <span style="color:#cb4b16">int</span> <span style="color:#859900">not</span> <span style="color:#859900">null</span>));
</span></span><span style="display:flex;"><span><span style="color:#859900">GO</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 1:</strong> <em>Execute sp_execute_external_script</em></p>
<p>As can be seen in <em>Figure 7</em> below, the breakpoint is hit. It seems that our assumption is right:</p>
<p>
  <img src="/images/posts/sql_r_services_windbg_hitting_breakpoint.png" alt="">

</p>
<p><strong>Figure 7:</strong> <em>Hitting the Breakpoint</em></p>
<p>When we have hit the breakpoint as in <em>Figure 7</em>, what do we do then? Well, we can always use the <code>k</code> command to look at the call-stack up until the breakpoint:</p>
<p>
  <img src="/images/posts/sql_r_services_windbg_callstack1.png" alt="">

</p>
<p><strong>Figure 8:</strong> <em>Partial call-stack</em></p>
<p><em>Figure 8</em> shows part of the call-stack, and we can see what routines were called leading up to <code>SpExecuteExternalScript</code>. When you have looked at the call-stack you can hit F5, to let the routine complete and you should see a result in the Results tab in SSMS.</p>
<p>But we are not really anywhere closer to understand what is going on, except that we know what has been called up until the breakpoint. We are interested in what routines <code>SpExecuteExternalScript</code> calls. To find out about that, there is a command in WinDbg, which allows us to disassemble routines; the <code>uf</code> command. The command signature looks like so: <code>uf [options] &lt;address&gt;</code>, where the address is the routine, and the options define how to display the result. One of the options is <code>/c</code> which displays only the call instructions in a routine. Let&rsquo;s execute <code>uf /c sqllang!SpExecuteExternalScript</code> and see what is being called. Quite a few calls are made and the figure below shows some of them:</p>
<p>
  <img src="/images/posts/sql_r_services_windbg_calls1.png" alt="">

</p>
<p><strong>Figure 9:</strong> <em>Calls Being Made by SpExecuteExternalScript</em></p>
<p>When looking at the calls, there is nothing really that stands out, apart from the <code>sqllang!CSQLSource::Execute (00007ff9 ee237ec0)</code> call. We can assume that, that call takes us further down the &ldquo;rabbit-hole&rdquo;, and we eventually could figure out what is going on. Tracing down could however take quite a while, so let us try another angle.</p>
<blockquote>
<p><strong>NOTE:</strong> When you have hit a breakpoint in WinDbg you can use a trace command 

<a href="https://msdn.microsoft.com/en-us/library/windows/hardware/ff561497%28v=vs.85%29.aspx" target="_blank" rel="noopener"><code>wt</code></a> to continue the execution and at the same time print out the calls being made. For a call like <code>SpExecuteExternalScript</code> the output will get very, very large, and also not completely easy to interpret, so we will not use it for <code>SpExecuteExternalScript</code>. We will use it a bit later though .</p>
</blockquote>
<p>What we will do instead is to go back and look at symbols. The assumption is that calls further down the call-chain will have something to do with external scripts, and most likely be executed from within the <code>sqllang</code> module.</p>
<p>So let us execute a variant of what we did when finding <code>SpExecuteExternalScript</code>; we&rsquo;ll execute <code>x sqllang!*ExternalScript*</code>. Quite a few routines comes back, I have copied some of the ones that might be of interest to us into the code snippet below:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#2aa198;font-weight:bold">0</span>:<span style="color:#2aa198;font-weight:bold">113</span>&gt; <span style="color:#268bd2">x</span> <span style="color:#268bd2">sqllang</span>!*<span style="color:#268bd2">ExternalScript</span>*
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">CUDXR_ExternalScript</span>::<span style="color:#268bd2">PrepareLauncherInfo</span> (&lt;<span style="color:#268bd2">no</span> <span style="color:#268bd2">parameter</span> <span style="color:#268bd2">info</span>&gt;)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">CUDXR_ExternalScript</span>::<span style="color:#268bd2">ConnectToSatellite</span> (&lt;<span style="color:#268bd2">no</span> <span style="color:#268bd2">parameter</span> <span style="color:#268bd2">info</span>&gt;)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">CUDXR_ExternalScript</span>::<span style="color:#268bd2">Open</span> (&lt;<span style="color:#268bd2">no</span> <span style="color:#268bd2">parameter</span> <span style="color:#268bd2">info</span>&gt;)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">CUDXR_ExternalScript</span>::<span style="color:#268bd2">SetupService</span> (&lt;<span style="color:#268bd2">no</span> <span style="color:#268bd2">parameter</span> <span style="color:#268bd2">info</span>&gt;)
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 2:</strong> <em>Result from <code>x sqllang!*ExternalScript*</code></em></p>
<p>If you want, you can set breakpoints for the routines in <em>Code Snippet 2</em>, and see if they are hit when executing the code in <em>Code Snippet 1</em>. In my tests they were hit in the following order:</p>
<ul>
<li>sqllang!SpExecuteExternalScript</li>
<li>sqllang!CUDXR_ExternalScript::Open</li>
<li>sqllang!CUDXR_ExternalScript::SetupService</li>
<li>sqllang!CUDXR_ExternalScript::PrepareLauncherInfo</li>
<li>sqllang!CUDXR_ExternalScript::ConnectToSatellite:</li>
</ul>
<p>No surprise we hit <code>SpExecuteExternalScript</code> first, and I guess at one stage the script has to <code>Open</code>. The question is what the other three routines are doing?</p>
<p>In the <em>Overview</em> section in the beginning of this post I wrote how we need to communicate out of SQL Server in order to get to the R runtime. In my [previous post] 

<a href="/post/2017-03-04-microsoft-sql-server-2016-r-services-installation/">1</a>, I mentioned the <em>Launchpad</em> service, and how it acts as a &ldquo;routing&rdquo; mechanism between SQL Server and external languages/runtimes.</p>
<p>So, somehow SQL Server calls into the launchpad service in order to have the R engine execute the R code. The routines <code>SetupService</code> and <code>PrepareLauncherInfo</code>, has to do with the launchpad service., and we&rsquo;ll shortly have a closer look at what <code>SetupService</code> does. The <code>ConnectToSatellite</code> routine is for when results are coming back into SQL Server from the external runtime.</p>
<blockquote>
<p><strong>NOTE:</strong> Before we go any further, make sure that you are not sitting at a break-point, e.g. hit F5 to let the debugger run.</p>
</blockquote>
<p>What about <code>SetupService</code> then, let us start with disassemble the routine to see what code is being called: <code>uf /c sqllang!CUDXR_ExternalScript::SetupService</code> (all code is not showing, I have copied certain interesting parts):</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#2aa198;font-weight:bold">0</span>:<span style="color:#2aa198;font-weight:bold">125</span>&gt; <span style="color:#268bd2">uf</span> /<span style="color:#268bd2">c</span> <span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">CUDXR_ExternalScript</span>::<span style="color:#268bd2">SetupService</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">CUDXR_ExternalScript</span>::<span style="color:#268bd2">SetupService</span>+<span style="color:#2aa198;font-weight:bold">0xa6</span> (<span style="color:#2aa198;font-weight:bold">00007ff</span><span style="color:#2aa198;font-weight:bold">8</span> <span style="color:#2aa198;font-weight:bold">77179</span><span style="color:#268bd2">ee6</span>):
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">call</span> <span style="color:#268bd2">to</span> <span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">CSQLSatelliteCommunication</span>::<span style="color:#268bd2">Init</span> (<span style="color:#2aa198;font-weight:bold">00007ff</span><span style="color:#2aa198;font-weight:bold">8</span> <span style="color:#2aa198;font-weight:bold">7763</span><span style="color:#268bd2">bfc0</span>)
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">CUDXR_ExternalScript</span>::<span style="color:#268bd2">SetupService</span>+<span style="color:#2aa198;font-weight:bold">0x19c</span> (<span style="color:#2aa198;font-weight:bold">00007ff</span><span style="color:#2aa198;font-weight:bold">8</span> <span style="color:#2aa198;font-weight:bold">77179f</span><span style="color:#268bd2">dc</span>):
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">call</span> <span style="color:#268bd2">to</span> <span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">CSQLSatelliteConnection</span>::<span style="color:#268bd2">OpenNpConnection</span> (<span style="color:#2aa198;font-weight:bold">00007ff</span><span style="color:#2aa198;font-weight:bold">8</span> <span style="color:#2aa198;font-weight:bold">7763</span><span style="color:#268bd2">c480</span>)
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">CUDXR_ExternalScript</span>::<span style="color:#268bd2">SetupService</span>+<span style="color:#2aa198;font-weight:bold">0x3ab</span> (<span style="color:#2aa198;font-weight:bold">00007ff</span><span style="color:#2aa198;font-weight:bold">8</span> <span style="color:#2aa198;font-weight:bold">7717</span><span style="color:#268bd2">a1eb</span>):
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">call</span> <span style="color:#268bd2">to</span> <span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">CSQLSatelliteConnection</span>::<span style="color:#268bd2">WriteMessage</span> (<span style="color:#2aa198;font-weight:bold">00007ff</span><span style="color:#2aa198;font-weight:bold">8</span> <span style="color:#2aa198;font-weight:bold">7763</span><span style="color:#268bd2">b140</span>)
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">CUDXR_ExternalScript</span>::<span style="color:#268bd2">SetupService</span>+<span style="color:#2aa198;font-weight:bold">0x3b5</span> (<span style="color:#2aa198;font-weight:bold">00007ff</span><span style="color:#2aa198;font-weight:bold">8</span> <span style="color:#2aa198;font-weight:bold">7717</span><span style="color:#268bd2">a1f5</span>):
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">call</span> <span style="color:#268bd2">to</span> <span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">CSQLSatelliteConnection</span>::<span style="color:#268bd2">FreePackets</span> (<span style="color:#2aa198;font-weight:bold">00007ff</span><span style="color:#2aa198;font-weight:bold">8</span> <span style="color:#2aa198;font-weight:bold">7763</span><span style="color:#268bd2">bc70</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 3:</strong> <em>Interesting Calls in SetupService</em></p>
<p>When looking at the call in <em>Code Snippet 3</em> we can see the <code>sqllang!CSQLSatelliteCommunication::Init</code> call. That is a call to initialize communication with the launchpad service. Then, somewhat later, there is an <code>OpenNpConnection</code> call. That call opens a named pipe connection to the launchpad service.</p>
<p>The <code>WriteMessage</code> call finally sends the message packet to the launchpad service, and <code>FreePackets</code> releases the message packet. To further see what is going on, let&rsquo;s trace what <code>WriteMessage</code> is doing.</p>
<p>If you are at a breakpoint right now, F5 out of there and then break into the debugger again, and set a breakpoint at <code>sqllang!CSQLSatelliteConnection::WriteMessage</code>. Execute your T-SQL code again and continue until you hit the breakpoint you just set. When you hit the breakpoint enter the trace command 

<a href="https://msdn.microsoft.com/en-us/library/windows/hardware/ff561497%28v=vs.85%29.aspx" target="_blank" rel="noopener"><code>wt</code></a>. This will now run through the whole function and display what is being called as well as statistics about how many times etc., routines were called. In the code snippet below I have chosen some of the more interesting calls:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#2aa198;font-weight:bold">0</span>:<span style="color:#2aa198;font-weight:bold">013</span>&gt; <span style="color:#268bd2">wt</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">Tracing</span> <span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">CSQLSatelliteConnection</span>::<span style="color:#268bd2">WriteMessage</span> <span style="color:#268bd2">to</span> <span style="color:#859900">return</span> <span style="color:#268bd2">address</span> <span style="color:#2aa198;font-weight:bold">00007ff</span><span style="color:#2aa198;font-weight:bold">8</span> <span style="color:#2aa198;font-weight:bold">7717</span><span style="color:#268bd2">a1f0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#2aa198;font-weight:bold">23</span>     <span style="color:#2aa198;font-weight:bold">0</span> [  <span style="color:#2aa198;font-weight:bold">0</span>] <span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">CSQLSatelliteConnection</span>::<span style="color:#268bd2">WriteMessage</span>
</span></span><span style="display:flex;"><span>   ...
</span></span><span style="display:flex;"><span>   <span style="color:#2aa198;font-weight:bold">30</span>   <span style="color:#2aa198;font-weight:bold">109</span> [  <span style="color:#2aa198;font-weight:bold">0</span>] <span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">CSQLSatelliteConnection</span>::<span style="color:#268bd2">WriteMessage</span>
</span></span><span style="display:flex;"><span>   <span style="color:#2aa198;font-weight:bold">26</span>     <span style="color:#2aa198;font-weight:bold">0</span> [  <span style="color:#2aa198;font-weight:bold">1</span>]   <span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">SNIWriteAsync</span>
</span></span><span style="display:flex;"><span>   <span style="color:#2aa198;font-weight:bold">21</span>     <span style="color:#2aa198;font-weight:bold">0</span> [  <span style="color:#2aa198;font-weight:bold">2</span>]     <span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">Np</span>::<span style="color:#268bd2">WriteAsync</span>
</span></span><span style="display:flex;"><span>   <span style="color:#2aa198;font-weight:bold">32</span>     <span style="color:#2aa198;font-weight:bold">0</span> [  <span style="color:#2aa198;font-weight:bold">3</span>]       <span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">Np</span>::<span style="color:#268bd2">SendPacketAsync</span>
</span></span><span style="display:flex;"><span>   <span style="color:#2aa198;font-weight:bold">30</span>     <span style="color:#2aa198;font-weight:bold">0</span> [  <span style="color:#2aa198;font-weight:bold">4</span>]         <span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">SNI</span>::<span style="color:#268bd2">detail</span>::<span style="color:#268bd2">Transport</span>::<span style="color:#268bd2">PrepareForAsyncCall</span>
</span></span><span style="display:flex;"><span>   <span style="color:#2aa198;font-weight:bold">40</span>    <span style="color:#2aa198;font-weight:bold">30</span> [  <span style="color:#2aa198;font-weight:bold">3</span>]       <span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">Np</span>::<span style="color:#268bd2">SendPacketAsync</span>
</span></span><span style="display:flex;"><span>    <span style="color:#2aa198;font-weight:bold">1</span>     <span style="color:#2aa198;font-weight:bold">0</span> [  <span style="color:#2aa198;font-weight:bold">4</span>]         <span style="color:#268bd2">KERNEL32</span>!<span style="color:#268bd2">WriteFile</span>
</span></span><span style="display:flex;"><span>   <span style="color:#2aa198;font-weight:bold">37</span>     <span style="color:#2aa198;font-weight:bold">0</span> [  <span style="color:#2aa198;font-weight:bold">4</span>]         <span style="color:#268bd2">KERNELBASE</span>!<span style="color:#268bd2">WriteFile</span>
</span></span><span style="display:flex;"><span>    <span style="color:#2aa198;font-weight:bold">6</span>     <span style="color:#2aa198;font-weight:bold">0</span> [  <span style="color:#2aa198;font-weight:bold">5</span>]           <span style="color:#268bd2">ntdll</span>!<span style="color:#268bd2">ZwWriteFile</span>
</span></span><span style="display:flex;"><span>   <span style="color:#2aa198;font-weight:bold">51</span>     <span style="color:#2aa198;font-weight:bold">6</span> [  <span style="color:#2aa198;font-weight:bold">4</span>]        ...
</span></span><span style="display:flex;"><span>   <span style="color:#2aa198;font-weight:bold">34</span>   <span style="color:#2aa198;font-weight:bold">230</span> [  <span style="color:#2aa198;font-weight:bold">1</span>]   <span style="color:#268bd2">sqllang</span>!<span style="color:#268bd2">SNIWriteAsync</span>
</span></span><span style="display:flex;"><span>   ...
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 4:</strong> <em>Tracing WriteMessage</em></p>
<p>In <em>Code Snippet 4</em> we see <code>WriteAsync</code>, <code>SendPacketAsync</code> and <code>WriteFile</code> is being called. At this stage, the packet has now been sent to the launchpad service. Before you let the process continue, disable the <code>WriteMessage</code> breakpoint, as it will be called when the result returns from R.</p>
<p>To make really sure that what we think happens actually happens we can do a last test, involving <em>Launchpad.exe</em>. In the next post in this series we will look at what happens in the launchpad service in more detail, but for now let us just do a simple test:</p>
<ul>
<li>Open a second instance of WinDbg and attach to the <em>Launchpad.exe</em> process.</li>
<li>Reload the launchpad symbols: <code>.reload -f launchpad.exe</code>.</li>
<li>Set a breakpoint like so: <code>bp launchpad!CLaunchContext::Launch</code></li>
<li>In the WinDbg instance for the SQL Server process set breakpoints at:
<ul>
<li>sqllang!CUDXR_ExternalScript::SetupService</li>
<li>sqllang!CSQLSatelliteConnection::WriteMessage</li>
<li>sqllang!CUDXR_ExternalScript::ConnectToSatellite</li>
</ul>
</li>
<li>Ensure that all other breakpoints for the SQL Server process are disabled</li>
<li>Make sure that both processes are running (i.e. not sitting in break mode).</li>
</ul>
<p>Execute the T-SQL code and notice what happens (you need to press F5 after hitting each breakpoint):</p>
<ul>
<li>You hit the breakpoint in the SQL Server process at <code>SetupService</code>.</li>
<li>You hit the breakpoint in the SQL Server process at <code>WriteMessage</code>.</li>
<li>You now hit the <code>Launch</code> breakpoint in the launchpad process.</li>
<li>You are back in the SQL Server process at the <code>ConnectToSatellite</code> breakpoint.</li>
</ul>
<p>After you have pressed F5 at the <code>ConnectToSatellite</code> breakpoint you will hit the <code>WriteMessage</code> breakpoint quite a few times when the result comes back from R.</p>
<h2 id="summary">Summary</h2>
<p><strong>UPDATE &amp; EDIT:</strong> To make the summary more &ldquo;readable&rdquo; I have added <em>Figure 10</em> and rearranged (and added) some text.</p>
<p>Through our &ldquo;spelunking&rdquo;, we have seen in somewhat detail what happens in the SQL Server engine when we execute <code>sp_execute_external_script</code>. <em>Figure 10</em> below shows from a very high level what goes on in the SQL Server engine:</p>
<p>
  <img src="/images/posts/sql-launchpad_post.png" alt="">

</p>
<p><strong>Figure 10:</strong> <em>Call Flow Executing sp_execute_external_script</em></p>
<p>Following the flow in <em>Figure 10</em>, when executing <code>sp_execute_external_script</code>:</p>
<ol>
<li>EXEC <code>sp_execute_external_script</code>.</li>
<li>Comes into the SQL Server process, and workers, schedulers, tasks, etc., comes into play.</li>
<li>Eventually <code>sqllang!CSQLSource::Execute</code> is called (first invocation - not the one shown in <em>Figure 9</em>).</li>
<li>Our friend <code>sqllang!SpExecuteExternalScript</code> is called.</li>
<li>The external script is opened in <code>sqllang!CUDXR_ExternalScript::Open</code>.</li>
<li>Things are hotting up and <code>sqllang!CUDXR_ExternalScript::SetupService</code> is hit.</li>
<li>A named pipe connection to the launchpad service is opened in <code>sqllang!CSQLSatelliteConnection::OpenNpConnection</code>.</li>
<li>A message containing the R scrips is written to the launchpad service in <code>sqllang!CSQLSatelliteConnection::WriteMessage</code>.</li>
<li>That message eventually ends up in the launchpad process in <code>launchpad!CLaunchContext::Launch</code>.</li>
</ol>
<p>In between the calls mentioned, a lot of other calls are also made, but from a high level - this is what happens.</p>
<p>If you have followed along, you can now go off and do your own &ldquo;spelunking&rdquo;. In next post in this series we will look at what happens in the launchpad service in more detail.</p>
<p>If you have comments, questions etc., please comment on this post or 

<a href="mailto:niels.it.berglund@gmail.com">ping</a> me.</p>

                

                
                <hr>
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/post/2017-03-12-interesting-stuff---week-10/" data-toggle="tooltip" data-placement="top" title="Interesting Stuff - Week 10">&larr;
                            Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/post/2017-03-19-interesting-stuff---week-11/" data-toggle="tooltip" data-placement="top" title="Interesting Stuff - Week 11">Next
                            Post &rarr;</a>
                    </li>
                    
                </ul>
                

                


<div id="disqus-comment"></div>
<div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "manageddata" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


            </div>

            
            
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
            

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                
                

                
                
            </div>
        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">                  
                    
                    <li>
                        <a href="mailto:niels.it.berglund@gmail.com">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		           
                    
                    <li>
                        <a href="https://twitter.com/nielsberglund">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    

		            
                    
                    
                    <li>
                        <a target="_blank" href="https://github.com/nielsberglund">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		            
                    
                    
                    
                    <li>
                        <a target="_blank" href="https://www.linkedin.com/in/niels-berglund-0122593">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		           
                    
                    <li>
                        <a target="_blank" href="https://medium.com/@nielsberglund">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-medium fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a target="_blank" href="https://stackoverflow.com/users/7656880/niels-berglund">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-stack-overflow fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    
                    <li>
                        <a target="_blank" href="https://fosstodon.org/@nielsb">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-mastodon fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
            
            
            
           
           <li>
             <a target="_blank" href="https://nielsberglund.com/index.xml">
                <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
                </span>
             </a>
           </li>
           
             </ul>
		<p class="copyright text-muted">
                    Copyright &copy; Niels Berglund 2026
                    <br>
                    <a href="https://themes.gohugo.io/hugo-theme-cleanwhite">CleanWhite Hugo Theme</a> by <a href="https://zhaohuabing.com">Huabing</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>




<script>
    function loadAsync(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        loadAsync("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>






<script type="text/javascript">
    function generateCatalog(selector) {

        
        
        
        
            _containerSelector = 'div.post-container'
        

        
        var P = $(_containerSelector), a, n, t, l, i, c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        
        $(selector).html('')

        
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#" + $(this).prop('id');
            t = $(this).text();
            c = $('<a href="' + i + '" rel="nofollow">' + t + '</a>');
            l = $('<li class="' + n + '_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    
    $(".catalog-toggle").click((function (e) {
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    


    loadAsync("\/js\/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>







<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ 
    startOnLoad: true,
    theme: 'default',
    securityLevel: 'loose'  
  });
</script>
</body>
</html>
