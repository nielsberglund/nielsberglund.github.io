<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <meta property="og:site_name" content="Niels Berglund">
    <meta property="og:type" content="article">

    
    <meta property="og:image" content="https://nielsberglund.com/images/banner/main-banner-2.jpg">
    <meta property="twitter:image" content="https://nielsberglund.com/images/banner/main-banner-2.jpg" />
    

    
    <meta name="title" content="Solve Python Issues in SQL Server Machine Learning Services After Deploying Python 3.9" />
    <meta property="og:title" content="Solve Python Issues in SQL Server Machine Learning Services After Deploying Python 3.9" />
    <meta property="twitter:title" content="Solve Python Issues in SQL Server Machine Learning Services After Deploying Python 3.9" />
    

    
    <meta name="description" content="We look at how we can solve Python issues in SQL server after having deployed a new Python language.">
    <meta property="og:description" content="We look at how we can solve Python issues in SQL server after having deployed a new Python language." />
    <meta property="twitter:description" content="We look at how we can solve Python issues in SQL server after having deployed a new Python language." />
    

    
    <meta property="twitter:card" content="summary" />
    
    

    <meta name="keyword"  content="SQL Server, .NET, Kafka, Streaming, Azure Data Explorer, AI/ML">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>Solve Python Issues in SQL Server Machine Learning Services After Deploying Python 3.9 | Niels Berglund</title>

    <link rel="canonical" href="/post/2021-01-09-solve-python-issues-in-sql-server-machine-learning-services-after-deploying-python-39/">

    
    
    
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="/css/hugo-theme-cleanwhite.min.css">

    
    <link rel="stylesheet" href="/css/zanshang.css">

    
    <link href="https://cdn.jsdelivr.net/gh/FortAwesome/Font-Awesome@5.15.1/css/all.css" rel="stylesheet" type="text/css">

    
    

    
    <script src="/js/jquery.min.js"></script>

    
    <script src="/js/bootstrap.min.js"></script>

    
    <script src="/js/hux-blog.min.js"></script>

    
    <script src="/js/lazysizes.min.js"></script>

    
    

</head>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-18914734-2', 'auto');
	
	ga('send', 'pageview');
}
</script>





<nav class="navbar navbar-default navbar-custom navbar-fixed-top">

    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Niels Berglund</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">All Posts</a>
                    </li>
                    
                    
		    
                        <li><a href="/series/">BLOG SERIES</a></li>
                    
                        <li><a href="/top/about/">ABOUT ME</a></li>
                    
                        <li><a href="/top/archive/">ARCHIVE</a></li>
                    
                        <li><a href="/top/disclaimer/">DISCLAIMER</a></li>
                    
		            <li>
                        <a href="/search"><i class="fa fa-search"></i></a>
		           </li>
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>




<style type="text/css">
    header.intro-header {
        background-image: url('/images/banner/main-banner-2.jpg')
    }
</style>

<header class="intro-header" >

    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/sql-server-machine-learning-services" title="SQL Server Machine Learning Services">
                            SQL Server Machine Learning Services
                        </a>
                        
                        <a class="tag" href="/tags/sql-server-2019" title="SQL Server 2019">
                            SQL Server 2019
                        </a>
                        
                        <a class="tag" href="/tags/python" title="Python">
                            Python
                        </a>
                        
                        <a class="tag" href="/tags/sql-server-extensibility-framework" title="SQL Server Extensibility Framework">
                            SQL Server Extensibility Framework
                        </a>
                        
                    </div>
                    <h1>Solve Python Issues in SQL Server Machine Learning Services After Deploying Python 3.9</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        
                            Posted by 
                            
                                nielsb
                             
                            on 
                            Saturday, January 9, 2021
                            
                            
                            
                            
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                
                <p>In September 2020, Microsoft open-sourced SQL Server Machine Learning Services, (SQLMLS), language extensions for R and Python. If you want more information, here are some blog posts I have written about it:</p>
<ul>
<li><a href="/post/2020-12-29-bring-your-own-r--python-runtimes-to-sql-server-extensibility-framework/"><strong>Bring Your Own R &amp; Python Runtimes to SQL Server Extensibility Framework</strong></a></li>
<li><a href="/post/2021-01-05-write-a-python-39-language-extension-for-sql-server-machine-learning-services/"><strong>Write a Python 3.9 Language Extension for SQL Server Machine Learning Services</strong></a></li>
</ul>
<p>In the <a href="/post/2021-01-05-write-a-python-39-language-extension-for-sql-server-machine-learning-services/">last post</a>, which looks at using Python 3.9 in SQL Server Machine Learning Services, I wrote this at the very end:</p>
<p><em>It looks like all is good, but maybe not? In a future post we&rsquo;ll look at an issue we have introduced - but for now, let us bask in the glory of having created a new Python language extension.</em></p>
<p>In the post, we wrote a new language extension to handle Python 3.9, and that just worked fine. However, when I was doing some other things, I noticed some side effects, and in this post, we look at those side effects and how to solve them.</p>
<blockquote>
<p><strong>NOTE:</strong> The two posts mentioned above has been updated as a result of this post. If you now follow the posts above you may not see the errors we discuss here.</p>
</blockquote>
<h2 id="pre-reqs">Pre-reqs</h2>
<p>Before we dive in, let us look at the pre-reqs (if you want to follow along).</p>
<p>In this post, I am not going into detail about language extensions and external languages and such. If you are unsure about this, please read the posts linked to above.</p>
<h4 id="environment-variables">Environment Variables</h4>
<p>If you followed along in post about Python 3.9 and created the <code>PYTHONHOME</code> environment variable, please delete it. After you have deleted it restart the <em>Launchpad</em> service for the SQL Server instance where you run the code.</p>
<h4 id="sql-server">SQL Server</h4>
<p>We need SQL Server CU3+ with <em>Machine Learning Services and Language Extensions</em> installed together with Python. Execution of external scripts needs to be enabled as well. You also need a database where to deploy the external languages to. In this post I use a database called <code>ExtLangDB</code>:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#268bd2">USE</span> <span style="color:#268bd2">Master</span>;
</span></span><span style="display:flex;"><span><span style="color:#859900">GO</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#859900">DROP</span> <span style="color:#859900">DATABASE</span> <span style="color:#859900">IF</span> <span style="color:#859900">EXISTS</span> <span style="color:#268bd2">ExtLangDB</span>;
</span></span><span style="display:flex;"><span><span style="color:#859900">GO</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#859900">CREATE</span> <span style="color:#859900">DATABASE</span> <span style="color:#268bd2">ExtLangDB</span>;
</span></span><span style="display:flex;"><span><span style="color:#859900">GO</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 1:</strong> <em>Create Database</em></p>
<p>Since in my previous posts I have used the same database name we see in <em>Code Snippet 1</em> we see how I drop the database if it exists before I create it. I do this to clear out any old &ldquo;cruft&rdquo; in the db.</p>
<blockquote>
<p><strong>NOTE:</strong> Above I say <em>Machine Learning Services and Language Extensions</em> installed together with Python. I mean that, during the installation of SQL and when you tick the box for <em>Machine Learning Services and Language Extensions</em>, you also choose Python. I refer to this as <em>PythonSQLMLS</em> - Python for SQL Server Machine Learning Services, the &ldquo;native&rdquo; Python.</p>
</blockquote>
<p>Let us make sure that everything looks OK in your database:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#268bd2">USE</span> <span style="color:#268bd2">ExtLangDB</span>;
</span></span><span style="display:flex;"><span><span style="color:#859900">GO</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#859900">SELECT</span> * <span style="color:#859900">FROM</span> <span style="color:#268bd2">sys</span>.<span style="color:#268bd2">EXTERNAL_LANGUAGES</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 2:</strong> <em>Make Sure All is OK</em></p>
<p>In <em>Code Snippet 2</em> we look for what external languages we have installed, and the result is like so:</p>
<p>
  <img src="/images/posts/fix-python-ext-langs.png" alt="">

</p>
<p><strong>Figure 1:</strong> <em>External Languages</em></p>
<p>OK, so according to <em>Figure 1</em> all seems OK in the database. We have both R, and Python outlined in red, installed as part of <em>Machine Learning Services and Language Extensions</em>.</p>
<p>The last thing we want to do related to SQL Server is to install Python 3.7.9, and Python 3.9.1 on the SQL Server box. Both installations need <code>pandas</code>, and Python needs to be added to the <code>PATH</code>, (root directory, and <code>.\Scripts</code> directory). The Python installations need to be done with administrator permissions: &ldquo;Run as administrator&rdquo;.</p>
<h4 id="language-extensions">Language Extensions</h4>
<p>We need the open-sourced Microsoft Python language extension, which you download from <a href="https://github.com/microsoft/sql-server-language-extensions/releases">here</a>, (click on &ldquo;Python language extension&rdquo;). As I mentioned in <a href="/post/2020-12-29-bring-your-own-r--python-runtimes-to-sql-server-extensibility-framework/">this post</a>, it supports Python 3.7.x. In the rest of this post, I call it the <em>Python37</em> extension.</p>
<p>We also need an extension for Python 3.9. You can follow my post <a href="/post/2021-01-05-write-a-python-39-language-extension-for-sql-server-machine-learning-services/">here</a>, and build it yourself. If you don&rsquo;t feel like building it, you can download the extension we built in the <a href="/post/2021-01-05-write-a-python-39-language-extension-for-sql-server-machine-learning-services/">post</a> in the previous sentence from <a href="/downloads/fixpython/python-lang-extension-windows-3.9.zip">here</a>. Going forward I call this extension <em>Python39</em>.</p>
<p>After downloading/building, place them in a location from where SQL Server can access them, and name them so you can see who is who.</p>
<h2 id="pythonsqlmls">PythonSQLMLS</h2>
<p>Let us make sure that the &ldquo;native&rdquo; Python, the one that comes as part of SQLMLS, (seen in <em>Figure 1</em>), works correctly in our database:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#859900">EXEC</span> <span style="color:#268bd2">sp_execute_external_script</span>
</span></span><span style="display:flex;"><span>@<span style="color:#859900">language</span> =<span style="color:#268bd2">N</span><span style="color:#2aa198">&#39;Python&#39;</span>,
</span></span><span style="display:flex;"><span>@<span style="color:#268bd2">script</span>=<span style="color:#268bd2">N</span><span style="color:#2aa198">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">import pandas as pd
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">import sys
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">df = pd.DataFrame(columns=[&#34;Version&#34;])
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">ver = sys.version
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">pth = sys.executable
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">df = df.append({&#34;Version&#34;: ver}, ignore_index=True)
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">OutputDataSet = df&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#859900">WITH</span> <span style="color:#859900">RESULT</span> <span style="color:#859900">SETS</span> (([<span style="color:#268bd2">Python</span> <span style="color:#859900">Version</span>] <span style="color:#268bd2">nvarchar</span>(<span style="color:#2aa198;font-weight:bold">256</span>)));
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 3:</strong> <em>Get Path &amp; Executable</em></p>
<p>The code we see in <em>Code Snippet 3</em> is the same as in the previous posts.</p>
<p>You see in <em>Code Snippet 3</em> how the <code>@language</code> parameter is set to <code>Python</code>. That indicates using the Python installed as part of <em>Machine Learning Services and Language Extensions</em> when we check the Python check-box, (<em>PythonSQLMLS</em>).</p>
<p>The result of running the code in <em>Code Snippet 3</em> is like so:</p>
<p>
  <img src="/images/posts/byor-r-and-p-python-version-l.png" alt="">

</p>
<p><strong>Figure 2:</strong> <em>Python SQLMLS</em></p>
<p>We see in <em>Figure 2</em> how the SQLMLS Python is version 3.7.1.</p>
<h2 id="python-37-as-language-extension">Python 3.7 as Language Extension</h2>
<p>We did the same as above in the <a href="/post/2020-12-29-bring-your-own-r--python-runtimes-to-sql-server-extensibility-framework/">Bring Your Own R &amp; Python Runtimes to SQL Server Extensibility Framework</a>, and we then continued with creating an external language from the <a href="https://github.com/microsoft/sql-server-language-extensions/releases">Microsoft Python language extension</a>:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#268bd2">USE</span> <span style="color:#268bd2">ExtLangDB</span>;
</span></span><span style="display:flex;"><span><span style="color:#859900">GO</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#859900">CREATE</span> <span style="color:#859900">EXTERNAL</span> <span style="color:#859900">LANGUAGE</span> <span style="color:#268bd2">p37</span>
</span></span><span style="display:flex;"><span><span style="color:#859900">FROM</span> (<span style="color:#268bd2">CONTENT</span> = <span style="color:#2aa198">&#39;W:\python-lang-extension-windows-3.7.zip&#39;</span>
</span></span><span style="display:flex;"><span>      , <span style="color:#268bd2">FILE_NAME</span> = <span style="color:#2aa198">&#39;pythonextension.dll&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#859900">GO</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 4:</strong> <em>Create Python 3.7 External Language</em></p>
<p>In <em>Code Snippet 4</em> we see how:</p>
<ul>
<li>we create an external language with the name of <code>p37</code>. We cannot use <code>Python</code> as it is a reserved word.</li>
<li>I renamed the Microsoft language extension to <code>python-lang-extension-windows-3.7.zip</code>.</li>
</ul>
<p>We check that the creation of <code>p37</code> succeeded by executing the code in <em>Code Snippet 2</em>. In the result, we should now see <code>p37</code> in addition to what we see in <em>Figure 1</em>.</p>
<p>When we see that we indeed have a new external language we:</p>
<ul>
<li>create a system environment variable <code>PYTHONHOME</code> pointing to the Python 3.7 install directory on the SQL box (in my case <code>C:\Python37</code>). This is required as per the <a href="https://docs.microsoft.com/en-us/sql/machine-learning/install/custom-runtime-python">Microsoft documentation</a>. We&rsquo;ll see later that this may not be required.</li>
<li>assign read and write permissions to the <em>Launchpad</em> server for the SQL Server instance and <code>ALL APPLICATIONS GROUP</code>. The permissions are given to the root directory and underlying files and directories of <code>PYTHONHOME</code>, (read more about assigning permissions in <a href="/post/2020-12-29-bring-your-own-r--python-runtimes-to-sql-server-extensibility-framework/">this post</a>).</li>
</ul>
<p>Having created the <code>PYTHONHOME</code> variable, we restart the <em>Launchpad</em> service. We are now ready to execute the code in <em>Code Snippet 3</em>, but we need to change the <code>@language</code> parameter to <code>p37</code> instead of <code>Python</code>.</p>
<p>The result we get back when executing the code should look like so:</p>
<p>
  <img src="/images/posts/byor-r-and-p-python-version-2.png" alt="">

</p>
<p><strong>Figure 3:</strong> <em>Python 3.7.9 External Language</em></p>
<p>Yay, we see from <em>Figure 3</em> how we now execute against Python 3.7.9 instead of 3.7.1. So yes, we are executing against another Python runtime than <em>PythonSQLMLS</em>.</p>
<p>If you get an error when you execute the code and the error looks something like this: &ldquo;A <!-- raw HTML omitted --> script error occurred during execution of &lsquo;sp_execute_external_script&rsquo; with HRESULT 0x80004004.&rdquo;, the most common causes for this are:</p>
<ul>
<li>Your Python installation is not on the <code>PATH</code>.</li>
<li>Permissions have not been set on the Python directories and files.</li>
</ul>
<p>Cool, we have now executed using a later version of the Python runtime than what is installed through SQLMLS. That&rsquo;s where we finished the <a href="/post/2020-12-29-bring-your-own-r--python-runtimes-to-sql-server-extensibility-framework/">Bring Your Own R &amp; Python Runtimes to SQL Server Extensibility Framework</a> post.</p>
<p>What we didn&rsquo;t do was to see what happens if we now want to run the code in <em>Code Snippet 3</em> and use <em>PythonSQLMLS</em>, (<code>@language=Python</code>):</p>
<p>
  <img src="/images/posts/fix-python-sqlmls-error1.png" alt="">

</p>
<p><strong>Figure 4:</strong> <em>Python Error - I</em></p>
<p>This.Is.Not.Good! We get a <code>ModuleNotFoundError</code>, as in <em>Figure 4</em>, and the module we cannot find is <code>revoscalepy</code>, which one of the proprietary Microsoft Python modules.</p>
<p>What we see here is one of the side effects I observed when doing my previous blog posts. We&rsquo;ll come back to this after looking at using the Python 3.9.1 runtime.</p>
<h2 id="python-39-as-language-extension">Python 3.9 as Language Extension</h2>
<p>In the <a href="/post/2021-01-05-write-a-python-39-language-extension-for-sql-server-machine-learning-services/">Write a Python 3.9 Language Extension for SQL Server Machine Learning Services</a> post we said that the Microsoft open-sourced language extension can only be used for Python 3.7.x. If we want to use another runtime, like 3.9.x, we need to re-compile the source code against the Python version we want to use. In the <a href="/post/2021-01-05-write-a-python-39-language-extension-for-sql-server-machine-learning-services/">post</a> we did that and saw how we executed against Python 3.9.1.</p>
<p>For Python 3.9.1, let us do what we did above with 3.7.9:</p>
<ul>
<li>create an external language. Let&rsquo;s call it <code>p39</code>, based on the extension for Python 3.9.1 I built, which is [here][].</li>
<li>change/create the <code>PYTHONHOME</code> variable to point to the Python 3.9 installation.</li>
<li>assign the necessary permissions against the root directory, subdirectories, and Python 3.9 installation files.</li>
<li>restart the <em>Launchpad</em> service.</li>
<li>change the @language parameter in <em>Code Snippet 3</em> to <code>@language=p39</code>.</li>
</ul>
<p>When we run the code, we see:</p>
<p>
  <img src="/images/posts/py39-ext-exec-success.png" alt="">

</p>
<p><strong>Figure 5:</strong> <em>Python Version</em></p>
<p>In <em>Figure 5</em> we see, as we did in the <a href="/post/2021-01-05-write-a-python-39-language-extension-for-sql-server-machine-learning-services/">Python 3.9 post</a>, how we get back Python 3.9.1. We are running against the Python 3.9 runtime. Awesome!</p>
<p>What happens if we now change back and execute with <code>@language=Python</code>, or <code>@language=p37</code>:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>STDERR message(s) from external script: 
</span></span><span style="display:flex;"><span>Fatal Python error: init_sys_streams: can<span style="color:#2aa198">&#39;t initialize 
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">sys standard streams Traceback (most recent call last): 
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">File &#34;C:\Python39\lib\io.py&#34;, line 54, in ImportError: 
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">cannot import name &#39;</span>open_code<span style="color:#2aa198">&#39; from &#39;</span>io&#39; (unknown location)
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 5:</strong> <em>Python Error - II</em></p>
<p>Once again - not good! As we see in <em>Code Snippet 5</em> we get a new error back saying something about not initialising something.</p>
<p>The question now is if this elated to Python in SQL Server only, or to Python in general on the SQL Server box?</p>
<h2 id="python-stand-alone">Python Stand-alone</h2>
<p>As Python 3.9 seems to work, let us just confirm that. From command prompt we <code>cd</code> into the Python 3.9 installation. For me, it looks like: <code>cd C:\Python39</code>.</p>
<p>In there, we execute:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>.<span style="color:#2aa198">\p</span>ython.exe -c <span style="color:#2aa198">&#34;import sys; print(sys.version);&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 6:</strong> *Execute Python 3.9 from Command Prompt&quot;</p>
<p>In <em>Code Snippet 6</em> we see how we want to execute some Python code that prints out the Python version we execute. When we run the code, we get back the same we see in <em>Figure 5</em>. So that works.</p>
<p>What about Python 3.7? We do the same:</p>
<ul>
<li><code>cd</code> into the Python 3.7 installation, (for me: <code>C:\Python37</code>).</li>
<li>execute the code in <em>Code Snippet 6</em>.</li>
</ul>
<p>Hmm, that - once again - does not look good:</p>
<p>
  <img src="/images/posts/fix-python-python37-error1.png" alt="">

</p>
<p><strong>Figure 6:</strong> <em>Python Error - III</em></p>
<p>We see in <em>Figure 6</em> how we get exactly the same error as in <em>Code Snippet 5</em>. What is going on here?</p>
<h2 id="pythonhome">PYTHONHOME</h2>
<p>A clue to the issue is highlighted in yellow in <em>Figure 6</em>: <code>File &quot;C:\Python39\lib\io.py&quot;</code>. We are executing against Python 3.7, but for some reason Python tries to touch a file in the Python 3.9 <code>lib</code> directory. Huh?</p>
<p>The culprit here is the <code>PYTHONHOME</code> system environment variable we created. We created it as the documentation around the Python language extension states it is required.</p>
<p>The <code>PYTHONHOME</code> system environment variable is a well known variable to the Python engine. The variable changes the location of the standard Python libraries. In the example where the variable was set to Python 3.9 and we executed against the Python 3.7 executable, Python tried to load files from the 3.9 installation. Now we have a version mismatch, and that&rsquo;s why we got the error.</p>
<p>In the <em>PythonSQLMLS</em> example where the variable was set to Python 3.7, we still got an error, why is that? In this case, the <em>PythonSQLMLS</em> runtime tried to load a Microsoft specific module that does not exist in the &ldquo;normal&rdquo; Python 3.7 runtime.</p>
<h2 id="solution">Solution</h2>
<p>How do we solve this? Well, above I say that the <code>PYTHONHOME</code> system environment variable is required. That is not entirely true. It is required if you want to create an external library for your language. If you only want to execute Python code, then you don&rsquo;t need it. Having Python on the <code>PATH</code> is required though in either case.</p>
<p>So to confirm that I am not lying, (too much), to you let&rsquo;s go ahead and:</p>
<ul>
<li>delete the <code>PYTHONHOME</code> system environment variable.</li>
<li>restart the <em>Launchpad</em> service.</li>
</ul>
<p>When we now execute the code in <em>Code Snippet 3</em> with the <code>@language</code> parameter being <code>Python</code>, <code>p37</code>, and <code>p39</code> respectively we see the expected result for all three executions!</p>
<p>But what do we do if we also want to create external libraries for for example Python 3.9, and at the same time in the database where we want to create the external library also need to execute <em>PythonSQLMLS</em> code?</p>
<p>In that case, we can not use <code>PYTHONHOME</code> as an environment variable, so we need to create a variable with a random name pointing to the Python extension.</p>
<p>Having done that we:</p>
<ul>
<li>go to the source code for the extension.</li>
<li>change the variable name in the method where it is used: <code>std::string PythonExtensionUtils::GetPathToPython()</code>. This is in the source file <code>PythonExtensionUtils_win.cpp</code>, (remember, I do this for SQL on Windows).</li>
<li>recompile the extension, and redeploy.</li>
</ul>
<p>In a future post, we will look more in detail at how to do this.</p>
<h2 id="summary">Summary</h2>
<p>This post came about as I saw strange errors after having deployed Python language extensions. Well, what I saw was that if I deployed a Python 3.7 extension, (<em>Python37</em>), I could not execute code with the &ldquo;native&rdquo; Python for SQL Server Machine Learning Services, (<em>PythonSQLMLS</em>). If I deployed an extension for Python 3.9, I could not execute code for either <em>PythonSQLMLS</em>, or <em>Python37</em>.</p>
<p>Based on the errors we received, we determined the issue was with the <code>PYTHONHOME</code> system environment variable. The official Microsoft documentation says this variable needs to be set for the Python extension. That requirement is only partially true, yes - it needs to be set if you want to create an external library for the language extension. However, if you just want to execute code, it is not needed.</p>
<blockquote>
<p><strong>NOTE:</strong> Something that is not entirely clear in the official documentation is that the Python installation needs to be on the <code>PATH</code> in either case.</p>
</blockquote>
<h2 id="-finally">~ Finally</h2>
<p>If you have comments, questions etc., please comment on this post or <a href="mailto:niels.it.berglund@gmail.com">ping</a> me.</p>

                

                
                <hr>
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/post/2021-01-05-write-a-python-39-language-extension-for-sql-server-machine-learning-services/" data-toggle="tooltip" data-placement="top" title="UPDATED: Write a Python 3.9 Language Extension for SQL Server Machine Learning Services">&larr;
                            Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/post/2021-01-10-interesting-stuff---week-2-2021/" data-toggle="tooltip" data-placement="top" title="Interesting Stuff - Week 2, 2021">Next
                            Post &rarr;</a>
                    </li>
                    
                </ul>
                

                


<div id="disqus-comment"></div>
<div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "manageddata" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>



            </div>

            
            
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
            

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                
                

                
                
            </div>
        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">                  
                    
                    <li>
                        <a href="mailto:niels.it.berglund@gmail.com">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		           
                    
                    <li>
                        <a href="https://twitter.com/nielsberglund">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    

		            
                    
                    
                    <li>
                        <a target="_blank" href="https://github.com/nielsberglund">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		            
                    
                    
                    
                    <li>
                        <a target="_blank" href="https://www.linkedin.com/in/niels-berglund-0122593">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		           
                    
                    <li>
                        <a target="_blank" href="https://medium.com/@nielsberglund">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-medium fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a target="_blank" href="https://stackoverflow.com/users/7656880/niels-berglund">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-stack-overflow fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    
                    <li>
                        <a target="_blank" href="https://fosstodon.org/@nielsb">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-mastodon fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
            
            
            
           
           <li>
             <a target="_blank" href="https://nielsberglund.com/index.xml">
                <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
                </span>
             </a>
           </li>
           
             </ul>
		<p class="copyright text-muted">
                    Copyright &copy; Niels Berglund 2024
                    <br>
                    <a href="https://themes.gohugo.io/hugo-theme-cleanwhite">CleanWhite Hugo Theme</a> by <a href="https://zhaohuabing.com">Huabing</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>




<script>
    function loadAsync(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        loadAsync("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>






<script type="text/javascript">
    function generateCatalog(selector) {

        
        
        
        
            _containerSelector = 'div.post-container'
        

        
        var P = $(_containerSelector), a, n, t, l, i, c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        
        $(selector).html('')

        
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#" + $(this).prop('id');
            t = $(this).text();
            c = $('<a href="' + i + '" rel="nofollow">' + t + '</a>');
            l = $('<li class="' + n + '_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    
    $(".catalog-toggle").click((function (e) {
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    


    loadAsync("\/js\/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>






</body>
</html>
