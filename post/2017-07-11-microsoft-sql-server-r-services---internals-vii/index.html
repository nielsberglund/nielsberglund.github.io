<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <meta property="og:site_name" content="Niels Berglund">
    <meta property="og:type" content="article">

    
    <meta property="og:image" content="https://nielsberglund.com//images/banner/main-banner-2.jpg">
    <meta property="twitter:image" content="https://nielsberglund.com//images/banner/main-banner-2.jpg" />
    

    
    <meta name="title" content="Microsoft SQL Server R Services - Internals VII" />
    <meta property="og:title" content="Microsoft SQL Server R Services - Internals VII" />
    <meta property="twitter:title" content="Microsoft SQL Server R Services - Internals VII" />
    

    
    <meta name="description" content="We look at the files and sub-directories created when executing sp_execute_external_script.">
    <meta property="og:description" content="We look at the files and sub-directories created when executing sp_execute_external_script." />
    <meta property="twitter:description" content="We look at the files and sub-directories created when executing sp_execute_external_script." />
    

    
    <meta property="twitter:card" content="summary" />
    
    

    <meta name="keyword"  content="SQL Server, .NET, Kafka, Streaming, Azure Data Explorer, AI/ML">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>Microsoft SQL Server R Services - Internals VII | Niels Berglund</title>

    <link rel="canonical" href="/post/2017-07-11-microsoft-sql-server-r-services---internals-vii/">

    
    
    
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="/css/hugo-theme-cleanwhite.min.css">

    
    <link rel="stylesheet" href="/css/zanshang.css">

    
    <link rel="stylesheet" href="/css/font-awesome.all.min.css">

    
    

    
    <script src="/js/jquery.min.js"></script>

    
    <script src="/js/bootstrap.min.js"></script>

    
    <script src="/js/hux-blog.min.js"></script>

    
    <script src="/js/lazysizes.min.js"></script>

    
    

    <script defer data-domain="nielsberglund.com" src="https://plausible.io/js/script.file-downloads.outbound-links.js"></script>

</head>








<nav class="navbar navbar-default navbar-custom navbar-fixed-top">

    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Niels Berglund</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">All Posts</a>
                    </li>
                    
                    
		    
                        <li><a href="/series//">BLOG SERIES</a></li>
                    
                        <li><a href="/top/about//">ABOUT ME</a></li>
                    
                        <li><a href="/top/archive//">ARCHIVE</a></li>
                    
                        <li><a href="/top/disclaimer//">DISCLAIMER</a></li>
                    
		            <li>
                        <a href="/search"><i class="fa fa-search"></i></a>
		           </li>
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>




<style type="text/css">
    header.intro-header {
        background-image: url('/images/banner/main-banner-2.jpg')
    }
</style>

<header class="intro-header" >

    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/sql-server-r-services" title="SQL Server R Services">
                            SQL Server R Services
                        </a>
                        
                        <a class="tag" href="/tags/sql-server-machine-learning-services" title="SQL Server Machine Learning Services">
                            SQL Server Machine Learning Services
                        </a>
                        
                        <a class="tag" href="/tags/r" title="R">
                            R
                        </a>
                        
                        <a class="tag" href="/tags/windbg" title="WinDbg">
                            WinDbg
                        </a>
                        
                        <a class="tag" href="/tags/launchpad" title="Launchpad">
                            Launchpad
                        </a>
                        
                        <a class="tag" href="/tags/rterm.exe" title="RTerm.exe">
                            RTerm.exe
                        </a>
                        
                        <a class="tag" href="/tags/process-monitor" title="Process Monitor">
                            Process Monitor
                        </a>
                        
                    </div>
                    <h1>Microsoft SQL Server R Services - Internals VII</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        
                            Posted by 
                            
                                nielsb
                             
                            on 
                            Tuesday, July 11, 2017
                            
                            
                            
                            
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                
                <p>(WOW, I finally managed to get this post out! Yay to me!!)</p>
<p>This is the eighth post in a series about <strong>Microsoft SQL Server R Services</strong>, and the seventh post that drills down into the internal of how it works. To see other posts (including this) in the series, go to 

<a href="/sql_server_2k16_r_services"><strong>SQL Server R Services</strong></a>.</p>
<p>In this post we will look more at some of the directories that are created when we execute <code>sp_execute_external_script</code>, as well as files being created in those directories.</p>
<h2 id="recap">Recap</h2>
<p>In previous posts(

<a href="/post/2017-04-02-microsoft-sql-server-r-services---internals-ii/">here</a>, 

<a href="/post/2017-04-13-microsoft-sql-server-r-services---internals-iii/">here</a>, 

<a href="/post/2017-04-23-microsoft-sql-server-r-services---internals-iv/">here</a> and 

<a href="/post/2017-05-01-microsoft-sql-server-r-services---internals-v/">here</a>) we have talked about how the launchpad service creates a number of <strong>RTerm</strong> processes when we execute an <code>sp_execute_external_script</code> request. The number of processes are configurable by the <code>PROCESS_POOL_SQLSATELLITE_GROWTH</code> setting in the <code>rlauncher.config</code> file, and by default 5 processes are created. These processes are added to a process pool, and when executing subsequent requests, or concurrent requests from different sessions, processes are picked up from the pool and used. At the same time new processes are created and added to the pool.</p>
<p>In the [Microsoft SQL Server R Services - Internals VI] 

<a href="/post/2017-05-16-microsoft-sql-server-r-services---internals-vi/">si6</a> post we talked about the directories that are created when executing <code>sp_execute_external_script</code>. We saw, when we execute the script, how (with a default <code>PROCESS_POOL_SQLSATELLITE_GROWTH</code> setting):</p>
<ul>
<li>Three directories are created initially, the first one being the directory for the session - this is the R working directory.</li>
<li>Then two processes, which will use the second and third directory.</li>
<li>Then one directory followed by one process, until we&rsquo;re done.</li>
</ul>
<p>From the above we understand that each process has a backing directory, and in the 

<a href="/post/2017-05-16-microsoft-sql-server-r-services---internals-vi/">post</a> we saw how the various directories had some files and sub-directories inside, as in <em>Figure 1 below</em>:</p>
<p>
  <img src="/images/posts/sql_r_services_6_dir_content.png" alt="">

</p>
<p><strong>Figure 1:</strong> <em>Directory Content</em></p>
<p>The figure above is from the 

<a href="/post/2017-05-16-microsoft-sql-server-r-services---internals-vi/">Internals - VI</a> post. In that post we could not really determine where the sub-directories came from. So in this post let us figure out what the created files are for, and from where the sub-directories originate (or at least let us try to figure it out).</p>
<h2 id="files">Files</h2>
<p>In various documentation of SQL Server R Services it is stated that the directories created during execution of <code>sp_execute_external_script</code> is to store files, intermediate results etc. We will run some code to see what files are created, but before that let&rsquo;s set things up to make life somewhat easier for us:</p>
<ol>
<li>Stop the launchpad service.</li>
<li>Delete any sub directories of the user account directories in the <code>C:\&lt;sql_instance_path&gt;\MSSQL\ExtensibilityData</code> directory. Do NOT delete the user account directories themselves.</li>
<li>Open the <code>rlauncher.config</code> file in a text editor and change the value of <code>JOB_CLEANUP_ON_EXIT</code> to 0, and save the file (you need to do this as admin).</li>
<li>Restart the launchpad service.</li>
</ol>
<blockquote>
<p><strong>NOTE:</strong> By setting the <code>JOB_CLEANUP_ON_EXIT</code> to 0 we tell the launchpad service to not delete any directories etc., after we have executed (the executing process will still be torn down though).</p>
</blockquote>
<p>The code we initially want to run is similar to what we ran in 

<a href="/post/2017-05-16-microsoft-sql-server-r-services---internals-vi/">Internals - VI</a>:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#859900">EXEC</span> <span style="color:#268bd2">sp_execute_external_script</span>  @<span style="color:#859900">language</span> =<span style="color:#268bd2">N</span><span style="color:#2aa198">&#39;R&#39;</span>,
</span></span><span style="display:flex;"><span>                                 @<span style="color:#268bd2">script</span>=<span style="color:#268bd2">N</span><span style="color:#2aa198">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">                                 pid &lt;- Sys.getpid()
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">                                 d &lt;- getwd()
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">                                 cat(paste0(&#34;ProcessId: &#34;, pid))
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">                                 cat(&#34;\n&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">                                 cat(paste0(&#34;WorkDir: &#34;, d))
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">                                 cat(&#34;\n&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">                                 OutputDataSet&lt;-data.frame(ProcessId=pid,WorkingDir=d)&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#859900">WITH</span> <span style="color:#859900">RESULT</span> <span style="color:#859900">SETS</span> ((<span style="color:#268bd2">ProcessID</span> <span style="color:#cb4b16">int</span>, [<span style="color:#268bd2">WorkingDirectory</span>] <span style="color:#268bd2">nvarchar</span>(<span style="color:#2aa198;font-weight:bold">1024</span>) <span style="color:#859900">not</span> <span style="color:#859900">null</span>));
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 1:</strong> <em>External Script</em></p>
<p>As you see in <em>Code Snippet 1</em>, the R script captures information about the process id we execute under as well as the working directory. It uses the <code>cat</code> function to output the data, the question is where it outputs it to? Normally <code>cat</code> would output to the standard output connection, the console, if no file name has been given as argument. So let us see what happens when we execute the code.</p>
<p>In SQL Server Management Studio (SSMS) - under the <em>Results</em> tab, I get the returning result set containing the process id as well as the working directory path. Under the <em>Messages</em> tab I get something like what is shown in <em>Figure 2</em> below:</p>
<p>
  <img src="/images/posts/sql_r_services_7_output1.png" alt="">

</p>
<p><strong>Figure 2:</strong> <em>Output from R Script</em></p>
<p>So that is the result from the <code>cat</code> function. This makes sense as we can see the <em>Messages</em> tab as something like a console. But is the output from <code>cat</code> anywhere else? Let&rsquo;s go and have a look in the user account directory in <code>C:\&lt;sql_instance_path&gt;\MSSQL\ExtensibilityData</code>, and the specific account used when executing the script. It is most likely <em>MSSQLSERVER01</em> if you execute from a default instance, but if you are unsure you can have a look at the output from the script and the value for the working directory. Just before the <code>Guid</code> value is the name of the account used.</p>
<p>When we look under the user account directory, we&rsquo;ll see multiple directories, all with a <code>Guid</code> like string as name. As we covered in previous posts, these directories are the backing directories for the processes created. When you look through these directories you&rsquo;ll see (as we said in 

<a href="/post/2017-05-16-microsoft-sql-server-r-services---internals-vi/">Internals VI</a>), that most of the directories look the same; they have one subdirectory and 3 files. There are however two directories that are somewhat different; one is empty, and that is the working directory, and one that has four files in it. The one directory with four files in it is the directory for the process the code executed under (I call it process directory), and when you look in that directory you see something like so:</p>
<p>
  <img src="/images/posts/sql_r_services_7_outputdir.png" alt="">

</p>
<p><strong>Figure 3:</strong> <em>Contents Process Directory</em></p>
<p>As you see in <em>Figure 3</em> there are two <code>.txt</code> files in the directory, and we can see (from the Size), that it looks like the <code>stdout0.txt</code> has some content. When you open the <code>stdout0.txt</code> file you see how it contains the output from the <code>cat</code> calls in the script. If there had been errors during script execution, the errors would have been written to the <code>stderr0.txt</code> file.</p>
<p>OK, so that is the <code>stdout.txt</code> and `stderr.txt files - what about the other two files:</p>
<ul>
<li><code>7F73C367-0684-4B89-9DA7-86BEEA362FD2.R</code></li>
<li><code>Rscriptae84173870</code></li>
</ul>
<blockquote>
<p><strong>NOTE:</strong> The filenames above are what I see on my machine. If you run this, your filenames will most definitely be different.</p>
</blockquote>
<p>Let&rsquo;s start with the R file, which looks something like so (paths made short):</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#268bd2">library</span>(<span style="color:#268bd2">RevoScaleR</span>); 
</span></span><span style="display:flex;"><span><span style="color:#268bd2">rxIgnoreResult</span> &lt;- <span style="color:#268bd2">.Call</span>(<span style="color:#2aa198">&#39;RxSqlSatelliteCall&#39;</span>, 
</span></span><span style="display:flex;"><span>          <span style="color:#268bd2">list</span>(<span style="color:#268bd2">sessionId</span>=<span style="color:#2aa198">&#39;1C49FD9B-BA79-4C1E-993B-E04669259CD8&#39;</span>, 
</span></span><span style="display:flex;"><span>               <span style="color:#268bd2">taskId</span>=<span style="color:#2aa198;font-weight:bold">0</span>, 
</span></span><span style="display:flex;"><span>               <span style="color:#268bd2">port</span>=<span style="color:#2aa198;font-weight:bold">51318</span>, 
</span></span><span style="display:flex;"><span>               <span style="color:#268bd2">logPath</span>=<span style="color:#2aa198">&#39;&#39;</span>, 
</span></span><span style="display:flex;"><span>               <span style="color:#268bd2">pipeName</span>=<span style="color:#2aa198">&#39;DataSet1_1Col_Int_1Row&#39;</span>, 
</span></span><span style="display:flex;"><span>               <span style="color:#268bd2">sqlSatellitePath</span>=<span style="color:#2aa198">&#39;C:\\&lt;sql_inst_binn_path&gt;\\
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">                                  sqlsatellite.dll&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#268bd2">errorToStdError</span>=<span style="color:#268bd2">T</span>));
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 2:</strong> <em>R File Set Up Satellite Connection</em></p>
<p>This file only exists in the process directory, and the file is used to establish a named pipe connection with the SQL Satellite (we&rsquo;ll cover SQL Satellite in future posts). As we see in <em>Code Snippet 2</em>, the script:</p>
<ul>
<li>Loads the <code>RevoScaleR </code> package</li>
<li>Executes the <code>.Call</code> function to call into a method named <code>RxSqlSatelliteCall</code>, and sends in some arguments for that method.</li>
</ul>
<blockquote>
<p><strong>NOTE:</strong> The <code>.Call</code> function in R is used to call into C/C++ code.</p>
</blockquote>
<p>The arguments sent in to the method are for:</p>
<ul>
<li>What port to use for then named pipe connection.</li>
<li>Name of the named pipe.</li>
<li>The path to where the SQL Satellite is.</li>
</ul>
<p>What uses this file? Well, take a look at the <code>Rscriptae84173870</code> file, it looks something like so (once again paths shortened):</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#268bd2">library</span>(<span style="color:#268bd2">RevoScaleR</span>); 
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sessionDirectory</span> &lt;- 
</span></span><span style="display:flex;"><span><span style="color:#2aa198">&#39;C:\\&lt;sql_inst_ext_data_path&gt;\\
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">     MSSQLSERVER01\\7F73C367-0684-4B89-9DA7-86BEEA362FD2&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#268bd2">sessionId</span> &lt;- <span style="color:#2aa198">&#39;7F73C367-0684-4B89-9DA7-86BEEA362FD2&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#268bd2">scriptFile</span> &lt;- <span style="color:#268bd2">file.path</span>(<span style="color:#268bd2">sessionDirectory</span>, 
</span></span><span style="display:flex;"><span>                        <span style="color:#268bd2">paste</span>(<span style="color:#268bd2">sessionId</span>, <span style="color:#2aa198">&#39;.R&#39;</span>, <span style="color:#268bd2">sep</span>=<span style="color:#2aa198">&#39;&#39;</span>));
</span></span><span style="display:flex;"><span><span style="color:#268bd2">rxIgnoreCallResult</span> &lt;- <span style="color:#268bd2">.Call</span>(<span style="color:#2aa198">&#39;RxSqlSessionStart&#39;</span>, 
</span></span><span style="display:flex;"><span>                   <span style="color:#268bd2">list</span>(<span style="color:#268bd2">sessionDirectory</span>=<span style="color:#268bd2">sessionDirectory</span>, 
</span></span><span style="display:flex;"><span>                        <span style="color:#268bd2">sessionId</span>=<span style="color:#268bd2">sessionId</span>, 
</span></span><span style="display:flex;"><span>                        <span style="color:#268bd2">waitTime</span>=<span style="color:#2aa198;font-weight:bold">-1</span>));
</span></span><span style="display:flex;"><span><span style="color:#268bd2">source</span>(<span style="color:#268bd2">scriptFile</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 3:</strong> <em>Session Start</em></p>
<p>Ah, looking at the code in <em>Code Snippet 3</em>, we see how that code actually:</p>
<ul>
<li>Loads the <code>RevoScaleR</code> package.</li>
<li>Defines the directory for the executing process</li>
<li>Creates a <code>scriptFile</code> argument, pointing to the file in <em>Code Snippet 2</em>.</li>
<li>Starts the process.</li>
<li>Calls the file from <em>Code Snippet 2</em> in the <code>source</code> call.</li>
</ul>
<p>The result of the code in <em>Code Snippet 2</em> and <em>Code Snippet 3</em> is that after execution a named pipe connection has been made to the SQL Satellite dll, and as I said above - we&rsquo;ll cover the SQL Satellite in a subsequent blog-post.</p>
<h2 id="files--sub-directory-origins">Files &amp; Sub-directory Origins</h2>
<p>Above we saw (at least kind of), what the files inside the process directory do. What about the sub directory that exist in all backing directories, what does that do, and where does it come from? Remember from the 

<a href="/post/2017-05-16-microsoft-sql-server-r-services---internals-vi/">Internals - VI</a> post that we said that when we were using <strong>WinDbg</strong> and had break point at <code>KERNELBASE!CreateDirectoryW</code> we couldn&rsquo;t see the sub-directory being created.</p>
<p>There is also a question about who is creating the files that we have just discussed. The obvious answer would be that it is the launchpad service together with the <code>rlauncher.dll</code> that create the files. Let&rsquo;s try and prove that.</p>
<p>So, to set things up:</p>
<ol>
<li>Stop the launchpad service.</li>
<li>Delete any sub directories of the user account directories in the <code>C:\&lt;sql_instance_path&gt;\MSSQL\ExtensibilityData</code> directory. Do NOT delete the user account directories themselves.</li>
<li>Restart the launchpad service.</li>
</ol>
<p>This time we will use 

<a href="https://technet.microsoft.com/en-us/sysinternals/processmonitor.aspx" target="_blank" rel="noopener"><em>Process Monitor</em></a> from <strong>Sysinternals</strong> instead of WinDbg, as it will be easier to see what files (and directories) are created and by whom.</p>
<blockquote>
<p><strong>NOTE:</strong> Process Monitor is an advanced monitoring tool for Windows that shows real-time file system, Registry and process/thread activity.</p>
</blockquote>
<p>When you run Process Monitor you will see that it monitors (and logs) a LOT on the machine you run it on:</p>
<p>
  <img src="/images/posts/sql_r_services_7_procmon1.png" alt="">

</p>
<p><strong>Figure 4:</strong> <em>Process Monitor Start Up</em></p>
<p>In <em>Figure 4</em> you see output from Process Monitor right after startup on my machine. In order to get something useful out of what we see, we need to filter out events, or rather say what events we are interested in. We&rsquo;ll start with suppressing event monitoring to begin with, as well as not choosing to see events of certain types:</p>
<p>
  <img src="/images/posts/sql_r_services_7_procmon2.png" alt="">

</p>
<p><strong>Figure 5:</strong> <em>Suppress Event Collection</em></p>
<p>In <em>Figure 5</em> we see the tool-bar of Process Monitor, and how we have paused capturing of events by clicking on the magnifying glass (in the first outlined box). We also have chosen not to receive any events related to registry, network and profiling activity (the second outlined box).</p>
<p>Now we are ready to start to define the events we are interested in, and we do that using the <em>Filter</em> menu. We start with resetting the filters:</p>
<p>
  <img src="/images/posts/sql_r_services_7_procmon_reset_filter.png" alt="">

</p>
<p><strong>Figure 6:</strong> <em>Reset Process Monitor&rsquo;s Filters</em></p>
<p>When you reset the filters, sometimes event capturing will be enabled again. If it is, just disable it once more. Now is probably a good time to clear out the captured events at startup, so under the <em>Edit</em> menu click <em>Clear Display</em>. Having reset the filters and cleared out the display, we can now create a filter to use, to capture the events we are interested in. So, what are we interested in?</p>
<p>Well, we would like to see what files are being created under the subdirectories of the user account you will execute your R script under. For me it is: <code>C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\ExtensibilityData\MSSQLSERVER01</code>, and this will be the starting point for a filter to filter out events.</p>
<p>To create a filter, under the <em>Filter</em> menu click the Filter menu item, and the &ldquo;Process Monitor Filter&rdquo; dialog will be shown:</p>
<p>
  <img src="/images/posts/sql_r_services_7_procmon_filter_dialog.png" alt="">

</p>
<p><strong>Figure 7:</strong> <em>Process Monitor Filter Dialog</em></p>
<p>To create the filter we enter the conditions we want to match:</p>
<ul>
<li>The <em>Path</em> (from first drop down) should <em>begins with</em> (from second drop down): <code>C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\ExtensibilityData\MSSQLSERVER01</code>.</li>
<li><em>Operation</em> (first drop down) <em>is</em> (second drop down): <code>CreateFile</code></li>
</ul>
<p>Both of those conditions should be <em>Include</em>:ed and <em>Add</em>:ed. At the end the filter looks like so:</p>
<p>
  <img src="/images/posts/sql_r_services_7_procmon_filter_create.png" alt="">

</p>
<p><strong>Figure 8:</strong> <em>Filter Created</em></p>
<p>You click <em>OK</em>, and you are ready to roll:</p>
<ol>
<li>Re-enable capturing of events in Process Monitor</li>
<li>Execute the code in <em>Code Snippet 2</em></li>
<li>After executing the code, disable the capturing of events again in Process Monitor</li>
</ol>
<p>Process Monitor now shows quite a few events:</p>
<p>
  <img src="/images/posts/sql_r_services_7_procmon_capured_events.png" alt="">

</p>
<p><strong>Figure 9:</strong> <em>Captured Create File Events</em></p>
<p>Let&rsquo;s go back to the user account and find the backing directory for the process, as - at the moment - we are only interested in what happens in that directory. In my case it is <code>1EB243A4-AE41-4DBD-A315-44B52EECF4B9</code>. To make it easier to see what happens in Process Monitor, we can change the filter somewhat:</p>
<ul>
<li>In the <em>Path</em> column in Process Monitor right click on the first occurrence of the path including the process directory, and click <em>Copy</em>:</li>
</ul>
<p>
  <img src="/images/posts/sql_r_services_7_procmon_find_path.png" alt="">

</p>
<p><strong>Figure 10:</strong> <em>Copying the Path</em></p>
<p>Then open the Filter dialog and:</p>
<ul>
<li>Remove the filter condition for the <em>Path</em>. That will cause the condition to be entered into the condition fields:</li>
</ul>
<p>
  <img src="/images/posts/sql_r_services_7_procmon_remove_filter.png" alt="">

</p>
<p><strong>Figure 11:</strong> <em>After Remove Condition</em></p>
<ul>
<li>In the conditions field enter the path to your process directory (the one you copied above).</li>
<li>Click <em>Add</em>, <em>Apply</em>, and <em>OK</em>.</li>
</ul>
<p>The number of events displayed should now have been reduced significantly. For me it went from 265 events captured to 53.</p>
<p>Now we can see how the launchpad service creates the <code>stdout0.txt</code>, and <code>stderr0.txt</code> files together with the <code>.R</code> file (the image is cropped):</p>
<p>
  <img src="/images/posts/sql_r_services_7_procmon_launchpad_create_file2.png" alt="">

</p>
<p><strong>Figure 12:</strong> **</p>
<p>However, the <code>Rscriptxxx</code> file is not created by the launchpad service, but by <code>RTerm.exe</code>:</p>
<p>
  <img src="/images/posts/sql_r_services_7_procmon_rterm.png" alt="">

</p>
<p><strong>Figure 13:</strong> <em>RTerm Creating Files and Directories</em></p>
<p>In <em>Figure 13</em> we also see how - in addition to the Rscript file - a directory <code>Rtmp0AHI82</code> is created, and inside that directory a file <code>file5f446ae7ae6</code> is created. That particular file is not persisted regardless of the setting of <code>JOB_CLEANUP_ON_EXIT</code>. I have not been able to figure out - yet - what that file contains, so if anyone out there knows, please let me know.</p>
<h2 id="summary">Summary</h2>
<p>In this post we have seen how:</p>
<ul>
<li>Output from R script (errors and print) are written to files in the processing directory by the launchpad service.</li>
<li>The launchpad service also writes a script to establish a named piped connection to the SQL Satellite dll.</li>
<li>The <code>Rterm.exe</code> writes a script that starts a session, and <code>source</code>:s the script file mentioned above.</li>
<li>In addition to the session script, <code>Rterm.exe</code> also creates a sub directory together with a file. The file is not persisted.</li>
</ul>
<h2 id="-finally">~ Finally</h2>
<p>First of all, if you have any insight in the files <code>Rterm.exe</code> creates, please get in touch! Otherwise, if you have comments, questions etc., please comment on this post or 

<a href="mailto:niels.it.berglund@gmail.com">ping</a> me.</p>

                

                
                <hr>
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/post/2017-07-09-interesting-stuff---week-27/" data-toggle="tooltip" data-placement="top" title="Interesting Stuff - Week 27">&larr;
                            Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/post/2017-07-16-interesting-stuff---week-28/" data-toggle="tooltip" data-placement="top" title="Interesting Stuff - Week 28">Next
                            Post &rarr;</a>
                    </li>
                    
                </ul>
                

                


<div id="disqus-comment"></div>
<div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "manageddata" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


            </div>

            
            
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
            

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                
                

                
                
            </div>
        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">                  
                    
                    <li>
                        <a href="mailto:niels.it.berglund@gmail.com">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		           
                    
                    <li>
                        <a href="https://twitter.com/nielsberglund">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    

		            
                    
                    
                    <li>
                        <a target="_blank" href="https://github.com/nielsberglund">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		            
                    
                    
                    
                    <li>
                        <a target="_blank" href="https://www.linkedin.com/in/niels-berglund-0122593">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		           
                    
                    <li>
                        <a target="_blank" href="https://medium.com/@nielsberglund">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-medium fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a target="_blank" href="https://stackoverflow.com/users/7656880/niels-berglund">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-stack-overflow fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    
                    <li>
                        <a target="_blank" href="https://fosstodon.org/@nielsb">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-mastodon fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
            
            
            
           
           <li>
             <a target="_blank" href="https://nielsberglund.com/index.xml">
                <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
                </span>
             </a>
           </li>
           
             </ul>
		<p class="copyright text-muted">
                    Copyright &copy; Niels Berglund 2025
                    <br>
                    <a href="https://themes.gohugo.io/hugo-theme-cleanwhite">CleanWhite Hugo Theme</a> by <a href="https://zhaohuabing.com">Huabing</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>




<script>
    function loadAsync(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        loadAsync("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>






<script type="text/javascript">
    function generateCatalog(selector) {

        
        
        
        
            _containerSelector = 'div.post-container'
        

        
        var P = $(_containerSelector), a, n, t, l, i, c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        
        $(selector).html('')

        
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#" + $(this).prop('id');
            t = $(this).text();
            c = $('<a href="' + i + '" rel="nofollow">' + t + '</a>');
            l = $('<li class="' + n + '_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    
    $(".catalog-toggle").click((function (e) {
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    


    loadAsync("\/js\/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>






</body>
</html>
