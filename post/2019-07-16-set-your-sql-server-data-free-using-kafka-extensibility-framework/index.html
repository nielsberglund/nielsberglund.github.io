<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <meta property="og:site_name" content="Niels Berglund">
    <meta property="og:type" content="article">

    
    <meta property="og:image" content="https://nielsberglund.com//images/banner/main-banner-2.jpg">
    <meta property="twitter:image" content="https://nielsberglund.com//images/banner/main-banner-2.jpg" />
    

    
    <meta name="title" content="Set Your SQL Server Data Free with Kafka: Extensibility Framework" />
    <meta property="og:title" content="Set Your SQL Server Data Free with Kafka: Extensibility Framework" />
    <meta property="twitter:title" content="Set Your SQL Server Data Free with Kafka: Extensibility Framework" />
    

    
    <meta name="description" content="In this post we look at how we use Java to send data from SQL Server to Kafka.">
    <meta property="og:description" content="In this post we look at how we use Java to send data from SQL Server to Kafka." />
    <meta property="twitter:description" content="In this post we look at how we use Java to send data from SQL Server to Kafka." />
    

    
    <meta property="twitter:card" content="summary" />
    
    

    <meta name="keyword"  content="SQL Server, .NET, Kafka, Streaming, Azure Data Explorer, AI/ML">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>Set Your SQL Server Data Free with Kafka: Extensibility Framework | Niels Berglund</title>

    <link rel="canonical" href="/post/2019-07-16-set-your-sql-server-data-free-using-kafka-extensibility-framework/">

    
    
    
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="/css/hugo-theme-cleanwhite.min.css">

    
    <link rel="stylesheet" href="/css/zanshang.css">

    
    <link rel="stylesheet" href="/css/font-awesome.all.min.css">

    
    

    
    <link rel="stylesheet" href="/css/niels-styles.css">
    <link rel="stylesheet" href="/css/niels-styles2.css">

    
    <script src="/js/jquery.min.js"></script>

    
    <script src="/js/bootstrap.min.js"></script>

    
    <script src="/js/hux-blog.min.js"></script>

    
    <script src="/js/lazysizes.min.js"></script>

    
    

    <script defer data-domain="nielsberglund.com" src="https://plausible.io/js/script.file-downloads.outbound-links.js"></script>

</head>






<nav class="navbar navbar-default navbar-custom navbar-fixed-top">

    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Niels Berglund</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">All Posts</a>
                    </li>
                    
                    
		    
                        <li><a href="/series//">BLOG SERIES</a></li>
                    
                        <li><a href="/top/about//">ABOUT ME</a></li>
                    
                        <li><a href="/top/archive//">ARCHIVE</a></li>
                    
                        <li><a href="/top/disclaimer//">DISCLAIMER</a></li>
                    
		            <li>
                        <a href="/search"><i class="fa fa-search"></i></a>
		           </li>
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>




<style type="text/css">
    header.intro-header {
        background-image: url('/images/banner/main-banner-2.jpg')
    }
</style>

<header class="intro-header" >

    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/kafka" title="Kafka">
                            Kafka
                        </a>
                        
                        <a class="tag" href="/tags/sql-server-2019" title="SQL Server 2019">
                            SQL Server 2019
                        </a>
                        
                        <a class="tag" href="/tags/r" title="R">
                            R
                        </a>
                        
                        <a class="tag" href="/tags/python" title="Python">
                            Python
                        </a>
                        
                        <a class="tag" href="/tags/java" title="Java">
                            Java
                        </a>
                        
                        <a class="tag" href="/tags/sql-server-extensibility-framework" title="SQL Server Extensibility Framework">
                            SQL Server Extensibility Framework
                        </a>
                        
                    </div>
                    <h1>Set Your SQL Server Data Free with Kafka: Extensibility Framework</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        
                            Posted by 
                            
                                nielsb
                             
                            on 
                            Tuesday, July 16, 2019
                            
                            
                            
                            
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                
                <p>As many of you may know, (or not), is that my background is SQL Server. Ever since I started programming, SQL Server has been my &ldquo;trusty companion&rdquo;, and my belief is that if you don&rsquo;t have SQL Server as a backend, then there is something wrong. At work, (

<a href="/derivco">Derivco</a>), it is the same thing, and we are jokingly saying that we do not have business logic in the database, we have full-blown applications!</p>
<p>However, both me personally and at work, we do realise the value of streaming data; for real-time processing as well as to distribute data without having to rely on replication. In the ideal world, we would change the applications/systems that are the source of the data to both publish the data as event streams as well as persisting the data to the database. However, it may not be possible to change those applications/systems - at least not in the time frame we would like. So what we want to do is to use the database as the source of the data, but treat the data, not as rows in a database but, as streaming events.</p>
<p>This is the first post in a &ldquo;mini&rdquo; series where we look at how we can do what is outlined above. In this post, we look at how to use the <strong>SQL Server Extensibility Framework</strong>, and more specifically the Java language extension to solve the issue.</p>
<blockquote>
<p><strong>NOTE:</strong> What we do in this post requires SQL Server 2019 CTP 3.0+.</p>
</blockquote>
<h2 id="scenario--code">Scenario &amp; Code</h2>
<p>In this post, we look at a scenario somewhat like what we have at 

<a href="/derivco">Derivco</a>. We have online Casino gameplay where the user, (player), plays Casino games, (slots, table games, etc.), on his PC, tablet or mobile. The game play is persisted to a SQL Server database:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#268bd2">USE</span> <span style="color:#268bd2">master</span>;
</span></span><span style="display:flex;"><span><span style="color:#859900">GO</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#859900">DROP</span> <span style="color:#859900">DATABASE</span> <span style="color:#859900">IF</span> <span style="color:#859900">EXISTS</span> <span style="color:#268bd2">GamePlayDB</span>;
</span></span><span style="display:flex;"><span><span style="color:#859900">GO</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#859900">CREATE</span> <span style="color:#859900">DATABASE</span> <span style="color:#268bd2">GamePlayDB</span>;
</span></span><span style="display:flex;"><span><span style="color:#859900">GO</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">USE</span> <span style="color:#268bd2">GamePlayDB</span>;
</span></span><span style="display:flex;"><span><span style="color:#859900">GO</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#859900">CREATE</span> <span style="color:#859900">TABLE</span> <span style="color:#268bd2">dbo</span>.<span style="color:#268bd2">tb_GamePlay</span>
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">RowID</span> <span style="color:#cb4b16">bigint</span> <span style="color:#859900">identity</span> <span style="color:#859900">PRIMARY</span> <span style="color:#859900">KEY</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">UserID</span> <span style="color:#cb4b16">int</span> <span style="color:#859900">NOT</span> <span style="color:#859900">NULL</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">GameID</span> <span style="color:#cb4b16">int</span> <span style="color:#859900">NOT</span> <span style="color:#859900">NULL</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">WagerAmount</span> <span style="color:#cb4b16">decimal</span>(<span style="color:#2aa198;font-weight:bold">10</span>, <span style="color:#2aa198;font-weight:bold">2</span>) <span style="color:#859900">NOT</span> <span style="color:#859900">NULL</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">PayoutAmount</span> <span style="color:#cb4b16">decimal</span>(<span style="color:#2aa198;font-weight:bold">10</span>, <span style="color:#2aa198;font-weight:bold">2</span>) <span style="color:#859900">NOT</span> <span style="color:#859900">NULL</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">EventTime</span> <span style="color:#268bd2">datetime2</span> <span style="color:#859900">NOT</span> <span style="color:#859900">NULL</span>
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span><span style="color:#859900">GO</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 1:</strong> <em>Game Play Database</em></p>
<p>In <em>Code Snippet 1</em> we see some SQL code which creates:</p>
<ul>
<li>The database <code>GamePlayDB</code>.</li>
<li>A table, <code>dbo.tb_GamePlay</code>, to persist each outcome of a spin, hand, etc.</li>
</ul>
<blockquote>
<p><strong>NOTE:</strong> The code is as simple it can be, this to concentrate on the important parts.</p>
</blockquote>
<p>When the player spins, etc., the gameplay goes via various services, and finally, the last service in the call-chain calls a stored procedure which persists the outcome:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#859900">CREATE</span> <span style="color:#859900">PROCEDURE</span> <span style="color:#268bd2">dbo</span>.<span style="color:#268bd2">pr_LogWager</span> @<span style="color:#268bd2">UserID</span> <span style="color:#cb4b16">INT</span>,
</span></span><span style="display:flex;"><span>                                 @<span style="color:#268bd2">GameID</span> <span style="color:#cb4b16">INT</span>,
</span></span><span style="display:flex;"><span>                                 @<span style="color:#268bd2">WagerAmount</span> <span style="color:#cb4b16">decimal</span>(<span style="color:#2aa198;font-weight:bold">10</span>, <span style="color:#2aa198;font-weight:bold">2</span>),
</span></span><span style="display:flex;"><span>                                 @<span style="color:#268bd2">PayoutAmount</span> <span style="color:#cb4b16">decimal</span>(<span style="color:#2aa198;font-weight:bold">10</span>, <span style="color:#2aa198;font-weight:bold">2</span>),
</span></span><span style="display:flex;"><span>                                 @<span style="color:#268bd2">EventTime</span> <span style="color:#268bd2">datetime2</span>
</span></span><span style="display:flex;"><span><span style="color:#859900">AS</span>
</span></span><span style="display:flex;"><span><span style="color:#859900">BEGIN</span>
</span></span><span style="display:flex;"><span>  <span style="color:#859900">IF</span>(@<span style="color:#268bd2">EventTime</span> <span style="color:#859900">IS</span> <span style="color:#859900">NULL</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#859900">BEGIN</span>
</span></span><span style="display:flex;"><span>    <span style="color:#859900">SET</span> @<span style="color:#268bd2">EventTime</span> = <span style="color:#268bd2">SYSUTCDATETIME</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#859900">END</span>
</span></span><span style="display:flex;"><span>  <span style="color:#859900">BEGIN</span> <span style="color:#268bd2">TRY</span>
</span></span><span style="display:flex;"><span>    <span style="color:#859900">BEGIN</span> <span style="color:#268bd2">TRAN</span>
</span></span><span style="display:flex;"><span>      <span style="color:#859900">INSERT</span> <span style="color:#859900">INTO</span> <span style="color:#268bd2">dbo</span>.<span style="color:#268bd2">tb_GamePlay</span>(<span style="color:#268bd2">UserID</span>, <span style="color:#268bd2">GameID</span>, <span style="color:#268bd2">WagerAmount</span>, 
</span></span><span style="display:flex;"><span>                                  <span style="color:#268bd2">EventTime</span>, <span style="color:#268bd2">PayoutAmount</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#859900">VALUES</span>(@<span style="color:#268bd2">UserID</span>, @<span style="color:#268bd2">GameID</span>, @<span style="color:#268bd2">WagerAmount</span>, @<span style="color:#268bd2">PayoutAmount</span>, <span style="color:#268bd2">EventTime</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#93a1a1;font-style:italic">--do more tx &#34;stuff&#34; here
</span></span></span><span style="display:flex;"><span><span style="color:#93a1a1;font-style:italic"></span>    <span style="color:#859900">COMMIT</span> <span style="color:#268bd2">TRAN</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#859900">END</span> <span style="color:#268bd2">TRY</span>
</span></span><span style="display:flex;"><span>  <span style="color:#859900">BEGIN</span> <span style="color:#268bd2">CATCH</span>
</span></span><span style="display:flex;"><span>    <span style="color:#859900">ROLLBACK</span> <span style="color:#268bd2">TRAN</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#859900">END</span> <span style="color:#268bd2">CATCH</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#859900">END</span>  
</span></span><span style="display:flex;"><span><span style="color:#859900">GO</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 2:</strong> <em>Game Play Procedure</em></p>
<p>We see how the procedure in <em>Code Snippet 2</em> takes relevant gameplay details and inserts them into the <code>dbo.tb_GamePlay</code> table.</p>
<p>In our scenario, we want to stream the individual gameplay events, but we cannot alter the services which generate the gameplay. We instead decide to generate the event from the database using, as we mentioned above, the SQL Server Extensibility Framework.</p>
<h2 id="sql-server-extensibility-frameworkback">SQL Server Extensibility FrameworkBack</h2>
<p>Together with the release of SQL Server 2016, Microsoft introduced the feature to be able to execute R script code from inside SQL Server against an external R engine. SQL Server 2017 added the ability to execute Python code against an external Python environment.</p>
<p>A SQL Server framework enables the ability to call R/Python: the <strong>SQL Server Extensibility Framework</strong>, and you can read more about it in my blog post 

<a href="/post/2019-06-06-sql-server-2019-extensibility-framework--external-languages/">SQL Server 2019 Extensibility Framework &amp; External Languages</a>. For SQL Server 2019, Java is available as an external language, and that is what we use in this post.</p>
<p>If you are unsure about what I talk about here are some blog posts that may help:</p>
<ul>
<li>

<a href="/post/2018-03-07-microsoft-sql-server-r-services-sp_execute_external_script-i/">Microsoft SQL Server R Services: sp_execute_external_script - I</a> - When calling out to R/Python/Java you do it from a specific procedure: <code>sp_execute_external_script</code>. This is the first post of three looking at <code>sp_execute_external_script</code>.</li>
<li>

<a href="/post/2018-03-11-microsoft-sql-server-r-services---sp-execute-external-script---ii/">Microsoft SQL Server R Services - sp_execute_external_script - II</a> - The second post about <code>sp_execute_external_script</code>.</li>
<li>

<a href="/post/2018-03-21-microsoft-sql-server-r-services---sp-execute-external-script---iii/">Microsoft SQL Server R Services: sp_execute_external_script - III</a>  - The third post about <code>sp_execute_external_script</code>.</li>
<li>

<a href="/s2k19_ext_framework_java">SQL Server 2019 Extensibility Framework &amp; Java</a> - A series of posts discussing how to write Java code so we can call it from SQL server.</li>
</ul>
<h2 id="solution">Solution</h2>
<p>As we mentioned above, we want to generate the wager &ldquo;event&rdquo; from inside the database, and there are a couple of ways we can do that:</p>
<ul>
<li>

<a href="https://docs.microsoft.com/en-us/sql/relational-databases/track-changes/about-change-data-capture-sql-server?view=sql-server-2017" target="_blank" rel="noopener">Change Data Capture</a> - CDC captures insert, update, and delete activity that is applied to a SQL Server table, and makes the details of the changes available to consumers.</li>
<li>

<a href="https://docs.microsoft.com/en-us/sql/relational-databases/track-changes/about-change-tracking-sql-server?view=sql-server-2017" target="_blank" rel="noopener">Change Tracking</a> - CT tracks and makes available rows that change in SQL Server tables. The difference
between CT and CDC is that CT does not capture the changed values.</li>
</ul>
<p>Both CDC, and CT can be used to get data from SQL Server to Kafka, and we will cover that in future posts. In this post however, we look at doing the event generation in another way: hook-points in stored procedures.</p>
<p>The idea with stored procedure hook-points is that at a place in a stored procedure, a code block is inserted, (hooked in), and this code block executes some code. In this case, it publishes a message to Kafka.</p>
<blockquote>
<p><strong>NOTE:</strong> With the definition of a hook-point above, you may ask what the difference is between a hook-point and an ordinary procedure call? There is no real difference; the way I see it is that the hook-point executes code which is, to a large degree, un-related to what the procedure does. Oh, and the name &ldquo;hook-point&rdquo; sounds cool.</p>
</blockquote>
<p>So, where do we insert the hook-point in the procedure we see in <em>Code Snippet 2</em>? As the <code>pr_LogWager</code> is transactional, we insert the hook-point after the commit, so we do not publish any messages for rolled back wagers. The implication of publishing the event/message after the last commit is that if you have several stored procedures calling each other, the hook-point may be in the beginning of the call-chain.</p>
<p>Now we know where the hook-point should be, but what should it do? Obviously, it should publish to Kafka, but what should it publish? In this case, it should publish an event, so the hook-point also needs to generate the event. What the event should look like is very much up to you, for now, let us assume the event looks something like so:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>   <span style="color:#268bd2;font-weight:bold">&#34;$schema&#34;</span>: <span style="color:#2aa198">&#34;http://json-schema.org/draft-04/schema#&#34;</span>,
</span></span><span style="display:flex;"><span>   <span style="color:#268bd2;font-weight:bold">&#34;title&#34;</span>: <span style="color:#2aa198">&#34;Wager&#34;</span>,
</span></span><span style="display:flex;"><span>   <span style="color:#268bd2;font-weight:bold">&#34;description&#34;</span>: <span style="color:#2aa198">&#34;A placed wager&#34;</span>,
</span></span><span style="display:flex;"><span>   <span style="color:#268bd2;font-weight:bold">&#34;type&#34;</span>: <span style="color:#2aa198">&#34;object&#34;</span>,
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>   <span style="color:#268bd2;font-weight:bold">&#34;properties&#34;</span>: {
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2;font-weight:bold">&#34;eventTypeId&#34;</span>: {
</span></span><span style="display:flex;"><span>         <span style="color:#268bd2;font-weight:bold">&#34;description&#34;</span>: <span style="color:#2aa198">&#34;Unique identifier for the event type&#34;</span>,
</span></span><span style="display:flex;"><span>         <span style="color:#268bd2;font-weight:bold">&#34;type&#34;</span>: <span style="color:#2aa198">&#34;integer&#34;</span>
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2;font-weight:bold">&#34;userId&#34;</span>: {
</span></span><span style="display:flex;"><span>         <span style="color:#268bd2;font-weight:bold">&#34;description&#34;</span>: <span style="color:#2aa198">&#34;The unique identifier for a user&#34;</span>,
</span></span><span style="display:flex;"><span>         <span style="color:#268bd2;font-weight:bold">&#34;type&#34;</span>: <span style="color:#2aa198">&#34;integer&#34;</span>
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2;font-weight:bold">&#34;userId&#34;</span>: {
</span></span><span style="display:flex;"><span>         <span style="color:#268bd2;font-weight:bold">&#34;description&#34;</span>: <span style="color:#2aa198">&#34;The unique identifier for a game&#34;</span>,
</span></span><span style="display:flex;"><span>         <span style="color:#268bd2;font-weight:bold">&#34;type&#34;</span>: <span style="color:#2aa198">&#34;integer&#34;</span>
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2;font-weight:bold">&#34;wagerAmount&#34;</span>: {
</span></span><span style="display:flex;"><span>         <span style="color:#268bd2;font-weight:bold">&#34;description&#34;</span>: <span style="color:#2aa198">&#34;Amount wagered&#34;</span>,
</span></span><span style="display:flex;"><span>         <span style="color:#268bd2;font-weight:bold">&#34;type&#34;</span>: <span style="color:#2aa198">&#34;number&#34;</span>
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2;font-weight:bold">&#34;payoutAmount&#34;</span>: {
</span></span><span style="display:flex;"><span>         <span style="color:#268bd2;font-weight:bold">&#34;description&#34;</span>: <span style="color:#2aa198">&#34;Amount paid out (win)&#34;</span>,
</span></span><span style="display:flex;"><span>         <span style="color:#268bd2;font-weight:bold">&#34;type&#34;</span>: <span style="color:#2aa198">&#34;number&#34;</span>
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2;font-weight:bold">&#34;eventTime&#34;</span>: {
</span></span><span style="display:flex;"><span>         <span style="color:#268bd2;font-weight:bold">&#34;description&#34;</span>: <span style="color:#2aa198">&#34;Time when the wager happened&#34;</span>,
</span></span><span style="display:flex;"><span>         <span style="color:#268bd2;font-weight:bold">&#34;type&#34;</span>: <span style="color:#2aa198">&#34;string&#34;</span>,
</span></span><span style="display:flex;"><span>         <span style="color:#268bd2;font-weight:bold">&#34;format&#34;</span>: <span style="color:#2aa198">&#34;date-time&#34;</span>
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>     
</span></span><span style="display:flex;"><span>   },
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>   <span style="color:#268bd2;font-weight:bold">&#34;required&#34;</span>: [<span style="color:#2aa198">&#34;eventTypeId&#34;</span>, <span style="color:#2aa198">&#34;userId&#34;</span>, <span style="color:#2aa198">&#34;userId&#34;</span>, 
</span></span><span style="display:flex;"><span>                <span style="color:#2aa198">&#34;wagerAmount&#34;</span>, <span style="color:#2aa198">&#34;payoutAmount&#34;</span>]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 3:</strong> <em>Wager Schema</em></p>
<p>We see in <em>Code Snippet 3</em> how the schema for the event looks very much like what we persist to the table in our stored procedure. The only difference is that we also define an <code>eventTypeId</code>, which we can use when we do stream processing to filter out various types of events.</p>
<p>Even though the hook-point can be just a few lines of T-SQL code, best practice is to define an event-specific stored procedure:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#859900">CREATE</span> <span style="color:#859900">PROCEDURE</span> <span style="color:#268bd2">dbo</span>.<span style="color:#268bd2">pr_GenerateAndPublishWagerEvent</span> @<span style="color:#268bd2">UserID</span> <span style="color:#cb4b16">INT</span>,
</span></span><span style="display:flex;"><span>                                          @<span style="color:#268bd2">GameID</span> <span style="color:#cb4b16">INT</span>,
</span></span><span style="display:flex;"><span>                                          @<span style="color:#268bd2">WagerAmount</span> <span style="color:#cb4b16">decimal</span>(<span style="color:#2aa198;font-weight:bold">10</span>, <span style="color:#2aa198;font-weight:bold">2</span>),
</span></span><span style="display:flex;"><span>                                          @<span style="color:#268bd2">PayoutAmount</span> <span style="color:#cb4b16">decimal</span>(<span style="color:#2aa198;font-weight:bold">10</span>, <span style="color:#2aa198;font-weight:bold">2</span>),
</span></span><span style="display:flex;"><span>                                          @<span style="color:#268bd2">EventTime</span> <span style="color:#268bd2">datetime2</span>
</span></span><span style="display:flex;"><span><span style="color:#859900">AS</span>
</span></span><span style="display:flex;"><span><span style="color:#859900">BEGIN</span>
</span></span><span style="display:flex;"><span>  <span style="color:#859900">DECLARE</span> @<span style="color:#268bd2">msg</span> <span style="color:#268bd2">nvarchar</span>(<span style="color:#859900">max</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#93a1a1;font-style:italic">--generate the event
</span></span></span><span style="display:flex;"><span><span style="color:#93a1a1;font-style:italic"></span>  <span style="color:#859900">SET</span> @<span style="color:#268bd2">msg</span> =  (<span style="color:#859900">SELECT</span> <span style="color:#2aa198;font-weight:bold">1500</span> <span style="color:#859900">AS</span> <span style="color:#268bd2">eventTypeId</span>,
</span></span><span style="display:flex;"><span>                 @<span style="color:#268bd2">UserId</span> <span style="color:#859900">AS</span> <span style="color:#268bd2">userId</span>,
</span></span><span style="display:flex;"><span>                 @<span style="color:#268bd2">GameId</span> <span style="color:#859900">AS</span> <span style="color:#268bd2">gameId</span>,
</span></span><span style="display:flex;"><span>                 @<span style="color:#268bd2">WagerAmount</span> <span style="color:#859900">AS</span> <span style="color:#268bd2">wagerAmount</span>,
</span></span><span style="display:flex;"><span>                 @<span style="color:#268bd2">PayoutAmount</span> <span style="color:#859900">AS</span> <span style="color:#268bd2">payoutAmount</span>,
</span></span><span style="display:flex;"><span>                 @<span style="color:#268bd2">EventTime</span> <span style="color:#859900">AS</span> <span style="color:#268bd2">eventTime</span>
</span></span><span style="display:flex;"><span>     <span style="color:#859900">FOR</span> <span style="color:#268bd2">JSON</span> <span style="color:#268bd2">PATH</span>, <span style="color:#268bd2">WITHOUT_ARRAY_WRAPPER</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#93a1a1;font-style:italic">-- call &#34;something&#34; to publish to Kafka
</span></span></span><span style="display:flex;"><span><span style="color:#93a1a1;font-style:italic"></span><span style="color:#859900">END</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 4:</strong> <em>Hook Point Procedure</em></p>
<p>The code we see in <em>Code Snippet 4</em> is the start of the hook-point procedure. We see how the procedure generates the wager event by using the T-SQL <code>FOR JSON</code> syntax. A placeholder for the publish call follows the creation of the event.</p>
<blockquote>
<p><strong>NOTE:</strong> when you look at the hook-point procedure it may seem like overengineering as the call is basically a pass-through from the <code>dbo.pr_LogWager</code> procedure. The reason we have a specific procedure is that in the &ldquo;real world&rdquo; you most likely do more things inside the procedure.</p>
</blockquote>
<p>So, the placeholder for the publish call; that is where we call into some Java code that publishes to Kafka. Before we look at the Java code, let us see what the Kafka setup should look like.</p>
<h2 id="kafka">Kafka</h2>
<p>I have assumed in this post that we have Kafka installed &ldquo;somewhere&rdquo;, and that we can connect to it. If that is not the case, have a look at the 

<a href="/post/2019-06-18-confluent-platform--kafka-for-the-windows--net-developer/">Confluent Platform &amp; Kafka for a .NET Developer on Windows</a> post to see how you install Kafka in a Docker container.</p>
<p>Now, when we have Kafka installed, let us create two topics:</p>
<ul>
<li><code>testTopic</code> - as the name implies, it is a topic for test. We use it initially just to make sure our Java code works. Create it with 1 partition.</li>
<li><code>wagers</code> - this is the topic to where we publish wagers. We create it with 4 partitions.</li>
</ul>
<blockquote>
<p><strong>NOTE:</strong> In a future post we will talk more about partitions, and what role they play.</p>
</blockquote>
<p>As I did in the 

<a href="/post/2019-06-18-confluent-platform--kafka-for-the-windows--net-developer/">post</a> mentioned above, I create the topics using <em>Control Center</em>:</p>
<p>
  <img src="/images/posts/sql_kafka_extlang_topics.png" alt="">

</p>
<p><strong>Figure 1:</strong> <em>Create Wagers Topic</em></p>
<p>In <em>Figure 1</em> we see how I create the <code>wagers</code> topic in <em>Control Center</em>&rsquo;s <em>New topic</em> screen.</p>
<blockquote>
<p><strong>NOTE:</strong> If you don&rsquo;t have <em>Control Center</em> you can create topics via the command line, using the <code>kafka-topics --create ...</code> statement.</p>
</blockquote>
<p>When we have the two topics, let us write some Java code.</p>
<h2 id="java">Java</h2>
<blockquote>
<p><strong>NOTE:</strong> I am by no means a Java developer, so I apologize in advance for simplistic and naive code. Furthermore, the code is definitely not production code; no error handling, etc., so use it on your own risk.</p>
</blockquote>
<p>For this blog post, I use <em>VS Code</em> together with the <em>Maven</em> extension. You can read more about that in the 

<a href="/post/2019-01-17-sql-server-2019--java-with-visual-studio-code/">SQL Server 2019 &amp; Java with Visual Studio Code</a> post.</p>
<p>To begin with, let us:</p>
<ul>
<li>Create an empty folder where you want your Java project.</li>
<li>Open <em>VS Code</em> and open the folder you created above.</li>
<li>Create a new <em>Maven</em> project, using the archetype <code>maven-archetype-quickstart</code>.</li>
</ul>
<p>During the creation of the project, you are asked for some properties of the project: <code>groupId</code>,  <code>artifactId</code>, <code>version</code>, and <code>packageId</code>. In my project, I set them to:</p>
<ul>
<li><code>groupId</code>: <code>com.nielsberglund.sqlserver</code>.</li>
<li><code>artifactId</code>: <code>SqlToKafka</code>.</li>
<li><code>version</code>: <code>1.0</code>.</li>
<li><code>package</code>: <code>kafkapublish</code>.</li>
</ul>
<p>To be able to publish to Kafka, we need a Java Kafka client, and we use the native client from <code>org.apache.kafka</code>: <code>kafka-clients</code>. To use the client, we need to add it as a dependency in the projects <code>pom.xml</code> file:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#268bd2;font-weight:bold">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2;font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2;font-weight:bold">&lt;groupId&gt;</span>org.apache.kafka<span style="color:#268bd2;font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2;font-weight:bold">&lt;artifactId&gt;</span>kafka-clients<span style="color:#268bd2;font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2;font-weight:bold">&lt;version&gt;</span>2.3.0<span style="color:#268bd2;font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2;font-weight:bold">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span><span style="color:#268bd2;font-weight:bold">&lt;/dependencies&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 5:</strong> <em>Kafka Clients Dependencies</em></p>
<p>We see in <em>Code Snippet 5</em> the dependency we added to the <code>pom.xml</code> file. We are now ready to start to write some code.</p>
<p>To begin with, we create a very basic method which publishes to Kafka:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#dc322f;font-weight:bold">package</span> <span style="color:#268bd2">kafkapublish</span>;
</span></span><span style="display:flex;"><span><span style="color:#dc322f;font-weight:bold">import</span> <span style="color:#268bd2">java.util.Properties</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#93a1a1;font-style:italic">//import necessary Kafka packages</span>
</span></span><span style="display:flex;"><span><span style="color:#dc322f;font-weight:bold">import</span> <span style="color:#268bd2">org.apache.kafka.clients.producer.Producer</span>;
</span></span><span style="display:flex;"><span><span style="color:#dc322f;font-weight:bold">import</span> <span style="color:#268bd2">org.apache.kafka.clients.producer.KafkaProducer</span>;
</span></span><span style="display:flex;"><span><span style="color:#dc322f;font-weight:bold">import</span> <span style="color:#268bd2">org.apache.kafka.clients.producer.ProducerRecord</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#859900">public</span> <span style="color:#859900">class</span> <span style="color:#cb4b16">SqlKafka</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#859900">public</span> <span style="color:#859900">static</span> <span style="color:#859900;font-weight:bold">void</span> <span style="color:#268bd2">main</span>( <span style="color:#268bd2">String</span>[] <span style="color:#268bd2">args</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2">SqlKafka</span> <span style="color:#268bd2">sq</span> = <span style="color:#859900">new</span> <span style="color:#268bd2">SqlKafka</span>();
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2">sq</span>.<span style="color:#268bd2">publishToKafka</span>();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#859900">public</span> <span style="color:#859900;font-weight:bold">void</span> <span style="color:#268bd2">publishToKafka</span>() {
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2">String</span> <span style="color:#268bd2">topicName</span> = <span style="color:#2aa198">&#34;testTopic&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2">Properties</span> <span style="color:#268bd2">config</span> = <span style="color:#859900">new</span> <span style="color:#268bd2">Properties</span>();
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2">config</span>.<span style="color:#268bd2">put</span>(<span style="color:#2aa198">&#34;client.id&#34;</span>, <span style="color:#2aa198">&#34;1&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2">config</span>.<span style="color:#268bd2">put</span>(<span style="color:#2aa198">&#34;bootstrap.servers&#34;</span>, <span style="color:#2aa198">&#34;localhost:9092&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2">config</span>.<span style="color:#268bd2">put</span>(<span style="color:#2aa198">&#34;acks&#34;</span>, <span style="color:#2aa198">&#34;all&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2">config</span>.<span style="color:#268bd2">put</span>(<span style="color:#2aa198">&#34;key.serializer&#34;</span>, \
</span></span><span style="display:flex;"><span>      <span style="color:#2aa198">&#34;org.apache.kafka.common.serialization.StringSerializer&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2">config</span>.<span style="color:#268bd2">put</span>(<span style="color:#2aa198">&#34;value.serializer&#34;</span>, \
</span></span><span style="display:flex;"><span>      <span style="color:#2aa198">&#34;org.apache.kafka.common.serialization.StringSerializer&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2">Producer</span>&lt;<span style="color:#268bd2">String</span>, <span style="color:#268bd2">String</span>&gt; <span style="color:#268bd2">producer</span> = \
</span></span><span style="display:flex;"><span>           <span style="color:#859900">new</span> <span style="color:#268bd2">KafkaProducer</span>&lt;<span style="color:#268bd2">String</span>, <span style="color:#268bd2">String</span>&gt;(<span style="color:#268bd2">config</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#859900">for</span> (<span style="color:#859900;font-weight:bold">int</span> <span style="color:#268bd2">i</span> = <span style="color:#268bd2">0</span>; <span style="color:#268bd2">i</span> &lt; <span style="color:#268bd2">10</span>; <span style="color:#268bd2">i</span>++) {
</span></span><span style="display:flex;"><span>          <span style="color:#268bd2">producer</span>.<span style="color:#268bd2">send</span>(<span style="color:#859900">new</span> <span style="color:#268bd2">ProducerRecord</span>&lt;<span style="color:#268bd2">String</span>, <span style="color:#268bd2">String</span>&gt; \
</span></span><span style="display:flex;"><span>          (<span style="color:#268bd2">topicName</span>, <span style="color:#859900;font-weight:bold">null</span>, <span style="color:#268bd2">String</span>.<span style="color:#268bd2">format</span>(<span style="color:#2aa198">&#34;Hello number: %s&#34;</span>, <span style="color:#268bd2">i</span>)));
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2">producer</span>.<span style="color:#268bd2">close</span>();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 6:</strong> <em>Simple Publish</em></p>
<p>The code we see in <em>Code Snippet 6</em> is in the project just for us to make sure that we can publish to the broker, and has nothing to do with SQL Server. In the <code>publishToKafka</code> method, we see how we:</p>
<ul>
<li>Set some properties, amongst them are the brokers, (<code>bootstrap.servers</code>), we connect to.</li>
<li>Set the serializers we use.</li>
<li>Create a <code>Producer</code> instance.</li>
<li>Call <code>send</code> on the <code>producer</code> instance.</li>
</ul>
<p>To check that everything works we &ldquo;spin up&rdquo; a <code>bash</code> shell in the Kafka broker instance. If you run this in Docker you:</p>
<ul>
<li>Do a <code>Docker exec -it &lt;kafka_instance_name&gt; bash</code>.</li>
<li>From the command prompt in the container you <code>cd</code> into the <code>/usr/bin/</code> directory.</li>
</ul>
<p>When you are in the <code>/usr/bin/</code> directory you start up a Kafka console consumer like so:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ./kafka-console-consumer --bootstrap-server broker:29092 <span style="color:#2aa198">\
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198"></span>                           --topic testTopic
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 7:</strong> <em>Kafka Console Consumer</em></p>
<p>You may ask yourself why, in the code in <em>Code Snippet 6</em>, <code>bootstrap.servers</code> is <code>localhost:9092</code>, whereas in <em>Code Snippet 7</em> it is <code>broker:29092</code>; different host-name as well as port number? That is because we run in a Docker container where we have different listeners for internal network connections compared to external (from the host machine or other machines).</p>
<blockquote>
<p><strong>NOTE:</strong> 

<a href="https://twitter.com/rmoff" target="_blank" rel="noopener">Robin Moffat</a>, who is a Kafka guru, has written a blog post about port addresses and listeners: 

<a href="https://rmoff.net/2018/08/02/kafka-listeners-explained/" target="_blank" rel="noopener">Kafka Listeners - Explained</a>. If you are interested in Kafka, you should read that post, and whatever else Robin publishes. He knows his stuff!</p>
</blockquote>
<p>Anyway, you execute the code in <em>Code Snippet 7</em>. When you subsequently run the Java code in <em>Code Snippet 6</em>, the output in the terminal window where you run <code>kafka-console-consumer</code> looks like so:</p>
<p>
  <img src="/images/posts/sql_kafka_extlang_output1.png" alt="">

</p>
<p><strong>Figure 2:</strong> <em>Consume Output</em></p>
<p>We see in <em>Figure 2</em> the commands we used to run the containers <code>bash</code> shell, together with the <code>kafka-console-consumer</code> command, and the output, (&ldquo;Hello number: <em>n</em>&rdquo;), which we receive after executing the Java code. That&rsquo;s cool - our simple code works, but - once again - the code is very simple, and we definitely cannot use it, as is in SQL Server. Let us see what we need to do to make this work from SQL.</p>
<h2 id="java-code--sql-server">Java Code &amp; SQL Server</h2>
<p>This post is not about how to write Java code so it can be used from SQL Server, read my 

<a href="/s2k19_ext_framework_java">SQL Server 2019 Extensibility Framework &amp; Java</a> series for that. There is one thing however that is important that I want to re-iterate, and that is the 

<a href="https://docs.microsoft.com/en-us/sql/language-extensions/how-to/extensibility-sdk-java-sql-server" target="_blank" rel="noopener">Microsoft Extensibility SDK for Java</a>, which is required if we want to write Java code for SQL Server. The SDK was introduced together with SQL Server 2019 CTP 2.5, (I am now on CTP 3.1). I wrote about the SDK in 

<a href="/post/2019-05-26-java--sql-server-2019-extensibility-framework-the-sequel/">Java &amp; SQL Server 2019 Extensibility Framework: The Sequel</a>. One difference between CTP 2.5 and CTP 3.1 is that the SDK is now part of the SQL Server distribution, so you do not need to download it. You find it at: <code>\&lt;path_to_instance_install&gt;\MSSQL\Binn\mssql-java-lang-extension.jar</code>.</p>
<p>What we need to do is to add the SDK as a dependency for our project. If you use <em>VS Code</em> and <em>Maven</em> I covered how to do it in the 

<a href="/post/2019-05-26-java--sql-server-2019-extensibility-framework-the-sequel/">Java &amp; SQL Server 2019 Extensibility Framework: The Sequel</a>. A short recap:</p>
<ul>
<li>Create a new directory in <em>Maven</em>&rsquo;s local repository directory. For me, on Windows, it is <code>%USERPROFILE%\.m2\repository</code>.</li>
<li>Create a subdirectory of the new directory, named <code>mssql-java-lang-extension</code>.</li>
<li>Create a subdirectory of <code>mssql-java-lang-extension</code>, and name it as a version number. (<code>1.0</code> for example).</li>
<li>Copy <code>mssql-java-lang-extension.jar</code> to the &ldquo;version&rdquo; directory and add the &ldquo;version&rdquo; number to the <code>.jar</code> file like so: <code>mssql-java-lang-extension-1.0.jar</code>:</li>
</ul>
<p>
  <img src="/images/posts/sql_2k19_java_sdk_dep_hierarch.png" alt="">

</p>
<p><strong>Figure 3:</strong> <em>Folder Hierarchy Dependency</em></p>
<p>In <em>Figure 3</em> we see the &ldquo;layout&rdquo; of the local <em>Maven</em> repository after I have set it up for the SDK dependency, and we see how I named the top-level directory <code>nielsb</code>. Outlined in blue we see the different folders below<code>..\m2\repository</code>, and the outline in red shows the renamed SDK file. We can now add the dependency to the <code>pom.xml</code> file:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#268bd2;font-weight:bold">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2;font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2;font-weight:bold">&lt;groupId&gt;</span>nielsb<span style="color:#268bd2;font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2;font-weight:bold">&lt;artifactId&gt;</span>mssql-java-lang-extension<span style="color:#268bd2;font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2;font-weight:bold">&lt;version&gt;</span>1.0<span style="color:#268bd2;font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2;font-weight:bold">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span><span style="color:#268bd2;font-weight:bold">&lt;/dependencies&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 8:</strong> <em>Java SDK Dependency</em></p>
<p>By having added the dependency to the <code>pom.xml</code> file, we can now reference the SDK in our code:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#dc322f;font-weight:bold">package</span> <span style="color:#268bd2">kafkapublish</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#dc322f;font-weight:bold">import</span> <span style="color:#268bd2">com.microsoft.sqlserver.javalangextension.*</span>;
</span></span><span style="display:flex;"><span><span style="color:#dc322f;font-weight:bold">import</span> <span style="color:#268bd2">java.util.LinkedHashMap</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#859900">public</span> <span style="color:#859900">class</span> <span style="color:#cb4b16">SqlKafka</span>  <span style="color:#859900">extends</span> <span style="color:#268bd2">AbstractSqlServerExtensionExecutor</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 9:</strong> <em>Extending the SqlKafka Class</em></p>
<p>What we see in <em>Code Snippet 9</em> is how I <code>import</code> all classes in <code>com.microsoft.sqlserver.javalangextension</code>, and how I subsequently extend the <code>SqlKafka</code> class with <code>AbstractSqlServerExtensionExecutor</code>. Oh, I also <code>import</code> <code>java.util.LinkedHashMap</code>, which I use later.</p>
<p>We know from 

<a href="/post/2019-05-26-java--sql-server-2019-extensibility-framework-the-sequel/">Java &amp; SQL Server 2019 Extensibility Framework: The Sequel</a> that when we call Java code from SQL Server, our code needs to implement the <code>execute</code> method from the <code>AbstractSqlServerExtensionExecutor</code> class, and that the method looks like so:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#859900">public</span> <span style="color:#268bd2">AbstractSqlServerExtensionDataset</span> <span style="color:#268bd2">execute</span>(
</span></span><span style="display:flex;"><span>               <span style="color:#268bd2">AbstractSqlServerExtensionDataset</span> <span style="color:#268bd2">input</span>, 
</span></span><span style="display:flex;"><span>               <span style="color:#268bd2">LinkedHashMap</span>&lt;<span style="color:#268bd2">String</span>, <span style="color:#268bd2">Object</span>&gt; <span style="color:#268bd2">params</span>) {...}
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 10:</strong> <em>Execute Method</em></p>
<p>In <em>Code Snippet 10</em> we see how the method expects two parameters: a dataset, and a map of strings and objects. That is quite useful for us, as, even though right now the publish method in our code has hardcoded values for broker, topic, message, and so on; in a &ldquo;real world&rdquo; scenario we do do not publish to just one topic, and we may publish the same event to different brokers.</p>
<p>So, the way we code it is that we expect the dataset to contain a broker address, (including port-number), topic, and partition value. We pass in the event, (message), as a parameter, part of the <code>LinkedHashMap</code>. That way, we do not duplicate the message if we publish to multiple brokers:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#859900">public</span> <span style="color:#268bd2">PrimitiveDataset</span> <span style="color:#268bd2">execute</span>(<span style="color:#268bd2">PrimitiveDataset</span> <span style="color:#268bd2">input</span>, 
</span></span><span style="display:flex;"><span>                               <span style="color:#268bd2">LinkedHashMap</span>&lt;<span style="color:#268bd2">String</span>, 
</span></span><span style="display:flex;"><span>                               <span style="color:#268bd2">Object</span>&gt; <span style="color:#268bd2">params</span>) 
</span></span><span style="display:flex;"><span>{  
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">String</span>[] <span style="color:#268bd2">brokers</span> = <span style="color:#268bd2">input</span>.<span style="color:#268bd2">getStringColumn</span>(<span style="color:#268bd2">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">String</span>[] <span style="color:#268bd2">partitions</span> = <span style="color:#268bd2">input</span>.<span style="color:#268bd2">getStringColumn</span>(<span style="color:#268bd2">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">String</span>[] <span style="color:#268bd2">topics</span> = <span style="color:#268bd2">input</span>.<span style="color:#268bd2">getStringColumn</span>(<span style="color:#268bd2">2</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">String</span> <span style="color:#268bd2">message</span> = (<span style="color:#268bd2">String</span>)<span style="color:#268bd2">params</span>.<span style="color:#268bd2">get</span>(<span style="color:#2aa198">&#34;msg&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#859900;font-weight:bold">int</span> <span style="color:#268bd2">rowCount</span> = <span style="color:#268bd2">brokers</span>.<span style="color:#268bd2">length</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#859900">for</span>(<span style="color:#859900;font-weight:bold">int</span> <span style="color:#268bd2">i</span>= <span style="color:#268bd2">0</span>; <span style="color:#268bd2">i</span> &lt; <span style="color:#268bd2">rowCount</span>; <span style="color:#268bd2">i</span>++)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#93a1a1;font-style:italic">//grab the column values  </span>
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2">String</span> <span style="color:#268bd2">broker</span> = (<span style="color:#268bd2">String</span>)<span style="color:#268bd2">brokers</span>[<span style="color:#268bd2">i</span>];
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2">String</span> <span style="color:#268bd2">partition</span> = (<span style="color:#268bd2">String</span>)<span style="color:#268bd2">partitions</span>[<span style="color:#268bd2">i</span>];
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2">String</span> <span style="color:#268bd2">topic</span> = (<span style="color:#268bd2">String</span>)<span style="color:#268bd2">topics</span>[<span style="color:#268bd2">i</span>];
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2">sqlPublishToKafka</span>(<span style="color:#268bd2">topic</span>, <span style="color:#268bd2">partition</span>, <span style="color:#268bd2">broker</span>, <span style="color:#268bd2">message</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#859900">return</span> <span style="color:#859900;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#859900">public</span> <span style="color:#859900;font-weight:bold">void</span> <span style="color:#268bd2">sqlPublishToKafka</span>(<span style="color:#268bd2">String</span> <span style="color:#268bd2">topic</span>, <span style="color:#268bd2">String</span> <span style="color:#268bd2">partition</span>, <span style="color:#268bd2">String</span> <span style="color:#268bd2">broker</span>, <span style="color:#268bd2">String</span> <span style="color:#268bd2">message</span>) 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">Properties</span> <span style="color:#268bd2">config</span> = <span style="color:#859900">new</span> <span style="color:#268bd2">Properties</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">config</span>.<span style="color:#268bd2">put</span>(<span style="color:#2aa198">&#34;client.id&#34;</span>, <span style="color:#2aa198">&#34;1&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">config</span>.<span style="color:#268bd2">put</span>(<span style="color:#2aa198">&#34;bootstrap.servers&#34;</span>, <span style="color:#268bd2">broker</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">config</span>.<span style="color:#268bd2">put</span>(<span style="color:#2aa198">&#34;acks&#34;</span>, <span style="color:#2aa198">&#34;all&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">config</span>.<span style="color:#268bd2">put</span>(<span style="color:#2aa198">&#34;key.serializer&#34;</span>, \
</span></span><span style="display:flex;"><span>    <span style="color:#2aa198">&#34;org.apache.kafka.common.serialization.StringSerializer&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">config</span>.<span style="color:#268bd2">put</span>(<span style="color:#2aa198">&#34;value.serializer&#34;</span>, \
</span></span><span style="display:flex;"><span>    <span style="color:#2aa198">&#34;org.apache.kafka.common.serialization.StringSerializer&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">Producer</span>&lt;<span style="color:#268bd2">String</span>, <span style="color:#268bd2">String</span>&gt; <span style="color:#268bd2">producer</span> = <span style="color:#859900">new</span> <span style="color:#268bd2">KafkaProducer</span>&lt;<span style="color:#268bd2">String</span>, <span style="color:#268bd2">String</span>&gt;(<span style="color:#268bd2">config</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">producer</span>.<span style="color:#268bd2">send</span>(<span style="color:#859900">new</span> <span style="color:#268bd2">ProducerRecord</span>&lt;<span style="color:#268bd2">String</span>, <span style="color:#268bd2">String</span>&gt;(<span style="color:#268bd2">topic</span>, <span style="color:#268bd2">partition</span>, <span style="color:#268bd2">message</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">producer</span>.<span style="color:#268bd2">close</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 11:</strong> <em>The Execute Method</em></p>
<p>We see in <em>Code Snippet 11</em> how I have implemented the <code>execute</code> method, and how I, in that method, handle the incoming parameters and subsequently call into the new <code>sqlPublishToKafka</code> method.</p>
<p>The Java language extension has some requirements on the code, which means we have to set some member variables in the class constructor like so:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#859900">public</span> <span style="color:#859900">class</span> <span style="color:#cb4b16">SqlKafka</span>  <span style="color:#859900">extends</span> <span style="color:#268bd2">AbstractSqlServerExtensionExecutor</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#859900">public</span> <span style="color:#268bd2">SqlKafka</span>() 
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">executorExtensionVersion</span> = <span style="color:#268bd2">SQLSERVER_JAVA_LANG_EXTENSION_V1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">executorInputDatasetClassName</span> = <span style="color:#268bd2">PrimitiveDataset</span>.<span style="color:#268bd2">class</span>.<span style="color:#268bd2">getName</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">executorOutputDatasetClassName</span> = <span style="color:#268bd2">PrimitiveDataset</span>.<span style="color:#268bd2">class</span>.<span style="color:#268bd2">getName</span>();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#859900">public</span> <span style="color:#268bd2">PrimitiveDataset</span> <span style="color:#268bd2">execute</span>(<span style="color:#268bd2">PrimitiveDataset</span> <span style="color:#268bd2">input</span>, 
</span></span><span style="display:flex;"><span>                                  <span style="color:#268bd2">LinkedHashMap</span>&lt;<span style="color:#268bd2">String</span>, <span style="color:#268bd2">Object</span>&gt; <span style="color:#268bd2">params</span>) 
</span></span><span style="display:flex;"><span>  { ... }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#859900">public</span> <span style="color:#859900;font-weight:bold">void</span> <span style="color:#268bd2">sqlPublishToKafka</span>(<span style="color:#268bd2">String</span> <span style="color:#268bd2">topic</span>, <span style="color:#268bd2">String</span> <span style="color:#268bd2">partition</span>, 
</span></span><span style="display:flex;"><span>                                <span style="color:#268bd2">String</span> <span style="color:#268bd2">broker</span>, <span style="color:#268bd2">String</span> <span style="color:#268bd2">message</span>) 
</span></span><span style="display:flex;"><span>  { ... }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 12:</strong> <em>Variables Required by Language Extension</em></p>
<p>You can read more about the required variables we see in <em>Code Snippet 12</em> in the 

<a href="/post/2019-05-26-java--sql-server-2019-extensibility-framework-the-sequel/">Java &amp; SQL Server 2019 Extensibility Framework: The Sequel</a> post.</p>
<p>Normally we can now build the application and create a <code>.jar</code> file out of it, to use later. If you use <em>VS Code</em> together with <em>Maven</em> see my post 

<a href="/post/2019-01-17-sql-server-2019--java-with-visual-studio-code/">SQL Server 2019 &amp; Java with Visual Studio Code</a> if you are unsure how to create a <code>.jar</code> file.</p>
<p>In the previous paragraph, I wrote &ldquo;normally&rdquo;, because when we want to use our code from SQL Server, it is not as straightforward as to just create a <code>.jar</code> file. As the <code>.jar</code> file will be deployed to SQL Server we need to ensure that all dependencies also are included, i.e., we need an &ldquo;uber jar&rdquo;.</p>
<p>To create this &ldquo;uber jar&rdquo;, (at least in <em>VS Code</em> and <em>Maven</em>), we use a <em>Maven</em> plugin <code>maven-shade-plugin</code> which is part of the <code>org.apache.maven.plugins</code> group, and we add the plugin to the <code>pom.xml</code> file. Let us see how and where to place it.</p>
<p>When we create a <em>Maven</em> project, the <code>pom.xml</code> file looks something like so:</p>
<p>
  <img src="/images/posts/ql_kafka_extlang_maven_plugins1.png" alt="">

</p>
<p><strong>Figure 4:</strong> <em>Build Section</em></p>
<p>We see in <em>Figure 4</em> that there is a <code>&lt;build&gt;</code> section in the <code>pom.xml</code> file, and it is in that section we add the plugin. In fact, for this project, we do not need anything else in the <code>&lt;build&gt;</code> section apart from our plugin. So we replace the whole existing <code>&lt;build&gt;</code> section with the following:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#268bd2;font-weight:bold">&lt;build&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2;font-weight:bold">&lt;plugins&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2;font-weight:bold">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2;font-weight:bold">&lt;groupId&gt;</span>org.apache.maven.plugins<span style="color:#268bd2;font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2;font-weight:bold">&lt;artifactId&gt;</span>maven-shade-plugin<span style="color:#268bd2;font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2;font-weight:bold">&lt;version&gt;</span>3.2.1<span style="color:#268bd2;font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2;font-weight:bold">&lt;configuration&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#268bd2;font-weight:bold">&lt;createDependencyReducedPom&gt;</span>false<span style="color:#268bd2;font-weight:bold">&lt;/createDependencyReducedPom&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#268bd2;font-weight:bold">&lt;artifactSet&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#268bd2;font-weight:bold">&lt;excludes&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#268bd2;font-weight:bold">&lt;exclude&gt;</span>nielsb:*<span style="color:#268bd2;font-weight:bold">&lt;/exclude&gt;</span>  
</span></span><span style="display:flex;"><span>          <span style="color:#268bd2;font-weight:bold">&lt;/excludes&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#268bd2;font-weight:bold">&lt;/artifactSet&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2;font-weight:bold">&lt;/configuration&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2;font-weight:bold">&lt;executions&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#268bd2;font-weight:bold">&lt;execution&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#268bd2;font-weight:bold">&lt;phase&gt;</span>package<span style="color:#268bd2;font-weight:bold">&lt;/phase&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#268bd2;font-weight:bold">&lt;goals&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#268bd2;font-weight:bold">&lt;goal&gt;</span>shade<span style="color:#268bd2;font-weight:bold">&lt;/goal&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#268bd2;font-weight:bold">&lt;/goals&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#268bd2;font-weight:bold">&lt;/execution&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2;font-weight:bold">&lt;/executions&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2;font-weight:bold">&lt;/plugin&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2;font-weight:bold">&lt;/plugins&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2;font-weight:bold">&lt;/build&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 13:</strong> <em>New Build Section</em></p>
<p>Notice in <em>Code Snippet 13</em> how there is an <code>&lt;excludes&gt; section containing </code><exclude>nielsb:*</exclude><code>. That </code>nielsb` refers to the directory we added for the Java SDK dependency, (<em>Figure 3</em>). What we say here is that we do not want to include the Java SDK as a dependency in our &ldquo;uber jar&rdquo;, as we later deploy the SDK standalone, and having two SDK&rsquo;s deployed to the same database cause bad things to happen.</p>
<p>Having done this, we:</p>
<ul>
<li>Save the <code>pom.xml</code> file.</li>
<li>Compile the project.</li>
<li>Create the <code>.jar</code> via the <code>package</code> command.</li>
</ul>
<p>The created <code>.jar</code> file is in the project&rsquo;s <code>target</code> directory, and &ldquo;weighs&rdquo; in at around 9Mb. Later we see how we use this <code>.jar</code> file, but let us now go back to the database.</p>
<h2 id="sql">SQL</h2>
<p>Having a <code>.jar</code> file for our application means that we can deploy it to the database and test and see what happens. However, there are a couple of things we need to do before that.</p>
<p>Remember from the code in <em>Code Snippet 11</em> how we send in a dataset with the relevant information about where to publish a message to. That information comes from tables in the database. Let us create the tables:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#859900">CREATE</span> <span style="color:#859900">TABLE</span> <span style="color:#268bd2">dbo</span>.<span style="color:#268bd2">tb_KafkaCluster</span>
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">ClusterID</span> <span style="color:#cb4b16">int</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">BootstrapServers</span> <span style="color:#268bd2">nvarchar</span>(<span style="color:#2aa198;font-weight:bold">4000</span>) <span style="color:#859900">NOT</span> <span style="color:#859900">NULL</span>,
</span></span><span style="display:flex;"><span>  [<span style="color:#268bd2">Description</span>] <span style="color:#268bd2">nvarchar</span>(<span style="color:#2aa198;font-weight:bold">4000</span>) <span style="color:#859900">NOT</span> <span style="color:#859900">NULL</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#859900">CONSTRAINT</span> [<span style="color:#268bd2">pk_KafkaCluster</span>] <span style="color:#859900">PRIMARY</span> <span style="color:#859900">KEY</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#268bd2">ClusterID</span>)
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span><span style="color:#859900">GO</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#859900">CREATE</span> <span style="color:#859900">TABLE</span> <span style="color:#268bd2">dbo</span>.<span style="color:#268bd2">tb_KafkaEventSubscriber</span>
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">SubscriberID</span> <span style="color:#cb4b16">int</span> <span style="color:#859900">identity</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">EventID</span> <span style="color:#cb4b16">int</span> <span style="color:#859900">NOT</span> <span style="color:#859900">NULL</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">ClusterID</span> <span style="color:#cb4b16">int</span> <span style="color:#859900">NOT</span> <span style="color:#859900">NULL</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">Topic</span> <span style="color:#268bd2">nvarchar</span>(<span style="color:#2aa198;font-weight:bold">256</span>) <span style="color:#859900">NOT</span> <span style="color:#859900">NULL</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#859900">CONSTRAINT</span> [<span style="color:#268bd2">pk_KafkaEventSubscriber</span>] <span style="color:#859900">PRIMARY</span> <span style="color:#859900">KEY</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#268bd2">EventID</span>, <span style="color:#268bd2">ClusterID</span>, <span style="color:#268bd2">Topic</span>),
</span></span><span style="display:flex;"><span>  <span style="color:#859900">CONSTRAINT</span> [<span style="color:#268bd2">fk_KafkaEventSubscriber_ClusterID</span>] 
</span></span><span style="display:flex;"><span>  <span style="color:#859900">FOREIGN</span> <span style="color:#859900">KEY</span> (<span style="color:#268bd2">ClusterID</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#859900">REFERENCES</span> <span style="color:#268bd2">dbo</span>.<span style="color:#268bd2">tb_KafkaCluster</span>(<span style="color:#268bd2">ClusterID</span>)
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span><span style="color:#859900">GO</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 14:</strong> <em>Routing Tables</em></p>
<p>The code in <em>Code Snippet 14</em> creates two tables which will contain information about who wants the different events, and where to send it to. Notice the <code>BootstrapServers</code> column in the <code>dbo.tb_KafkaCluster</code> table. That column contains the bootstrap servers as a comma-delimited string.</p>
<blockquote>
<p><strong>NOTE:</strong> The setup above is very simplistic. We should have a tables for different type of events, and with foreign key references to that table. Potentially also a table for topics. The <code>BootstrapServers</code> column is also a shortcut. We should have a separate table for the brokers with foreign key reference to the cluster table. However, for this blog-post, this is enough.</p>
</blockquote>
<p>When we have created the tables in <em>Code Snippet 14</em> we insert some data:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#859900">INSERT</span> <span style="color:#859900">INTO</span> <span style="color:#268bd2">dbo</span>.<span style="color:#268bd2">tb_KafkaCluster</span>(<span style="color:#268bd2">ClusterID</span>, <span style="color:#268bd2">BootstapServers</span>, 
</span></span><span style="display:flex;"><span>                               [<span style="color:#268bd2">Description</span>])
</span></span><span style="display:flex;"><span><span style="color:#859900">VALUES</span>(<span style="color:#2aa198;font-weight:bold">1</span>, <span style="color:#2aa198">&#39;localhost:9092&#39;</span>, <span style="color:#2aa198">&#39;First cluster&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#859900">INSERT</span> <span style="color:#859900">INTO</span> <span style="color:#268bd2">dbo</span>.<span style="color:#268bd2">tb_KafkaEventSubscriber</span>(<span style="color:#268bd2">EventID</span>, <span style="color:#268bd2">ClusterID</span>, 
</span></span><span style="display:flex;"><span>                                        <span style="color:#268bd2">Topic</span>)
</span></span><span style="display:flex;"><span><span style="color:#859900">VALUES</span> (<span style="color:#2aa198;font-weight:bold">1</span>, <span style="color:#2aa198;font-weight:bold">1</span>, <span style="color:#2aa198">&#39;testTopic&#39;</span>),
</span></span><span style="display:flex;"><span>       (<span style="color:#2aa198;font-weight:bold">1500</span>, <span style="color:#2aa198;font-weight:bold">1</span>, <span style="color:#2aa198">&#39;wagers&#39;</span>);
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 15:</strong> <em>Insert Data</em></p>
<p>As I run both SQL Server and Kafka on my local machine, I set the <code>BootstapServers</code> value to <code>localhost:9092</code> which we see in <em>Code Snippet 15</em>.</p>
<p>In the hook-point procedure, (<em>Code Snippet 4</em>), we can publish straight to Kafka, but that means we need the same publishing code in each event type&rsquo;s hook-point procedure. So let us instead create a procedure which does the actual publish to Kafka:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#859900">CREATE</span> <span style="color:#859900">PROCEDURE</span> <span style="color:#268bd2">dbo</span>.<span style="color:#268bd2">pr_PublishToKafka</span> @<span style="color:#268bd2">EventID</span> <span style="color:#cb4b16">int</span>,
</span></span><span style="display:flex;"><span>                                       @<span style="color:#268bd2">PartitionValue</span> <span style="color:#268bd2">nvarchar</span>(<span style="color:#2aa198;font-weight:bold">50</span>),
</span></span><span style="display:flex;"><span>                                       @<span style="color:#268bd2">EventMessage</span> <span style="color:#268bd2">nvarchar</span>(<span style="color:#859900">max</span>)
</span></span><span style="display:flex;"><span><span style="color:#859900">AS</span>
</span></span><span style="display:flex;"><span><span style="color:#859900">BEGIN</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#859900">IF</span>(@<span style="color:#268bd2">PartitionValue</span> = <span style="color:#2aa198">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#859900">BEGIN</span>
</span></span><span style="display:flex;"><span>    <span style="color:#859900">SET</span> @<span style="color:#268bd2">PartitionValue</span> = <span style="color:#859900">NULL</span>
</span></span><span style="display:flex;"><span>  <span style="color:#859900">END</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#859900">EXEC</span> <span style="color:#268bd2">sp_execute_external_script</span> 
</span></span><span style="display:flex;"><span>    @<span style="color:#859900">language</span> = <span style="color:#268bd2">N</span><span style="color:#2aa198">&#39;Java&#39;</span>,
</span></span><span style="display:flex;"><span>    @<span style="color:#268bd2">script</span> = <span style="color:#268bd2">N</span><span style="color:#2aa198">&#39;kafkapublish.SqlKafka&#39;</span>,
</span></span><span style="display:flex;"><span>    @<span style="color:#268bd2">input_data_1</span> = <span style="color:#268bd2">N</span><span style="color:#2aa198">&#39;SELECT kc.BootstrapServers, @partVal, 
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">                             kes.Topic
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">                      FROM dbo.tb_KafkaCluster kc
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">                      JOIN dbo.tb_KafkaEventSubscriber kes
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">                        ON kc.ClusterID = kes.ClusterID
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">                      WHERE kes.EventID =  @eventID &#39;</span>,
</span></span><span style="display:flex;"><span>    @<span style="color:#268bd2">params</span> = <span style="color:#268bd2">N</span><span style="color:#2aa198">&#39;@msg nvarchar(max), @eventID int, 
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">                @partVal nvarchar(50)&#39;</span>,
</span></span><span style="display:flex;"><span>    @<span style="color:#268bd2">eventID</span> = @<span style="color:#268bd2">EventID</span>,
</span></span><span style="display:flex;"><span>    @<span style="color:#268bd2">partVal</span> = @<span style="color:#268bd2">PartitionValue</span>,
</span></span><span style="display:flex;"><span>    @<span style="color:#268bd2">msg</span> = @<span style="color:#268bd2">EventMessage</span>;
</span></span><span style="display:flex;"><span><span style="color:#859900">END</span>
</span></span><span style="display:flex;"><span><span style="color:#859900">GO</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 16:</strong> <em>Procedure to Publish</em></p>
<p>In <em>Code Snippet 16</em> we see how we pass in parameters for what type of event it is, the partition value, and the event message. To publish to Kafka we use the procedure <code>sp_execute_external_script</code>, and in the procedure we:</p>
<ul>
<li>Set the language to Java.</li>
<li>Set the <code>@script</code> parameter to our package and class name.</li>
<li>Retrieve the broker and topic information for the event type, together with the partition value. This the <code>SELECT</code> statement in the <code>@input_data_1</code> oarameter.</li>
<li>Define parameters that we use in the <code>SELECT</code>, and also by our Java code, (the <code>@msg</code> parameter).</li>
</ul>
<p>Now we are almost done, and we alter the procedures to call into our hook-point procedure, and the publish procedure:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#859900">ALTER</span> <span style="color:#859900">PROCEDURE</span> <span style="color:#268bd2">dbo</span>.<span style="color:#268bd2">pr_LogWager</span> ...
</span></span><span style="display:flex;"><span><span style="color:#859900">AS</span>
</span></span><span style="display:flex;"><span><span style="color:#859900">BEGIN</span>
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#859900">BEGIN</span> <span style="color:#268bd2">TRY</span>
</span></span><span style="display:flex;"><span>    <span style="color:#859900">BEGIN</span> <span style="color:#268bd2">TRAN</span>
</span></span><span style="display:flex;"><span>      ...
</span></span><span style="display:flex;"><span>    <span style="color:#859900">COMMIT</span> <span style="color:#268bd2">TRAN</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#859900">EXEC</span> <span style="color:#268bd2">dbo</span>.<span style="color:#268bd2">pr_GenerateAndPublishWagerEvent</span> 
</span></span><span style="display:flex;"><span>                              @<span style="color:#268bd2">UserID</span> = @<span style="color:#268bd2">UserID</span>,
</span></span><span style="display:flex;"><span>                              @<span style="color:#268bd2">GameID</span> = @<span style="color:#268bd2">GameID</span>,
</span></span><span style="display:flex;"><span>                              @<span style="color:#268bd2">WagerAmount</span> = @<span style="color:#268bd2">WagerAmount</span>,
</span></span><span style="display:flex;"><span>                              @<span style="color:#268bd2">PayoutAmount</span> = @<span style="color:#268bd2">PayoutAmount</span>,
</span></span><span style="display:flex;"><span>                              @<span style="color:#268bd2">EventTime</span> = @<span style="color:#268bd2">EventTime</span>;
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#859900">END</span>  
</span></span><span style="display:flex;"><span><span style="color:#859900">GO</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#859900">ALTER</span> <span style="color:#859900">PROCEDURE</span> <span style="color:#268bd2">dbo</span>.<span style="color:#268bd2">pr_GenerateAndPublishWagerEvent</span> ... 
</span></span><span style="display:flex;"><span>                                
</span></span><span style="display:flex;"><span><span style="color:#859900">AS</span>
</span></span><span style="display:flex;"><span><span style="color:#859900">BEGIN</span>
</span></span><span style="display:flex;"><span>  <span style="color:#859900">DECLARE</span> @<span style="color:#268bd2">msg</span> <span style="color:#268bd2">nvarchar</span>(<span style="color:#859900">max</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#93a1a1;font-style:italic">--generate the event
</span></span></span><span style="display:flex;"><span><span style="color:#93a1a1;font-style:italic"></span>  <span style="color:#859900">SET</span> @<span style="color:#268bd2">msg</span> =  ...;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#859900">EXEC</span> <span style="color:#268bd2">dbo</span>.<span style="color:#268bd2">pr_PublishToKafka</span> @<span style="color:#268bd2">EventID</span> = <span style="color:#2aa198;font-weight:bold">1500</span>,
</span></span><span style="display:flex;"><span>                             @<span style="color:#268bd2">PartitionValue</span> = @<span style="color:#268bd2">UserID</span>,
</span></span><span style="display:flex;"><span>                             @<span style="color:#268bd2">EventMessage</span> = @<span style="color:#268bd2">msg</span>; 
</span></span><span style="display:flex;"><span><span style="color:#859900">END</span>
</span></span><span style="display:flex;"><span><span style="color:#859900">GO</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 17:</strong> <em>Altering Procedures</em></p>
<p>In the procedures in <em>Code Snippet 17</em> I have taken out the parameter definitions, and also left out some of the code for brevity. We see how <code>dbo.pr_LogWager</code> calls into <code>dbo.pr_GenerateAndPublishWagerEvent</code>, which calls into <code>dbo.pr_PublishToKafka</code>.</p>
<h2 id="deploy">Deploy</h2>
<p>We are now ready to deploy our Java code into the database. However, if this is the first time we deploy Java code to the database, we need to create Java as an external language in the database. I covered this in my post: 

<a href="/post/2019-06-06-sql-server-2019-extensibility-framework--external-languages/">SQL Server 2019 Extensibility Framework &amp; External Languages</a>. From reading that post, we see we need to:</p>
<ul>
<li>Create an archive file (<code>.zip</code>) of the Java language extension file <code>javaextension.dll</code>, which is located at <code>..\&lt;path_to_sql_instance&gt;\MSSQL\Binn\javaextension.dll</code>.</li>
<li>Deploy the zip file to the database using the <code>CREATE EXTERNAL LANGUAGE</code> syntax:</li>
</ul>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#859900">CREATE</span> <span style="color:#859900">EXTERNAL</span> <span style="color:#859900">LANGUAGE</span> <span style="color:#268bd2">Java</span>
</span></span><span style="display:flex;"><span><span style="color:#859900">FROM</span> (<span style="color:#268bd2">CONTENT</span> = <span style="color:#2aa198">&#39;W:\javaextension.zip&#39;</span>
</span></span><span style="display:flex;"><span>      , <span style="color:#268bd2">FILE_NAME</span> = <span style="color:#2aa198">&#39;javaextension.dll&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#859900">GO</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 18:</strong> <em>Creating External Language</em></p>
<p>I zipped the extension dll and placed it in the root of my <code>W:\</code> drive, and then called <code>CREATE EXTERNAL LANGUAGE</code>. We can check that it worked by calling <code>SELECT * FROM sys.external_languages</code>. If all is well we can go ahead.</p>
<blockquote>
<p><strong>NOTE:</strong> The name we assign to the language is as such of no importance, except that we use it in <code>sp_execute_external_script</code>, and as well as when we create external libraries, which we see below.</p>
</blockquote>
<p>Once again, if this is the first time we deploy Java to a database we also need to deploy the Java language SDK (<code>mssql-java-lang-extension.jar</code>), the one we used in our Java code above. For this, we use the <code>CREATE EXTERNAL LIBRARY</code>:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#859900">CREATE</span> <span style="color:#859900">EXTERNAL</span> <span style="color:#268bd2">LIBRARY</span> <span style="color:#268bd2">javaSDK</span> 
</span></span><span style="display:flex;"><span><span style="color:#859900">FROM</span> (<span style="color:#268bd2">CONTENT</span> = <span style="color:#2aa198">&#39;W:\mssql-java-lang-extension.jar&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#859900">WITH</span> (<span style="color:#859900">LANGUAGE</span> = <span style="color:#2aa198">&#39;Java&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#859900">GO</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 19:</strong> <em>Creating Java SDK Library</em></p>
<p>As in <em>Code Snippet 18</em>, I copied the SDK file to <code>W:\</code>, and then ran what we see in <em>Code Snippet 19</em>. The name we give the library does not matter, but it is a good idea to keep it somewhat descriptive. Use <code>SELECT * FROM sys.external_libraries</code> to ensure it worked.</p>
<p>Right, so finally we can deploy our application, and what we deploy is the <code>.jar</code> file we created just after <em>Code Snippet 13</em>:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#859900">CREATE</span> <span style="color:#859900">EXTERNAL</span> <span style="color:#268bd2">LIBRARY</span> <span style="color:#268bd2">javePublishToKafka</span> 
</span></span><span style="display:flex;"><span><span style="color:#859900">FROM</span> (<span style="color:#268bd2">CONTENT</span> = <span style="color:#2aa198">&#39;W:\SqlToKafka-1.0.jar&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#859900">WITH</span> (<span style="color:#859900">LANGUAGE</span> = <span style="color:#2aa198">&#39;Java&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#859900">GO</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 20:</strong> <em>Deploying the Application</em></p>
<p>We deploy the application by creating an external library, as we see in <em>Code Snippet 20</em>, and yes, I copied the <code>.jar</code> file to <code>W:\</code> this time as well.</p>
<h2 id="run-the-application">Run the Application</h2>
<p>So finally, it is time to see what we have done works. Start with &ldquo;spinning up&rdquo; a Kafka consumer against the <code>wagers</code> topic. Use similar code to what we see in <em>Code Snippet 7</em>, but change <code>--topics testTopic</code> to <code>--topics wagers</code>. When the Kafka consumer is up and listening, it is time to see if it works:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#268bd2">dbo</span>.<span style="color:#268bd2">pr_EmulateGamePlay</span> @<span style="color:#268bd2">Loops</span> = <span style="color:#2aa198;font-weight:bold">5</span>,
</span></span><span style="display:flex;"><span>                       @<span style="color:#268bd2">MinDelay</span> = <span style="color:#2aa198;font-weight:bold">50</span>,
</span></span><span style="display:flex;"><span>                       @<span style="color:#268bd2">MaxDelay</span> = <span style="color:#2aa198;font-weight:bold">500</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 21:</strong> <em>Emulate Game Play</em></p>
<p>In <em>Code Snippet 21</em> we see a procedure which emulates gameplay, and it expects some parameters:</p>
<ul>
<li><code>@Loops</code> - In the procedure, we loop around <code>dbo.pr_LogWager</code> and passes in random values for the required parameters in <code>dbo.pr_LogWager</code>.</li>
<li><code>@MinDelay</code>, <code>@MaxDelay</code> - in the procedure we do a random wait between each loop and these two parameters define min, and max values, (milliseconds).</li>
</ul>
<p>Let us see if we get any output from the Kafka consumer when we execute the code in <em>Code Snippet 21</em>:</p>
<p>
  <img src="/images/posts/sql_kafka_extlang_publish_output.png" alt="">

</p>
<p><strong>Figure 4:</strong> <em>Kafka Output</em></p>
<p>Yes! From what we see in <em>Figure 4</em> it works, as we see 5 events as output. We have succeeded in streaming data out from the database into Kafka by using SQL Server Extensibility Framework and the Java external language.</p>
<blockquote>
<p><strong>NOTE:</strong> You may ask what the <code>dbo.pr_EmulateGamePlay</code> looks like. I have included the source for that procedure at the very end of this post as an Appendix.</p>
</blockquote>
<h2 id="summary">Summary</h2>
<p>There are various ways one can get data out of SQL Server and into the streaming world. In this blog post, we looked at using SQL Server&rsquo;s Extensibility framework and Java as an external language.</p>
<p>We looked at:</p>
<ul>
<li>Creating hook-point procedures and injecting them into the procedures whose data we want to capture and create events from.</li>
<li>Using the Java Kafka client to publish data.</li>
<li>Adding a dependency in the Java project against the Microsoft Java SDK.</li>
<li>Creating an &ldquo;uber jar&rdquo; containing all Java dependencies, except for the Java SDK. The actual application should also be in that &ldquo;uber jar&rdquo;.</li>
<li>Creating the Java language in the database.</li>
<li>Deploying the Java SDK to the database.</li>
<li>Deploying the &ldquo;uber jar&rdquo; to the database.</li>
<li>Using <code>sp_execute_external_script</code> to call into the Java code from SQL Server.</li>
</ul>
<p>As I mentioned above, there are various ways to &ldquo;free&rdquo; your data, and we look at other ways in future posts.</p>
<h2 id="-finally">~ Finally</h2>
<p>If you have comments, questions etc., please comment on this post or 

<a href="mailto:niels.it.berglund@gmail.com">ping</a> me.</p>
<h2 id="appendix---i">Appendix - I</h2>
<p>Below is the code for the <code>dbo.pr_EmulateGamePlay</code> procedure:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#859900">CREATE</span> <span style="color:#859900">PROCEDURE</span> <span style="color:#268bd2">dbo</span>.<span style="color:#268bd2">pr_EmulateGamePlay</span> @<span style="color:#268bd2">Loops</span> <span style="color:#cb4b16">int</span> = <span style="color:#2aa198;font-weight:bold">10</span>,
</span></span><span style="display:flex;"><span>                                        @<span style="color:#268bd2">MinDelay</span> <span style="color:#cb4b16">int</span> = <span style="color:#2aa198;font-weight:bold">50</span>,
</span></span><span style="display:flex;"><span>                                        @<span style="color:#268bd2">MaxDelay</span> <span style="color:#cb4b16">int</span> = <span style="color:#2aa198;font-weight:bold">500</span>
</span></span><span style="display:flex;"><span><span style="color:#859900">AS</span>
</span></span><span style="display:flex;"><span><span style="color:#859900">BEGIN</span>                                        
</span></span><span style="display:flex;"><span>  <span style="color:#859900">DECLARE</span> @<span style="color:#268bd2">delay</span> <span style="color:#cb4b16">int</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#859900">DECLARE</span> @<span style="color:#268bd2">waitfor</span> <span style="color:#cb4b16">varchar</span>(<span style="color:#2aa198;font-weight:bold">25</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#859900">DECLARE</span> @<span style="color:#268bd2">winMultiplier</span> <span style="color:#cb4b16">int</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#859900">DECLARE</span> @<span style="color:#268bd2">wager</span> <span style="color:#cb4b16">decimal</span>(<span style="color:#2aa198;font-weight:bold">10</span>, <span style="color:#2aa198;font-weight:bold">2</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#859900">DECLARE</span> @<span style="color:#268bd2">userId</span> <span style="color:#cb4b16">int</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#859900">DECLARE</span> @<span style="color:#268bd2">gameId</span> <span style="color:#cb4b16">int</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#859900">DECLARE</span> @<span style="color:#268bd2">payout</span> <span style="color:#cb4b16">decimal</span>(<span style="color:#2aa198;font-weight:bold">10</span>, <span style="color:#2aa198;font-weight:bold">2</span>) = <span style="color:#2aa198;font-weight:bold">0</span>.<span style="color:#2aa198;font-weight:bold">00</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#859900">DECLARE</span> @<span style="color:#268bd2">minUserId</span> <span style="color:#cb4b16">int</span> = <span style="color:#2aa198;font-weight:bold">100</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#859900">DECLARE</span> @<span style="color:#268bd2">maxUserId</span> <span style="color:#cb4b16">int</span> = <span style="color:#2aa198;font-weight:bold">125</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#859900">DECLARE</span> @<span style="color:#268bd2">minwager</span> <span style="color:#cb4b16">int</span> = <span style="color:#2aa198;font-weight:bold">25</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#859900">DECLARE</span> @<span style="color:#268bd2">maxwager</span> <span style="color:#cb4b16">int</span> = <span style="color:#2aa198;font-weight:bold">5000</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#859900">DECLARE</span> @<span style="color:#268bd2">minWinMult</span> <span style="color:#cb4b16">int</span> = <span style="color:#2aa198;font-weight:bold">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#859900">DECLARE</span> @<span style="color:#268bd2">maxWinMult</span> <span style="color:#cb4b16">int</span> = <span style="color:#2aa198;font-weight:bold">10</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#859900">DECLARE</span> @<span style="color:#268bd2">minGameId</span> <span style="color:#cb4b16">int</span> = <span style="color:#2aa198;font-weight:bold">1000</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#859900">DECLARE</span> @<span style="color:#268bd2">maxGameId</span> <span style="color:#cb4b16">int</span> = <span style="color:#2aa198;font-weight:bold">1050</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#859900">DECLARE</span> @<span style="color:#268bd2">minWinIndicator</span> <span style="color:#cb4b16">int</span> = <span style="color:#2aa198;font-weight:bold">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#859900">DECLARE</span> @<span style="color:#268bd2">maxWinIndicator</span> <span style="color:#cb4b16">int</span> = <span style="color:#2aa198;font-weight:bold">12</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#859900">DECLARE</span> @<span style="color:#268bd2">noLoops</span> <span style="color:#cb4b16">int</span> = <span style="color:#2aa198;font-weight:bold">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#859900">DECLARE</span> @<span style="color:#268bd2">eventTime</span> <span style="color:#268bd2">datetime2</span>;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">WHILE</span>(@<span style="color:#268bd2">noLoops</span> &lt; @<span style="color:#268bd2">Loops</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#859900">BEGIN</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#859900">SET</span> @<span style="color:#268bd2">eventTime</span> = <span style="color:#268bd2">SYSUTCDATETIME</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#93a1a1;font-style:italic">-- get random values for delay between games, 
</span></span></span><span style="display:flex;"><span><span style="color:#93a1a1;font-style:italic"></span>  <span style="color:#93a1a1;font-style:italic">-- wager size, user id, game id,
</span></span></span><span style="display:flex;"><span><span style="color:#93a1a1;font-style:italic"></span>  <span style="color:#93a1a1;font-style:italic">-- win multiplier
</span></span></span><span style="display:flex;"><span><span style="color:#93a1a1;font-style:italic"></span>    <span style="color:#859900">SELECT</span> @<span style="color:#268bd2">delay</span> = @<span style="color:#268bd2">MinDelay</span> + <span style="color:#268bd2">ROUND</span>(<span style="color:#268bd2">RAND</span>() * 
</span></span><span style="display:flex;"><span>                   (@<span style="color:#268bd2">MaxDelay</span> + <span style="color:#2aa198;font-weight:bold">1</span> - @<span style="color:#268bd2">MinDelay</span>), <span style="color:#2aa198;font-weight:bold">0</span>),
</span></span><span style="display:flex;"><span>            @<span style="color:#268bd2">wager</span> = (@<span style="color:#268bd2">minwager</span> + <span style="color:#268bd2">ROUND</span>(<span style="color:#268bd2">RAND</span>() * 
</span></span><span style="display:flex;"><span>                     (@<span style="color:#268bd2">maxwager</span> + <span style="color:#2aa198;font-weight:bold">1</span> - @<span style="color:#268bd2">minwager</span>), <span style="color:#2aa198;font-weight:bold">0</span>)) / <span style="color:#2aa198;font-weight:bold">100</span>,
</span></span><span style="display:flex;"><span>            @<span style="color:#268bd2">userId</span> = @<span style="color:#268bd2">minUserId</span> + <span style="color:#268bd2">ROUND</span>(<span style="color:#268bd2">RAND</span>() * 
</span></span><span style="display:flex;"><span>                      (@<span style="color:#268bd2">maxUserId</span> + <span style="color:#2aa198;font-weight:bold">1</span> - @<span style="color:#268bd2">minUserId</span>), <span style="color:#2aa198;font-weight:bold">0</span>),
</span></span><span style="display:flex;"><span>            @<span style="color:#268bd2">gameId</span> = @<span style="color:#268bd2">minGameId</span> + <span style="color:#268bd2">ROUND</span>(<span style="color:#268bd2">RAND</span>() * 
</span></span><span style="display:flex;"><span>                      (@<span style="color:#268bd2">maxGameId</span> + <span style="color:#2aa198;font-weight:bold">1</span> - @<span style="color:#268bd2">minGameId</span>), <span style="color:#2aa198;font-weight:bold">0</span>),
</span></span><span style="display:flex;"><span>            @<span style="color:#268bd2">winMultiplier</span> = @<span style="color:#268bd2">minWinMult</span> + <span style="color:#268bd2">ROUND</span>(<span style="color:#268bd2">RAND</span>() * 
</span></span><span style="display:flex;"><span>                            (@<span style="color:#268bd2">maxWinMult</span> + <span style="color:#2aa198;font-weight:bold">1</span> - @<span style="color:#268bd2">minWinMult</span>), <span style="color:#2aa198;font-weight:bold">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#93a1a1;font-style:italic">-- set up the waitfor variable
</span></span></span><span style="display:flex;"><span><span style="color:#93a1a1;font-style:italic"></span>    <span style="color:#859900">SELECT</span> @<span style="color:#268bd2">waitfor</span> = <span style="color:#268bd2">FORMATMESSAGE</span>(<span style="color:#2aa198">&#39;00:00:00.%i&#39;</span>, @<span style="color:#268bd2">delay</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#93a1a1;font-style:italic">--check if win
</span></span></span><span style="display:flex;"><span><span style="color:#93a1a1;font-style:italic"></span>    <span style="color:#859900">IF</span>(<span style="color:#859900">CAST</span>((@<span style="color:#268bd2">minWinIndicator</span> + <span style="color:#268bd2">ROUND</span>(<span style="color:#268bd2">RAND</span>() * 
</span></span><span style="display:flex;"><span>             (@<span style="color:#268bd2">maxWinIndicator</span> + <span style="color:#2aa198;font-weight:bold">1</span> - @<span style="color:#268bd2">minWinIndicator</span>), 
</span></span><span style="display:flex;"><span>                 <span style="color:#2aa198;font-weight:bold">0</span>)) <span style="color:#859900">AS</span> <span style="color:#cb4b16">int</span>) % <span style="color:#2aa198;font-weight:bold">3</span>) = <span style="color:#2aa198;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#859900">BEGIN</span>
</span></span><span style="display:flex;"><span>        <span style="color:#859900">SET</span> @<span style="color:#268bd2">payout</span> =   @<span style="color:#268bd2">wager</span> * @<span style="color:#268bd2">winMultiplier</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#859900">END</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#859900">EXEC</span> <span style="color:#268bd2">dbo</span>.<span style="color:#268bd2">pr_LogWager</span>    @<span style="color:#268bd2">UserID</span> = @<span style="color:#268bd2">userId</span>,
</span></span><span style="display:flex;"><span>                            @<span style="color:#268bd2">GameID</span> = @<span style="color:#268bd2">gameId</span>,
</span></span><span style="display:flex;"><span>                            @<span style="color:#268bd2">WagerAmount</span> = @<span style="color:#268bd2">wager</span>,
</span></span><span style="display:flex;"><span>                            @<span style="color:#268bd2">PayoutAmount</span> = @<span style="color:#268bd2">payout</span>,
</span></span><span style="display:flex;"><span>                            @<span style="color:#268bd2">EventTime</span> = @<span style="color:#268bd2">eventTime</span>;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    <span style="color:#859900">SELECT</span> @<span style="color:#268bd2">noLoops</span> += <span style="color:#2aa198;font-weight:bold">1</span>, @<span style="color:#268bd2">delay</span> = <span style="color:#859900">null</span>, @<span style="color:#268bd2">wager</span> = <span style="color:#859900">null</span>, 
</span></span><span style="display:flex;"><span>           @<span style="color:#268bd2">userId</span> = <span style="color:#859900">null</span>, @<span style="color:#268bd2">gameId</span> = <span style="color:#859900">null</span>, @<span style="color:#268bd2">winMultiplier</span> = <span style="color:#859900">null</span>,  
</span></span><span style="display:flex;"><span>         @<span style="color:#268bd2">waitfor</span> = <span style="color:#2aa198">&#39;&#39;</span>, @<span style="color:#268bd2">payout</span> = <span style="color:#2aa198;font-weight:bold">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">WAITFOR</span> <span style="color:#268bd2">DELAY</span> @<span style="color:#268bd2">waitfor</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#859900">END</span>
</span></span><span style="display:flex;"><span><span style="color:#859900">END</span>  
</span></span><span style="display:flex;"><span><span style="color:#859900">GO</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 22:</strong> <em>Procedure to Generate Game Play</em></p>
<p>As we see in <em>Code Snippet 22</em>, the procedure is looping, and in each loop, it generates some random values based on min and max setting variables.</p>

                

                
                <hr>
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/post/2019-07-14-interesting-stuff---week-28-2019/" data-toggle="tooltip" data-placement="top" title="Interesting Stuff - Week 28, 2019">&larr;
                            Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/post/2019-07-21-interesting-stuff---week-29-2019/" data-toggle="tooltip" data-placement="top" title="Interesting Stuff - Week 29, 2019">Next
                            Post &rarr;</a>
                    </li>
                    
                </ul>
                

                


<div id="disqus-comment"></div>
<div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "manageddata" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


            </div>

            
            
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
            

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                
                

                
                
            </div>
        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">                  
                    
                    <li>
                        <a href="mailto:niels.it.berglund@gmail.com">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		           
                    
                    <li>
                        <a href="https://twitter.com/nielsberglund">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    

		            
                    
                    
                    <li>
                        <a target="_blank" href="https://github.com/nielsberglund">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		            
                    
                    
                    
                    <li>
                        <a target="_blank" href="https://www.linkedin.com/in/niels-berglund-0122593">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		           
                    
                    <li>
                        <a target="_blank" href="https://medium.com/@nielsberglund">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-medium fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a target="_blank" href="https://stackoverflow.com/users/7656880/niels-berglund">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-stack-overflow fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    
                    <li>
                        <a target="_blank" href="https://fosstodon.org/@nielsb">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-mastodon fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
            
            
            
           
           <li>
             <a target="_blank" href="https://nielsberglund.com/index.xml">
                <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
                </span>
             </a>
           </li>
           
             </ul>
		<p class="copyright text-muted">
                    Copyright &copy; Niels Berglund 2026
                    <br>
                    <a href="https://themes.gohugo.io/hugo-theme-cleanwhite">CleanWhite Hugo Theme</a> by <a href="https://zhaohuabing.com">Huabing</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>




<script>
    function loadAsync(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        loadAsync("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>






<script type="text/javascript">
    function generateCatalog(selector) {

        
        
        
        
            _containerSelector = 'div.post-container'
        

        
        var P = $(_containerSelector), a, n, t, l, i, c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        
        $(selector).html('')

        
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#" + $(this).prop('id');
            t = $(this).text();
            c = $('<a href="' + i + '" rel="nofollow">' + t + '</a>');
            l = $('<li class="' + n + '_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    
    $(".catalog-toggle").click((function (e) {
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    


    loadAsync("\/js\/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>







<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ 
    startOnLoad: true,
    theme: 'default',
    securityLevel: 'loose'  
  });
</script>
</body>
</html>
