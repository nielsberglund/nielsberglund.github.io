<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <meta property="og:site_name" content="Niels Berglund">
    <meta property="og:type" content="article">

    
    <meta property="og:image" content="https://nielsberglund.com//images/banner/main-banner-2.jpg">
    <meta property="twitter:image" content="https://nielsberglund.com//images/banner/main-banner-2.jpg" />
    

    
    <meta name="title" content="Microsoft SQL Server R Services - Internals V" />
    <meta property="og:title" content="Microsoft SQL Server R Services - Internals V" />
    <meta property="twitter:title" content="Microsoft SQL Server R Services - Internals V" />
    

    
    <meta name="description" content="More about the launchpad service and RTerm processes in relation to parallelism in SQL Server R Services.">
    <meta property="og:description" content="More about the launchpad service and RTerm processes in relation to parallelism in SQL Server R Services." />
    <meta property="twitter:description" content="More about the launchpad service and RTerm processes in relation to parallelism in SQL Server R Services." />
    

    
    <meta property="twitter:card" content="summary" />
    
    

    <meta name="keyword"  content="SQL Server, .NET, Kafka, Streaming, Azure Data Explorer, AI/ML">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>Microsoft SQL Server R Services - Internals V | Niels Berglund</title>

    <link rel="canonical" href="/post/2017-05-01-microsoft-sql-server-r-services---internals-v/">

    
    
    
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="/css/hugo-theme-cleanwhite.min.css">

    
    <link rel="stylesheet" href="/css/zanshang.css">

    
    <link rel="stylesheet" href="/css/font-awesome.all.min.css">

    
    

    
    <script src="/js/jquery.min.js"></script>

    
    <script src="/js/bootstrap.min.js"></script>

    
    <script src="/js/hux-blog.min.js"></script>

    
    <script src="/js/lazysizes.min.js"></script>

    
    

</head>








<nav class="navbar navbar-default navbar-custom navbar-fixed-top">

    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Niels Berglund</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">All Posts</a>
                    </li>
                    
                    
		    
                        <li><a href="/series//">BLOG SERIES</a></li>
                    
                        <li><a href="/top/about//">ABOUT ME</a></li>
                    
                        <li><a href="/top/archive//">ARCHIVE</a></li>
                    
                        <li><a href="/top/disclaimer//">DISCLAIMER</a></li>
                    
		            <li>
                        <a href="/search"><i class="fa fa-search"></i></a>
		           </li>
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>




<style type="text/css">
    header.intro-header {
        background-image: url('/images/banner/main-banner-2.jpg')
    }
</style>

<header class="intro-header" >

    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/sql-server-r-services" title="SQL Server R Services">
                            SQL Server R Services
                        </a>
                        
                        <a class="tag" href="/tags/sql-server-machine-learning-services" title="SQL Server Machine Learning Services">
                            SQL Server Machine Learning Services
                        </a>
                        
                        <a class="tag" href="/tags/r" title="R">
                            R
                        </a>
                        
                        <a class="tag" href="/tags/windbg" title="WinDbg">
                            WinDbg
                        </a>
                        
                        <a class="tag" href="/tags/launchpad" title="Launchpad">
                            Launchpad
                        </a>
                        
                        <a class="tag" href="/tags/rterm.exe" title="RTerm.exe">
                            RTerm.exe
                        </a>
                        
                    </div>
                    <h1>Microsoft SQL Server R Services - Internals V</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        
                            Posted by 
                            
                                nielsb
                             
                            on 
                            Monday, May 1, 2017
                            
                            
                            
                            
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                
                <p>This is the sixth post in a series about <strong>Microsoft SQL Server R Services</strong>, and the fifth post that drills down into the internal of how it works. To see other posts (including this) in the series, go to 

<a href="/sql_server_2k16_r_services"><strong>SQL Server R Services</strong></a>.</p>
<p>In 

<a href="/post/2017-04-13-microsoft-sql-server-r-services---internals-iii/">Internals - III</a> and 

<a href="/post/2017-04-23-microsoft-sql-server-r-services---internals-iv/">Internals - IV</a>, we looked at how the launchpad service creates <strong>RTerm</strong> processes when we execute an external script.</p>
<p>The 

<a href="/post/2017-04-23-microsoft-sql-server-r-services---internals-iv/">Internals - IV</a> post came about due to an email from Bob Albright (

<a href="https://twitter.com/bob_albright" target="_blank" rel="noopener">@bob_albright</a>), pointing me to some resources (a blog-post) regarding the processes the launchpad service creates.</p>
<p>In his email Bob also, kindly enough, attached some code. The code highlighted some behavior when creating the RTerm processes, especially around parallelism. In this blog-post we&rsquo;ll follow up on that and look into the effect parallelism has on process creation.</p>
<h2 id="recap">Recap</h2>
<p>In 

<a href="/post/2017-04-23-microsoft-sql-server-r-services---internals-iv/">Internals - IV</a>, we saw how:</p>
<ul>
<li>The launchpad service creates by default 6 RTerm processes when an external script is executed by a user. One of the processes will be used for the execution of the script and torn down afterwards. The other 5 is added to the process pool. In essence the launchpad service creates 5 + 1.</li>
<li>If more (or less) processes than 5 is needed, a setting <code>PROCESS_POOL_SQLSATELLITE_GROWTH</code> can be set in <code>rlauncher.config</code>. The value of the setting defines number of processes to create (as with default it will be setting value + 1).</li>
<li>When a user executes subsequent requests, or concurrent requests from different sessions, processes are picked up and used from the pool.
<ul>
<li>The launchpad service simultaneously creates a new process.</li>
</ul>
</li>
</ul>
<p>Previously I had the assumption that &ldquo;somehow&rdquo; the number of processes created had to be configurable, and that the reason for creating multiple processes has to do with performance.</p>
<p>In the post we verified that, and this was much due to the 

<a href="https://blogs.msdn.microsoft.com/microsoftrservertigerteam/2016/09/20/tips-sql-r-services-optimization-for-concurrent-execution-of-in-database-analytics-using-sp_execute_external_script/" target="_blank" rel="noopener">blog-post</a> Bob pointed to in his - previously mentioned - email. That particular post also briefly mentioned <code>MAXDOP</code>, and what to think about in terms of pool size. That and Bob&rsquo;s code lead to this blog-post.</p>
<h2 id="code">Code</h2>
<p>Before diving into the &ldquo;stuff&rdquo;, let&rsquo;s look at the code we&rsquo;ll use. The code we have used in previous posts has been very, very minimal. Today we&rsquo;ll be &ldquo;very advanced&rdquo; and select data from a table in a database - talk about cutting edge!! What we want to do is to execute some linear regression functions against data, and see what happens in different scenarios.</p>
<p>In <em>Code Snippet 1</em> below, we set up the database and a table with some data we can use, all in all 30 million records:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#268bd2">USE</span> <span style="color:#268bd2">master</span>;
</span></span><span style="display:flex;"><span><span style="color:#859900">GO</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#859900">SET</span> <span style="color:#268bd2">NOCOUNT</span> <span style="color:#859900">ON</span>;
</span></span><span style="display:flex;"><span><span style="color:#859900">GO</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#859900">DROP</span> <span style="color:#859900">DATABASE</span> <span style="color:#859900">IF</span> <span style="color:#859900">EXISTS</span> <span style="color:#268bd2">TestParallel</span>;
</span></span><span style="display:flex;"><span><span style="color:#859900">GO</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#859900">CREATE</span> <span style="color:#859900">DATABASE</span> <span style="color:#268bd2">TestParallel</span>;
</span></span><span style="display:flex;"><span><span style="color:#859900">GO</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">USE</span> <span style="color:#268bd2">TestParallel</span>;
</span></span><span style="display:flex;"><span><span style="color:#859900">GO</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#859900">DROP</span> <span style="color:#859900">TABLE</span> <span style="color:#859900">IF</span> <span style="color:#859900">EXISTS</span> <span style="color:#268bd2">dbo</span>.<span style="color:#268bd2">rand_30M</span>
</span></span><span style="display:flex;"><span><span style="color:#859900">CREATE</span> <span style="color:#859900">TABLE</span> <span style="color:#268bd2">dbo</span>.<span style="color:#268bd2">rand_30M</span>(<span style="color:#268bd2">RowID</span> <span style="color:#cb4b16">bigint</span> <span style="color:#859900">identity</span> <span style="color:#859900">primary</span> <span style="color:#859900">key</span>, <span style="color:#268bd2">y</span> <span style="color:#cb4b16">int</span>, 
</span></span><span style="display:flex;"><span>                          <span style="color:#268bd2">rand1</span> <span style="color:#cb4b16">int</span>, <span style="color:#268bd2">rand2</span> <span style="color:#cb4b16">int</span>, <span style="color:#268bd2">rand3</span> <span style="color:#cb4b16">int</span>, <span style="color:#268bd2">rand4</span> <span style="color:#cb4b16">int</span>, 
</span></span><span style="display:flex;"><span>                          <span style="color:#268bd2">rand5</span> <span style="color:#cb4b16">int</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#859900">INSERT</span> <span style="color:#859900">INTO</span> <span style="color:#268bd2">dbo</span>.<span style="color:#268bd2">rand_30M</span>(<span style="color:#268bd2">y</span>, <span style="color:#268bd2">rand1</span>, <span style="color:#268bd2">rand2</span>, <span style="color:#268bd2">rand3</span>, <span style="color:#268bd2">rand4</span>, <span style="color:#268bd2">rand5</span>)
</span></span><span style="display:flex;"><span><span style="color:#859900">SELECT</span> <span style="color:#268bd2">TOP</span>(<span style="color:#2aa198;font-weight:bold">30000000</span>) <span style="color:#859900">CAST</span>(<span style="color:#859900">ABS</span>(<span style="color:#268bd2">CHECKSUM</span>(<span style="color:#268bd2">NEWID</span>())) % <span style="color:#2aa198;font-weight:bold">14</span> <span style="color:#859900">AS</span> <span style="color:#cb4b16">INT</span>) 
</span></span><span style="display:flex;"><span>  , <span style="color:#859900">CAST</span>(<span style="color:#859900">ABS</span>(<span style="color:#268bd2">CHECKSUM</span>(<span style="color:#268bd2">NEWID</span>())) % <span style="color:#2aa198;font-weight:bold">20</span> <span style="color:#859900">AS</span> <span style="color:#cb4b16">INT</span>)
</span></span><span style="display:flex;"><span>  , <span style="color:#859900">CAST</span>(<span style="color:#859900">ABS</span>(<span style="color:#268bd2">CHECKSUM</span>(<span style="color:#268bd2">NEWID</span>())) % <span style="color:#2aa198;font-weight:bold">25</span> <span style="color:#859900">AS</span> <span style="color:#cb4b16">INT</span>)
</span></span><span style="display:flex;"><span>  , <span style="color:#859900">CAST</span>(<span style="color:#859900">ABS</span>(<span style="color:#268bd2">CHECKSUM</span>(<span style="color:#268bd2">NEWID</span>())) % <span style="color:#2aa198;font-weight:bold">14</span> <span style="color:#859900">AS</span> <span style="color:#cb4b16">INT</span>)
</span></span><span style="display:flex;"><span>  , <span style="color:#859900">CAST</span>(<span style="color:#859900">ABS</span>(<span style="color:#268bd2">CHECKSUM</span>(<span style="color:#268bd2">NEWID</span>())) % <span style="color:#2aa198;font-weight:bold">50</span> <span style="color:#859900">AS</span> <span style="color:#cb4b16">INT</span>)
</span></span><span style="display:flex;"><span>  , <span style="color:#859900">CAST</span>(<span style="color:#859900">ABS</span>(<span style="color:#268bd2">CHECKSUM</span>(<span style="color:#268bd2">NEWID</span>())) % <span style="color:#2aa198;font-weight:bold">100</span> <span style="color:#859900">AS</span> <span style="color:#cb4b16">INT</span>)
</span></span><span style="display:flex;"><span><span style="color:#859900">FROM</span> <span style="color:#268bd2">sys</span>.<span style="color:#268bd2">objects</span> <span style="color:#268bd2">o1</span>
</span></span><span style="display:flex;"><span><span style="color:#859900">CROSS</span> <span style="color:#859900">JOIN</span> <span style="color:#268bd2">sys</span>.<span style="color:#268bd2">objects</span> <span style="color:#268bd2">o2</span>
</span></span><span style="display:flex;"><span><span style="color:#859900">CROSS</span> <span style="color:#859900">JOIN</span> <span style="color:#268bd2">sys</span>.<span style="color:#268bd2">objects</span> <span style="color:#268bd2">o3</span>
</span></span><span style="display:flex;"><span><span style="color:#859900">CROSS</span> <span style="color:#859900">JOIN</span> <span style="color:#268bd2">sys</span>.<span style="color:#268bd2">objects</span> <span style="color:#268bd2">o4</span>;
</span></span><span style="display:flex;"><span><span style="color:#859900">GO</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 1:</strong> <em>Setup of Database, Table and Data</em></p>
<p>The data is completely &ldquo;useless&rdquo;, but it can at least be used for analysis work, it looks something like so (just a few rows):</p>
<p>!{}(/images/posts/sql_r_services_random_data.png)</p>
<p><strong>Figure 1:</strong> <em>10 Rows Random Data</em></p>
<p>What we want to do with the data is to create a linear regression model over it, where - ultimately - we want to predict the value of <code>y</code>, and we believe <code>y</code> is related to <code>rand1</code>, <code>rand2</code>, <code>rand3</code>,  <code>rand4</code> and <code>rand5</code>. In our examples we are not really interested in <code>y</code>, but we want to see what the <strong>intercept</strong> value(s) is. If we used open source R (CRAN R), the code for this would look something like so:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#268bd2">r</span> &lt;- <span style="color:#268bd2">lm</span>(<span style="color:#268bd2">y</span> ~ <span style="color:#268bd2">rand1</span> + <span style="color:#268bd2">rand2</span> + <span style="color:#268bd2">rand3</span> + <span style="color:#268bd2">rand4</span> + <span style="color:#268bd2">rand5</span>, <span style="color:#268bd2">data</span>=&lt;<span style="color:#268bd2">some</span> <span style="color:#268bd2">input</span> <span style="color:#268bd2">data</span>&gt;);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#93a1a1;font-style:italic"># get the coefficients</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">coef</span> &lt;- <span style="color:#268bd2">r</span>$<span style="color:#268bd2">coefficients</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#93a1a1;font-style:italic"># the intercept value is first value in the coefficients vector</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">icept</span> &lt;- <span style="color:#268bd2">coef[1]</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#93a1a1;font-style:italic"># return the data</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">out_data</span> &lt;- <span style="color:#268bd2">data.frame</span>(<span style="color:#268bd2">intercept</span>=<span style="color:#268bd2">icept</span>);
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 2:</strong> <em>Linear Regression Using CRAN R</em></p>
<p>Seeing that this is about SQL Server R Services, we should be using the equivalent RevoScaleR function: <code>rxLinMod</code>: <code>r &lt;- rxLinMod(y ~ rand1 + rand2 + rand3 + rand4 + rand5, data=&lt;some input data&gt;);</code>, and we would execute it from <code>sp_execute_external_script</code>:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#859900">DECLARE</span> @<span style="color:#859900">start</span> <span style="color:#268bd2">datetime2</span> = <span style="color:#268bd2">SYSUTCDATETIME</span>();
</span></span><span style="display:flex;"><span><span style="color:#859900">EXEC</span> <span style="color:#268bd2">sp_execute_external_script</span>
</span></span><span style="display:flex;"><span>          @<span style="color:#859900">language</span> = <span style="color:#268bd2">N</span><span style="color:#2aa198">&#39;R&#39;</span>
</span></span><span style="display:flex;"><span>        , @<span style="color:#268bd2">script</span> = <span style="color:#268bd2">N</span><span style="color:#2aa198">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">             #Sys.sleep(30)
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">             pid &lt;- Sys.getpid()
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">             r &lt;- rxLinMod(y ~ rand1 + rand2 + rand3 + rand4 + rand5, 
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">                           data=InputDataSet)
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198"> 
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">             coef &lt;- r$coefficients
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">             icept &lt;- coef\[1\];
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">              OutputDataSet &lt;- data.frame(pid=pid, nRows=r$nValidObs, 
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">                                          intercept=icept)&#39;</span>
</span></span><span style="display:flex;"><span>       , @<span style="color:#268bd2">input_data_1</span> = <span style="color:#268bd2">N</span><span style="color:#2aa198">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">              SELECT  y, rand1, rand2, rand3, 
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">                      rand4, rand5 
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">              FROM dbo.rand_30M&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#859900">WITH</span> <span style="color:#859900">RESULT</span> <span style="color:#859900">SETS</span> ((<span style="color:#268bd2">pid</span> <span style="color:#cb4b16">INT</span> <span style="color:#859900">NOT</span> <span style="color:#859900">NULL</span>, <span style="color:#268bd2">nRows</span> <span style="color:#cb4b16">INT</span> <span style="color:#859900">NOT</span> <span style="color:#859900">NULL</span>, <span style="color:#268bd2">intercept</span> <span style="color:#cb4b16">FLOAT</span> <span style="color:#859900">NULL</span>)
</span></span><span style="display:flex;"><span>); 
</span></span><span style="display:flex;"><span><span style="color:#859900">SELECT</span> <span style="color:#268bd2">DATEDIFF</span>(<span style="color:#268bd2">ms</span>, @<span style="color:#859900">start</span>, <span style="color:#268bd2">SYSUTCDATETIME</span>()) <span style="color:#859900">AS</span> <span style="color:#268bd2">ElapsedTime</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 3:</strong> <em>Linear Regression in SQL Server</em></p>
<p>So the code in <em>Code Snippet 3</em> is what we will &ldquo;play&rdquo; around with in this post. Some comments:</p>
<ul>
<li>First line of the script (the <code>@script</code> parameter) is commented out; <code>Sys.sleep(30)</code>. We&rsquo;ll use it at one stage to be able to look a little bit closer at what is happening.</li>
<li>As we did in 

<a href="/post/2017-04-23-microsoft-sql-server-r-services---internals-iv/">Internals - IV</a> we grab the process id of the RTerm process the code executes under.</li>
<li>In the <code>OutputDataSet</code> variable we output a data-frame consisting of the process id, how many rows we processed and the intercept value.</li>
<li>The output data is being presented as a result set, by the <code>WITH RESULT SETS ...</code> statement.</li>
<li>Oh, and for &ldquo;giggles&rdquo; we check how long the execution takes (first line and last line).</li>
</ul>
<p>In addition to the code above, we&rsquo;ll also use 

<a href="https://technet.microsoft.com/en-us/sysinternals/processexplorer.aspx" target="_blank" rel="noopener"><strong>Process Explorer</strong></a>, to see how many processes are created as well as memory consumption etc. If you have read 

<a href="/post/2017-04-13-microsoft-sql-server-r-services---internals-iii/">Internals - III</a> and 

<a href="/post/2017-04-23-microsoft-sql-server-r-services---internals-iv/">Internals - IV</a>, you should be comfortable with <em>Process Explorer</em>.</p>
<h2 id="parallel-execution">Parallel Execution</h2>
<p>So the blog-post is about what impact parallel processing will have on the process creation, but before we go down that &ldquo;rabbit&rdquo; hole, let&rsquo;s see what it looks like during non-parallel execution:</p>
<ul>
<li>Restart the launchpad service (this is to clean-up any RTerm processes).</li>
<li>Navigate to the <code>Launchpad.exe</code> process in <em>Process Explorer</em>.</li>
<li>Execute the code in <em>Code Snippet 2</em>.</li>
<li>While the code is executing, look in <em>Process Explorer</em> for RTerm processes.</li>
</ul>
<p>In <em>Process Explorer</em> you should see something similar to this:</p>
<p>!{}(/images/posts/sql_r_services_lin_reg1.png)</p>
<p><strong>Figure 1:</strong> <em>Processes from Code Execution</em></p>
<p>What you see in <em>Figure 1</em> matches pretty good with what we discussed in 

<a href="/post/2017-04-13-microsoft-sql-server-r-services---internals-iii/">Internals - III</a> and 

<a href="/post/2017-04-23-microsoft-sql-server-r-services---internals-iv/">Internals - IV</a>; while a single user executes <code>sp_execute_external_script</code> 6 RTerm processes are alive, and one of the processes is the process where the script executes under. In this case it was process id 10120, and we determined that from the CPU value (.32) as well as Private Bytes: 1,023,376 K and Working Set 189,268 K respectively.  We can further confirm the process the code executed under by looking at the result coming back:</p>
<p>
  <img src="/images/posts/sql_r_services_lin_reg1_result.png" alt="">

</p>
<p><strong>Figure 2:</strong> <em>Result from Code Execution</em></p>
<p>From <em>Figure 2</em> we can indeed see that the process id was 10120, and that we ran the regression model over 30 million rows. The time it took to execute the code was ~16 seconds. The query plan looks like in <em>Figure 3</em>:</p>
<p>
  <img src="/images/posts/sql_r_services_lin_reg1_result_udx.png" alt="">

</p>
<p><strong>Figure 3:</strong> <em>Actual Query Plan</em></p>
<p>In <em>Figure 3</em> we see how we do clustered index scan for our rows and then hand it over to the UDX operator. The UDX operator comes normally in play when we do XML related processes, but - as we can see - it also comes into the picture for external scripts. It kind of makes sense as it is an <strong>Extended Operator</strong>.</p>
<p>This is all well and good, but it is not really anything new from what we discussed in 

<a href="/post/2017-04-13-microsoft-sql-server-r-services---internals-iii/">Internals - III</a> and 

<a href="/post/2017-04-23-microsoft-sql-server-r-services---internals-iv/">IV</a>.</p>
<p>So what about parallel execution? When you read documentation about <strong>SQL Server R Services</strong> it always mentions how efficient it is to execute external scripts as one can utilize SQL&rsquo;s parallelism. How does this work then? In &ldquo;normal&rdquo; SQL Server parallelism, SQL Server decides whether to execute a statement in parallel or not, and the <code>MAXDOP</code> setting defines the number of processors the statement will execute on.</p>
<p>For <strong>SQL Server R Services</strong> it works in a similar way, except that you have to explicitly say that you want to execute in parallel. To specify parallel execution you use a parameter on the <code>sp_execute_external_script</code> procedure: <code>@parallel</code>. The parameter can either be either 0, no parallelism which is default, or 1.</p>
<blockquote>
<p><strong>NOTE:</strong> Even if you specify that you want to execute in parallel, SQL may choose not to do it.</p>
</blockquote>
<p>So in order to enable parallelism, we need to add the parameter to the stored procedure, and in <em>Code Snippet 4</em> below we have inserted the parameter right after <code>@input_data1</code> parameter:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#93a1a1;font-style:italic">-- preceding code not shown
</span></span></span><span style="display:flex;"><span><span style="color:#93a1a1;font-style:italic"></span>, @<span style="color:#268bd2">input_data_1</span> = <span style="color:#268bd2">N</span><span style="color:#2aa198">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">              SELECT  y, rand1, rand2, rand3, 
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">                      rand4, rand5 
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">              FROM dbo.rand_30M&#39;</span>
</span></span><span style="display:flex;"><span>, @<span style="color:#268bd2">parallel</span>=<span style="color:#2aa198;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span><span style="color:#859900">WITH</span> <span style="color:#859900">RESULT</span> <span style="color:#859900">SETS</span> ((<span style="color:#268bd2">pid</span> <span style="color:#cb4b16">INT</span> <span style="color:#859900">NOT</span> <span style="color:#859900">NULL</span>, <span style="color:#268bd2">nRows</span> <span style="color:#cb4b16">INT</span> <span style="color:#859900">NOT</span> <span style="color:#859900">NULL</span>, <span style="color:#268bd2">intercept</span> <span style="color:#cb4b16">FLOAT</span> <span style="color:#859900">NULL</span>)
</span></span><span style="display:flex;"><span>); 
</span></span><span style="display:flex;"><span><span style="color:#859900">SELECT</span> <span style="color:#268bd2">DATEDIFF</span>(<span style="color:#268bd2">ms</span>, @<span style="color:#859900">start</span>, <span style="color:#268bd2">SYSUTCDATETIME</span>()) <span style="color:#859900">AS</span> <span style="color:#268bd2">ElapsedTime</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 4:</strong> <em>Using the @parallel Parameter</em></p>
<p>So let&rsquo;s see what impact the change we did in <em>Code Snippet 4</em> has. For now we will not look at the RTerm processes, so you can just execute the code with the <code>@parallel = 1</code> parameter set. On my machine which is a 4 core machine with hyper threading (i.e. 8 processors) and <code>MAXDOP</code> is set to 0 (use all processors), I get the following result when I execute:</p>
<p>
  <img src="/images/posts/sql_r_services_lin_reg2_result.png" alt="">

</p>
<p><strong>Figure 4:</strong> <em>Result from Parallel Execution</em></p>
<p>In <em>Figure 4</em> we see how the results are returned from 8 RTerm process id&rsquo;s. This is to be expected when SQL uses parallelism and <code>MAXDOP</code> is 0. Oh, and BTW - according to people &ldquo;in the know&rdquo; you should not have <code>MAXDOP</code> set to 0 if you run on an HT box. 

<a href="https://www.mssqltips.com/sqlservertip/2650/what-maxdop-setting-should-be-used-for-sql-server/" target="_blank" rel="noopener">Here</a> is an article about <code>MAXDOP</code> settings.</p>
<p>We also see from <em>Figure 4</em> that we executed in ~8.7 seconds, roughly half the time it took when we didn&rsquo;t use parallelism.</p>
<blockquote>
<p><strong>NOTE:</strong> There is no guarantee that you will improve performance by using parallelism, so it is a good idea to always test against the workloads you are using.</p>
</blockquote>
<p>The query plan from the execution also shows parallelism:</p>
<p>
  <img src="/images/posts/sql_r_services_lin_reg2_qp.png" alt="">

</p>
<p><strong>Figure 5:</strong> <em>Query Plan With Parallelism</em></p>
<p>The interesting part with the query plan, as Bob pointed out to me, is that the UDX operator gets pushed <strong>before</strong> the <em>Parallelism</em> operator.</p>
<p>Let us now get back to what we started this with; how parallelism affects process creation. From what we have seen above, we can be fairly certain that 8 processes have been created, but let&rsquo;s make sure that it really happens:</p>
<ul>
<li>Un-comment the line in the R script saying <code>Sys.sleep(30)</code>. We&rsquo;ll use this pause to be able to closer see what happens.</li>
<li>Restart the launchpad service.</li>
<li>Navigate to the <code>Launchpad.exe</code> process in <em>Process Explorer</em>.</li>
<li>Execute the code.</li>
<li>While the code executes look closely at the RTerm processes under the launchpad process in <em>Process Explorer</em>.</li>
</ul>
<p>On my box the RTerm processes looks like so:</p>
<p>
  <img src="/images/posts/sql_r_services_lin_reg2_processes.png" alt="">

</p>
<p><strong>Figure 6:</strong> RTerm Processes and Parallelism*</p>
<p>From <em>Figure 6</em> we can see how there are 8 executing processes (the outlined rows), and 16 processes altogether. So when executing in parallel, the launchpad service creates two processes for each task, where one of the two processes are used for execution of the R code, and the other is being added to the process pool. The processes that are being used to executed on, are torn down after execution - and left are the ones in the process pool.</p>
<p>However if the level of parallelism (tasks) are less than the number of processes to be created, (5 by default or the value of <code>PROCESS_POOL_SQLSATELLITE_GROWTH</code>), then the launchpad service creates as many process as required so that there always is the required number of processes in the pool.</p>
<p>An example of this is if <code>PROCESS_POOL_SQLSATELLITE_GROWTH</code> has not been set, and we are working with 5 as default; if the level of parallelism is 4, then 9 processes will be created - 4 for execution, and 5 for the pool.</p>
<p>So why would the level of parallelism be less than the required number of processes? Well, we may execute on a box with few processors, maybe not so likely, or <code>MAXDOP</code> is set (see below).</p>
<h3 id="cran-r-functions">CRAN R Functions</h3>
<p>So far we have used RevoScaleR functions in our script code, what happens if we want to use a CRAN R function instead. Something similar to what is in <em>Code Snippet 2</em>? That works fine as well, multiple RTerm processes will process the data. I will not show the code here, but you can easily try it our yourselves.</p>
<h2 id="max-degree-of-parallelism-maxdop">Max Degree of Parallelism (MAXDOP)</h2>
<p>So <code>MAXDOP</code> is a way to indicate to SQL Server how many processors to execute a piece of code on. Or rather, it is a way to limit SQL Server from running a statement over all processors on the box. As this post is not about <code>MAXDOP</code> as such, I won&rsquo;t go into details about it, but if you want to know more 

<a href="https://blogs.msdn.microsoft.com/arali/2009/11/25/sql-server-max-degree-of-parallelism-maxdop/" target="_blank" rel="noopener">here is an MSDN article</a> covering <code>MAXDOP</code>. Anyway, <code>MAXDOP</code> is set on SQL Server instance level, but can also be used as query hint on individual queries.</p>
<p>Setting <code>MAXDOP</code> for individual statements also work for the statement used in the <code>@input_data_1</code> parameter on the <code>sp_execute_external_script</code> procedure. So in our code example was can change the <code>@input_data_1</code> parameter to look like so:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>, @<span style="color:#268bd2">input_data_1</span> = <span style="color:#268bd2">N</span><span style="color:#2aa198">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">              SELECT  y, rand1, rand2, rand3, 
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">                      rand4, rand5 
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">              FROM dbo.rand_30M OPTION(MAXDOP 4)&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 5:</strong> <em>Using MAXDOP in SELECT</em></p>
<p>The code in <em>Code Snippet 5</em> will now restrict the parallelism to use 4 processors, and results coming back will show 4 different process id&rsquo;s, and - as I mentioned above - during execution there will be 9 RTerm processes created, and when the execution has finished 5 will be in the process pool.</p>
<h2 id="some-unclear-points">Some Unclear Points</h2>
<p>All this seems pretty straight forward, however what is unclear for me is how the interaction between SQL Server and the launchpad service works when executing with parallelism. On the SQL Server side we can see how multiple tasks and workers are invoked when parallelism is in play by executing something like so:</p>
<div class="highlight"><div style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#859900">DECLARE</span> @<span style="color:#268bd2">spid</span> <span style="color:#cb4b16">int</span> = &lt;<span style="color:#268bd2">spid_from_script_execute</span>&gt;
</span></span><span style="display:flex;"><span><span style="color:#859900">SELECT</span> <span style="color:#268bd2">t</span>.<span style="color:#268bd2">session_id</span>, <span style="color:#268bd2">t</span>.<span style="color:#268bd2">scheduler_id</span>, <span style="color:#268bd2">t</span>.<span style="color:#268bd2">task_address</span>, <span style="color:#268bd2">t</span>.<span style="color:#268bd2">worker_address</span> 
</span></span><span style="display:flex;"><span><span style="color:#859900">FROM</span> <span style="color:#268bd2">sys</span>.<span style="color:#268bd2">dm_os_tasks</span> <span style="color:#268bd2">t</span>
</span></span><span style="display:flex;"><span><span style="color:#859900">WHERE</span> <span style="color:#268bd2">t</span>.<span style="color:#268bd2">session_id</span> = @<span style="color:#268bd2">spid</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Code Snippet 6:</strong> <em>Viewing Tasks and Workers When Executing</em></p>
<p>To see this:</p>
<ol>
<li>Open a second query window and copy the code from <em>Code Snippet 6</em> into that window.</li>
<li>Replace the <code>&lt;spid_from_script_execute&gt;</code> with the session id (<code>@@SPID</code>) from where you execute <code>sp_execute_external_script</code>.</li>
<li>Highlight the <em>Code Snippet 6</em> code in the query window.</li>
<li>Execute the <code>sp_execute_external_script</code> code, where <code>@parallel</code> is set to 1.</li>
<li>Quickly change over to the other query window and execute the code.</li>
</ol>
<p>The result from the query window where you execute the code from <em>Code Snippet 6</em> looks something like what you see in <em>Figure 7</em>:</p>
<p>
  <img src="/images/posts/sql_r_services_lin_reg2_tasks.png" alt="">

</p>
<p><strong>Figure 7:</strong> Tasks, Workers and Schedulers*</p>
<p>Ok, we see multiple schedulers, tasks and workers being active when we execute our code, and there is nothing strange in that. Seeing that, I would then have expected that there would be a one-to-one relationship between the tasks and the calls into the launchpad service, but that is not the case.</p>
<p>I verified that by &ldquo;firing up&rdquo; my trusted debugger <strong>WinDbg</strong> and attached it to the launchpad process, similar to what we did in 

<a href="/post/2017-04-02-microsoft-sql-server-r-services---internals-ii/">Internals - II</a>. I then set a breakpoint at <code>launchpad!CLaunchContext::LaunchServTask</code>, and executed the code. My expectation was that I would see how the breakpoint was hit multiple times when I executed with parallelism.</p>
<p>That did not happen, the breakpoint was hit once, and that was it. That leaves me with the question how SQL Server interacts with the launchpad service when executing with parallelism. My guess is that when SQL Server calls into the launchpad service, (which we discussed at length in 

<a href="/post/2017-03-18-microsoft-sql-server-r-services---internals-i/">Internals - I</a> and 

<a href="/post/2017-04-02-microsoft-sql-server-r-services---internals-ii/">II</a>), it tells the launchpad service that this call requires parallelism, and the level of it. But as I said, this is just a guess. Maybe someone out there can clarify what goes on.</p>
<h2 id="summary">Summary</h2>
<p>In this post I wanted to look at how parallelism affects the creation of RTerm processes in <strong>SQL Server R Services</strong>. The conclusion is that it does:</p>
<ul>
<li>When executing with no parallelism, the launchpad service creates 6 processes by default (can be altered by <code>PROCESS_POOL_SQLSATELLITE_GROWTH</code>), and the code runs on one, the others are added to the process pool. When the code has finished executing, the executing process is torn down.</li>
<li>When executing under parallelism the launchpad service creates two processes per degree of parallelism. One of the two processes are used to execute on, the other is added to the pool.
<ul>
<li>If the level of parallelism is lower than default number of process to be created (or <code>PROCESS_POOL_SQLSATELLITE_GROWTH</code>) then the launchpad service creates enough processes to satisfy the required level.</li>
</ul>
</li>
<li>Parallelism works with CRAN R functions as well as RevoScaleR.</li>
<li>The <code>MAXDOP</code> setting has impact on the parallelism.</li>
</ul>
<p>So that&rsquo;s for now! Thanks once again to 

<a href="https://twitter.com/bob_albright" target="_blank" rel="noopener">Bob</a> for his input and code!! And as I mentioned above, if anyone has input how SQL Server interacts with the launchpad service, when parallelism is in play - I&rsquo;d be more than happy to hear about it.</p>
<p>If you have comments, questions etc., please comment on this post or 

<a href="mailto:niels.it.berglund@gmail.com">ping</a> me.</p>

                

                
                <hr>
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/post/2017-04-30-interesting-stuff---week-17/" data-toggle="tooltip" data-placement="top" title="Interesting Stuff - Week 17">&larr;
                            Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/post/2017-05-07-interesting-stuff---week-18/" data-toggle="tooltip" data-placement="top" title="Interesting Stuff - Week 18">Next
                            Post &rarr;</a>
                    </li>
                    
                </ul>
                

                


<div id="disqus-comment"></div>
<div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "manageddata" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


            </div>

            
            
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
            

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                
                

                
                
            </div>
        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">                  
                    
                    <li>
                        <a href="mailto:niels.it.berglund@gmail.com">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		           
                    
                    <li>
                        <a href="https://twitter.com/nielsberglund">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    

		            
                    
                    
                    <li>
                        <a target="_blank" href="https://github.com/nielsberglund">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		            
                    
                    
                    
                    <li>
                        <a target="_blank" href="https://www.linkedin.com/in/niels-berglund-0122593">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		           
                    
                    <li>
                        <a target="_blank" href="https://medium.com/@nielsberglund">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-medium fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a target="_blank" href="https://stackoverflow.com/users/7656880/niels-berglund">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-stack-overflow fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    
                    <li>
                        <a target="_blank" href="https://fosstodon.org/@nielsb">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-mastodon fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
            
            
            
           
           <li>
             <a target="_blank" href="https://nielsberglund.com/index.xml">
                <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
                </span>
             </a>
           </li>
           
             </ul>
		<p class="copyright text-muted">
                    Copyright &copy; Niels Berglund 2024
                    <br>
                    <a href="https://themes.gohugo.io/hugo-theme-cleanwhite">CleanWhite Hugo Theme</a> by <a href="https://zhaohuabing.com">Huabing</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>




<script>
    function loadAsync(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        loadAsync("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>






<script type="text/javascript">
    function generateCatalog(selector) {

        
        
        
        
            _containerSelector = 'div.post-container'
        

        
        var P = $(_containerSelector), a, n, t, l, i, c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        
        $(selector).html('')

        
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#" + $(this).prop('id');
            t = $(this).text();
            c = $('<a href="' + i + '" rel="nofollow">' + t + '</a>');
            l = $('<li class="' + n + '_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    
    $(".catalog-toggle").click((function (e) {
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    


    loadAsync("\/js\/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>






</body>
</html>
